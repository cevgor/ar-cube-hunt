<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z.E.R.O.: Last Breach</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #0a0a0a;
            overflow: hidden;
            color: #00ffea;
            touch-action: none;
        }

        #app {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
        #menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: 
                linear-gradient(135deg, rgba(10, 10, 20, 0.9), rgba(5, 5, 15, 0.9)),
                url('zero_background.jpg') center/cover no-repeat;
            color: #00ffea;
            text-align: center;
        }

        .menu-overlay {
            background: rgba(0, 0, 0, 0.85);
            padding: 40px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 2px solid #00ffea;
            box-shadow: 0 0 40px rgba(0, 255, 234, 0.3);
        }

        .menu-title {
            font-size: 3.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px #00ffea;
            background: linear-gradient(45deg, #00ffea, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
            letter-spacing: 3px;
        }

        .menu-subtitle {
            font-size: 1.3em;
            margin-bottom: 40px;
            color: #88ffff;
            text-shadow: 0 0 10px rgba(0, 255, 234, 0.5);
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 320px;
        }

        .menu-button {
            padding: 18px 30px;
            font-size: 1.3em;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            color: #00ffea;
            border: 2px solid #00ffea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 5px #00ffea;
            box-shadow: 0 0 20px rgba(0, 255, 234, 0.3);
            font-weight: bold;
        }

        .menu-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 30px rgba(0, 255, 234, 0.5);
            background: linear-gradient(45deg, #252545, #1a2a4a);
        }

        .menu-button:active {
            transform: translateY(1px);
        }

        .menu-button.secondary {
            background: linear-gradient(45deg, #2a1a2e, #261225);
            border-color: #ff00aa;
            color: #ff00aa;
            text-shadow: 0 0 5px #ff00aa;
            box-shadow: 0 0 20px rgba(255, 0, 170, 0.3);
        }

        .menu-button.secondary:hover {
            background: linear-gradient(45deg, #3a1a3e, #361235);
            box-shadow: 0 0 30px rgba(255, 0, 170, 0.5);
        }

        .menu-button.disabled {
            background: linear-gradient(45deg, #1a1a1a, #252525);
            border-color: #666;
            color: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .menu-button.disabled:hover {
            transform: none;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #0a0a15, #151525);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00ffea;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 255, 234, 0.4);
            position: relative;
        }

        .modal-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #00ffea;
            text-shadow: 0 0 10px #00ffea;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        .close-button:hover {
            background: #ff5555;
            transform: scale(1.1);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 255, 234, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 234, 0.3);
        }

        .slider {
            width: 150px;
            height: 8px;
            background: #1a1a2e;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #00ffea;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px #00ffea;
        }

        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #gameUI {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .stats-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 10px;
            color: #00ffea;
            backdrop-filter: blur(10px);
            border: 2px solid #00ffea;
            box-shadow: 0 0 20px rgba(0, 255, 234, 0.3);
        }

        .health-panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 10px;
            color: #00ffea;
            width: 220px;
            backdrop-filter: blur(10px);
            border: 2px solid #00ffea;
            box-shadow: 0 0 20px rgba(0, 255, 234, 0.3);
        }

        .bar-container {
            background: #1a1a2e;
            border-radius: 8px;
            overflow: hidden;
            margin: 8px 0;
            border: 1px solid #333;
        }

        .health-bar {
            background: linear-gradient(90deg, #ff4444, #ff0000);
            height: 20px;
            width: 100%;
            transition: width 0.3s;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        .exp-bar {
            background: linear-gradient(90deg, #00ffea, #0099ff);
            height: 12px;
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 10px rgba(0, 255, 234, 0.5);
        }

        /* –î–∂–æ–π—Å—Ç–∏–∫ */
        #joystickContainer {
            position: absolute;
            bottom: 120px;
            left: 80px;
            pointer-events: auto;
            display: none;
        }

        #joystickBase {
            width: 120px;
            height: 120px;
            background: rgba(0, 255, 234, 0.2);
            border-radius: 50%;
            position: relative;
            border: 3px solid rgba(0, 255, 234, 0.6);
            box-shadow: 0 0 20px rgba(0, 255, 234, 0.3);
        }

        #joystickHandle {
            width: 60px;
            height: 60px;
            background: rgba(0, 255, 234, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 15px rgba(0, 255, 234, 0.5);
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è */
        .action-button {
            position: absolute;
            border: none;
            border-radius: 50%;
            color: white;
            pointer-events: auto;
            font-size: 1.5em;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 3px solid;
        }

        .action-button:active {
            transform: scale(0.9);
        }

        #shootBtn {
            bottom: 120px;
            right: 80px;
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #ff4444, #cc0000);
            border-color: #ff6666;
            box-shadow: 0 0 25px rgba(255, 68, 68, 0.5);
        }

        #skillBtn {
            bottom: 210px;
            right: 80px;
            width: 65px;
            height: 65px;
            background: linear-gradient(45deg, #00aaff, #0066cc);
            border-color: #66aaff;
            font-size: 1.3em;
            box-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
        }

        #weaponDisplay {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 25px;
            border-radius: 25px;
            color: #00ffea;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            border: 2px solid #00ffea;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(0, 255, 234, 0.3);
            display: none;
        }

        /* –ü—Ä–∏—Ü–µ–ª */
        #crosshair {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            pointer-events: none;
            z-index: 20;
        }

        .crosshair-vertical {
            position: absolute;
            width: 3px;
            height: 24px;
            background: #00ffea;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 8px #00ffea;
        }

        .crosshair-horizontal {
            position: absolute;
            width: 24px;
            height: 3px;
            background: #00ffea;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 0 8px #00ffea;
        }

        /* –ú–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏–π */
        #upgradeMenu {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.97);
            color: #00ffea;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .upgrade-option {
            background: linear-gradient(135deg, rgba(0, 255, 234, 0.15), rgba(0, 153, 255, 0.1));
            padding: 25px;
            margin: 15px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            min-width: 300px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(0, 255, 234, 0.4);
            box-shadow: 0 0 20px rgba(0, 255, 234, 0.2);
        }

        .upgrade-option:hover {
            background: linear-gradient(135deg, rgba(0, 255, 234, 0.25), rgba(0, 153, 255, 0.2));
            transform: scale(1.05);
            border-color: #00ffea;
            box-shadow: 0 0 30px rgba(0, 255, 234, 0.4);
        }

        .upgrade-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00ffea;
            text-shadow: 0 0 5px #00ffea;
        }

        .upgrade-desc {
            font-size: 1em;
            opacity: 0.9;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã */
        #results {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.97);
            color: #00ffea;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .results-content {
            background: linear-gradient(135deg, #0a0a15, #151525);
            padding: 40px;
            border-radius: 15px;
            border: 2px solid #00ffea;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 255, 234, 0.4);
        }

        .results-stats {
            font-size: 1.3em;
            margin: 25px 0;
            text-align: center;
        }

        .results-stats div {
            margin: 12px 0;
            padding: 10px;
            background: rgba(0, 255, 234, 0.15);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 234, 0.3);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã */
        #gameContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #ff4444;
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        .menu-button .status-badge {
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="menu">
            <div class="menu-overlay">
                <h1 class="menu-title">Z.E.R.O.</h1>
                <p class="menu-subtitle">LAST BREACH</p>
                <div class="menu-buttons">
                    <button class="menu-button" onclick="startGame()">üéÆ –ù–ê–ß–ê–¢–¨ –ú–ò–°–°–ò–Æ</button>
                    <button class="menu-button" onclick="showMultiplayerModal()">üåê –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–† <span class="status-badge">–°–ö–û–†–û</span></button>
                    <button class="menu-button" onclick="showSettingsModal()">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò</button>
                    <button class="menu-button secondary" onclick="showInstructions()">üìñ –û–ë–£–ß–ï–ù–ò–ï</button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <button class="close-button" onclick="closeSettingsModal()">√ó</button>
                <h2 class="modal-title">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò</h2>
                
                <div class="setting-item">
                    <span>üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å –∑–≤—É–∫–æ–≤</span>
                    <input type="range" class="slider" id="soundVolume" min="0" max="100" value="80">
                </div>
                
                <div class="setting-item">
                    <span>üéµ –ì—Ä–æ–º–∫–æ—Å—Ç—å –º—É–∑—ã–∫–∏</span>
                    <input type="range" class="slider" id="musicVolume" min="0" max="100" value="60">
                </div>
                
                <div class="setting-item">
                    <span>üéÆ –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
                    <input type="range" class="slider" id="sensitivity" min="1" max="10" value="5">
                </div>
                
                <div class="setting-item">
                    <span>‚ö° –ö–∞—á–µ—Å—Ç–≤–æ –≥—Ä–∞—Ñ–∏–∫–∏</span>
                    <input type="range" class="slider" id="graphicsQuality" min="1" max="3" value="2">
                </div>
                
                <button class="menu-button" style="margin-top: 20px; width: 100%;" onclick="applySettings()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞ -->
        <div id="multiplayerModal" class="modal">
            <div class="modal-content">
                <button class="close-button" onclick="closeMultiplayerModal()">√ó</button>
                <h2 class="modal-title">üåê –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†</h2>
                <p style="margin: 20px 0; font-size: 1.2em; color: #ff4444;">
                    ‚ùå –†–µ–∂–∏–º –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ<br>
                    <span style="color: #cccccc; font-size: 0.9em;">–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!</span>
                </p>
                <div style="margin: 25px 0; padding: 20px; background: rgba(255, 68, 68, 0.15); border-radius: 10px; border: 1px solid #ff4444;">
                    <h3 style="color: #ffaa00; margin-bottom: 10px;">üöß –°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ:</h3>
                    <ul style="text-align: left; color: #cccccc; line-height: 1.6; padding-left: 20px;">
                        <li>‚öîÔ∏è –ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤ –¥–æ 4 –∏–≥—Ä–æ–∫–æ–≤</li>
                        <li>üèÜ –ö–æ–º–∞–Ω–¥–Ω—ã–µ —Ä–µ–π—Ç–∏–Ω–≥–∏</li>
                        <li>üéØ PvP —Ä–µ–∂–∏–º—ã</li>
                        <li>üîó –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π</li>
                    </ul>
                </div>
                <button class="menu-button" style="width: 100%;" onclick="closeMultiplayerModal()">–ü–û–ù–Ø–¢–ù–û</button>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div id="gameUI">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats-panel">
                <div>‚≠ê –û—á–∫–∏: <span id="scoreValue">0</span></div>
                <div>üéØ –£—Ä–æ–≤–µ–Ω—å: <span id="levelValue">1</span></div>
                <div>üåä –í–æ–ª–Ω–∞: <span id="waveValue">1</span></div>
                <div>üéØ –£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ: <span id="enemiesValue">0</span></div>
            </div>
            
            <!-- –ó–¥–æ—Ä–æ–≤—å–µ –∏ –æ–ø—ã—Ç -->
            <div class="health-panel">
                <div style="margin-bottom: 5px;">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</div>
                <div class="bar-container">
                    <div id="healthFill" class="health-bar"></div>
                </div>
                <div style="margin-top: 10px;">‚ö° –û–ø—ã—Ç</div>
                <div class="bar-container">
                    <div id="expFill" class="exp-bar"></div>
                </div>
            </div>
            
            <!-- –î–∂–æ–π—Å—Ç–∏–∫ -->
            <div id="joystickContainer">
                <div id="joystickBase"></div>
                <div id="joystickHandle"></div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è -->
            <button id="shootBtn" class="action-button">üî´</button>
            <button id="skillBtn" class="action-button">‚ùÑÔ∏è</button>
            
            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ä—É–∂–∏—è -->
            <div id="weaponDisplay">üî´ –¢–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–∏—Å—Ç–æ–ª–µ—Ç</div>
        </div>

        <!-- –ü—Ä–∏—Ü–µ–ª -->
        <div id="crosshair">
            <div class="crosshair-vertical"></div>
            <div class="crosshair-horizontal"></div>
        </div>

        <!-- –ú–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏–π -->
        <div id="upgradeMenu">
            <div class="modal-content">
                <h2 class="modal-title">üéØ –í–´–ë–ï–†–ò–¢–ï –£–õ–£–ß–®–ï–ù–ò–ï</h2>
                <div id="upgradeOptions"></div>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã -->
        <div id="results">
            <div class="results-content">
                <h2 class="modal-title">üéÆ –ú–ò–°–°–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê</h2>
                <div class="results-stats">
                    <div>‚≠ê –û—á–∫–∏: <span id="finalScore">0</span></div>
                    <div>üéØ –£—Ä–æ–≤–µ–Ω—å: <span id="finalLevel">1</span></div>
                    <div>üéØ –£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ: <span id="enemiesKilled">0</span></div>
                    <div>üåä –í–æ–ª–Ω –ø—Ä–æ–π–¥–µ–Ω–æ: <span id="wavesCompleted">1</span></div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 25px;">
                    <button class="menu-button" onclick="restartGame()">üîÑ –ù–û–í–ê–Ø –ú–ò–°–°–ò–Æ</button>
                    <button class="menu-button secondary" onclick="showMenu()">üìã –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ</button>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Three.js -->
        <div id="gameContainer"></div>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            console.log("‚úÖ Telegram WebApp initialized");
        }

        // –û—Å–Ω–æ–≤–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let scene, camera, renderer;
        let enemies = [], crystals = [], particles = [];
        let score = 0;
        let playerHealth = 100;
        let playerMaxHealth = 100;
        let playerLevel = 1;
        let playerExp = 0;
        let expToNextLevel = 100;
        let currentWave = 1;
        let enemiesInWave = 2;
        let enemiesAlive = 0;
        let gameTime = 0;
        let gameTimer;
        let isGameRunning = false;
        let isPaused = false;
        let animationFrameId = null;
        let totalEnemiesKilled = 0;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã
        let gameSettings = {
            soundVolume: 80,
            musicVolume: 60,
            sensitivity: 5,
            graphicsQuality: 2
        };

        // –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        let playerPosition = new THREE.Vector3(0, 1.6, 0);
        let playerVelocity = new THREE.Vector3();
        let joystickActive = false;
        let joystickDirection = new THREE.Vector2(0, 0);
        let cameraRotation = { x: 0, y: 0 };
        let cameraSensitivity = 0.035;
        let isDragging = false;
        let previousMouseX = 0;
        let previousMouseY = 0;
        let cameraTouchId = null;

        // –°–∏—Å—Ç–µ–º–∞ –æ—Ä—É–∂–∏—è
        const weapons = {
            pistol: { damage: 20, fireRate: 2, name: "üî´ –¢–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–∏—Å—Ç–æ–ª–µ—Ç", color: 0x00ffea },
            shotgun: { damage: 40, fireRate: 0.8, name: "üî´ –®—Ç—É—Ä–º–æ–≤–æ–π –¥—Ä–æ–±–æ–≤–∏–∫", color: 0xff4444 },
            rifle: { damage: 15, fireRate: 4, name: "üî´ –®—Ç—É—Ä–º–æ–≤–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞", color: 0x0099ff }
        };
        let currentWeapon = 'pistol';
        let weaponUnlocks = { pistol: true, shotgun: false, rifle: false };

        // –¢–∏–ø—ã –≤—Ä–∞–≥–æ–≤
        const enemyTypes = {
            normal: { health: 2, speed: 0.008, color: 0x666666, score: 100 },
            fast: { health: 1, speed: 0.015, color: 0x4444ff, score: 150 },
            tank: { health: 5, speed: 0.005, color: 0xff4444, score: 200 }
        };

        // –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
        const upgrades = [
            {
                name: "üí• –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —É—Ä–æ–Ω–∞",
                description: "+25% –∫ —É—Ä–æ–Ω—É –æ—Ç –ø—É–ª—å",
                apply: () => { playerStats.damage *= 1.25; }
            },
            {
                name: "‚ö° –°–∫–æ—Ä–æ—Å—Ç—å —Å—Ç—Ä–µ–ª—å–±—ã",
                description: "+20% –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å—Ç—Ä–µ–ª—å–±—ã",
                apply: () => { playerStats.fireRate *= 1.2; }
            },
            {
                name: "üèÉ‚Äç‚ôÇÔ∏è –°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è",
                description: "+15% –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–≤–∏–∂–µ–Ω–∏—è",
                apply: () => { playerStats.moveSpeed *= 1.15; }
            },
            {
                name: "‚ù§Ô∏è –ú–∞–∫—Å. –∑–¥–æ—Ä–æ–≤—å–µ",
                description: "+25 –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –∑–¥–æ—Ä–æ–≤—å—é",
                apply: () => { 
                    playerMaxHealth += 25;
                    playerHealth = playerMaxHealth;
                    updateHealthBar();
                }
            },
            {
                name: "üîÆ –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è",
                description: "+2 –∑–¥–æ—Ä–æ–≤—å—è –≤ —Å–µ–∫—É–Ω–¥—É",
                apply: () => { playerStats.healthRegen += 2; }
            },
            {
                name: "üéØ –ö—Ä–∏—Ç. —É–¥–∞—Ä",
                description: "+10% –∫ —à–∞–Ω—Å—É –∫—Ä–∏—Ç–∞",
                apply: () => { playerStats.critChance += 0.1; }
            }
        ];

        // –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞
        let playerStats = {
            damage: 20,
            fireRate: 2,
            moveSpeed: 0.08,
            healthRegen: 0,
            critChance: 0.05,
            critMultiplier: 2.0
        };

        // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ===

        function startGame() {
            console.log("üéÆ –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...");
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('menu').style.display = 'none';
            document.getElementById('gameUI').style.display = 'block';
            document.getElementById('crosshair').style.display = 'block';
            document.getElementById('joystickContainer').style.display = 'block';
            document.getElementById('shootBtn').style.display = 'flex';
            document.getElementById('skillBtn').style.display = 'flex';
            document.getElementById('weaponDisplay').style.display = 'block';
            
            // –°–±—Ä–æ—Å –∏–≥—Ä–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            resetGameState();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js
            initThreeJS();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            setupControls();
            
            // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
            isGameRunning = true;
            startGameTimer();
            animationFrameId = requestAnimationFrame(gameLoop);
            
            console.log("‚úÖ –ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞");
        }

        function resetGameState() {
            score = 0;
            playerHealth = 100;
            playerMaxHealth = 100;
            playerLevel = 1;
            playerExp = 0;
            expToNextLevel = 100;
            currentWave = 1;
            enemiesInWave = 2;
            enemiesAlive = 0;
            totalEnemiesKilled = 0;
            gameTime = 0;
            
            playerStats = {
                damage: 20,
                fireRate: 2,
                moveSpeed: 0.08,
                healthRegen: 0,
                critChance: 0.05,
                critMultiplier: 2.0
            };
            
            currentWeapon = 'pistol';
            weaponUnlocks = { pistol: true, shotgun: false, rifle: false };
            
            updateAllDisplays();
            
            // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—ã—Ö –≤—Ä–∞–≥–æ–≤
            for (let i = 0; i < enemiesInWave; i++) {
                setTimeout(() => createEnemy(), i * 1500);
            }
        }

        function initThreeJS() {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ü–µ–Ω—É
            const gameContainer = document.getElementById('gameContainer');
            gameContainer.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º —Å—Ü–µ–Ω—É
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a15);
            scene.fog = new THREE.Fog(0x0a0a15, 50, 150);
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞–º–µ—Ä—É
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.copy(playerPosition);
            
            // –°–æ–∑–¥–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–µ—Ä
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.BasicShadowMap;
            gameContainer.appendChild(renderer.domElement);

            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 50, 25);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 1024;
            directionalLight.shadow.mapSize.height = 1024;
            scene.add(directionalLight);

            // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ü–µ–Ω—É
            createTestScene();
            
            console.log("‚úÖ Three.js –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
        }

        function createTestScene() {
            // –ó–µ–º–ª—è
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x1a1a2e });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞
            const boxGeometry = new THREE.BoxGeometry(2, 2, 2);
            const boxMaterial = new THREE.MeshLambertMaterial({ color: 0x00ffea });
            
            for (let i = 0; i < 8; i++) {
                const box = new THREE.Mesh(boxGeometry, boxMaterial);
                box.position.set(
                    Math.random() * 60 - 30,
                    1,
                    Math.random() * 60 - 30
                );
                box.castShadow = true;
                scene.add(box);
            }
        }

        function createEnemy() {
            const angle = Math.random() * Math.PI * 2;
            const distance = 20 + Math.random() * 10;
            const position = new THREE.Vector3(
                Math.cos(angle) * distance,
                1,
                Math.sin(angle) * distance
            );
            
            let enemyType = 'normal';
            const rand = Math.random();
            if (currentWave >= 3 && rand < 0.3) enemyType = 'fast';
            if (currentWave >= 5 && rand < 0.2) enemyType = 'tank';
            
            const geometry = new THREE.SphereGeometry(0.8, 8, 8);
            const material = new THREE.MeshLambertMaterial({ 
                color: enemyTypes[enemyType].color 
            });
            const enemy = new THREE.Mesh(geometry, material);
            
            enemy.position.copy(position);
            enemy.userData = {
                health: enemyTypes[enemyType].health,
                speed: enemyTypes[enemyType].speed,
                damage: 10,
                lastAttack: 0,
                type: enemyType,
                score: enemyTypes[enemyType].score
            };
            
            enemy.castShadow = true;
            scene.add(enemy);
            enemies.push(enemy);
            enemiesAlive++;
            updateEnemiesCount();
        }

        function gameLoop(currentTime) {
            if (!isGameRunning) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–≤—É—é –ª–æ–≥–∏–∫—É
            updatePlayer();
            updateEnemies();
            updateRegeneration();
            manageWaves();
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ü–µ–Ω—É
            renderer.render(scene, camera);
            
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function updatePlayer() {
            if (!isGameRunning || isPaused) return;
            
            // –î–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∂–æ–π—Å—Ç–∏–∫–∞
            const moveVector = new THREE.Vector3(0, 0, 0);
            
            if (joystickActive) {
                moveVector.x = joystickDirection.x;
                moveVector.z = joystickDirection.y;
            }
            
            if (moveVector.length() > 0) {
                moveVector.normalize();
                moveVector.multiplyScalar(playerStats.moveSpeed);
                moveVector.applyEuler(new THREE.Euler(0, cameraRotation.y, 0));
                playerVelocity.copy(moveVector);
            } else {
                playerVelocity.set(0, 0, 0);
            }
            
            // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
            const newPosition = playerPosition.clone().add(playerVelocity);
            
            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü
            if (Math.abs(newPosition.x) < 45 && Math.abs(newPosition.z) < 45) {
                playerPosition.copy(newPosition);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã
            camera.position.copy(playerPosition);
            camera.rotation.set(cameraRotation.x, cameraRotation.y, 0, 'YXZ');
        }

        function updateEnemies() {
            enemies.forEach((enemy, index) => {
                if (enemy.userData.health <= 0) {
                    // –í—Ä–∞–≥ —É–Ω–∏—á—Ç–æ–∂–µ–Ω
                    scene.remove(enemy);
                    enemies.splice(index, 1);
                    enemiesAlive--;
                    score += enemy.userData.score;
                    totalEnemiesKilled++;
                    updateScore();
                    updateEnemiesCount();
                    return;
                }

                // –î–≤–∏–∂–µ–Ω–∏–µ –∫ –∏–≥—Ä–æ–∫—É
                const direction = new THREE.Vector3();
                direction.subVectors(playerPosition, enemy.position).normalize();
                direction.y = 0;
                enemy.position.add(direction.multiplyScalar(enemy.userData.speed));
                
                // –ü–æ–≤–æ—Ä–æ—Ç –∫ –∏–≥—Ä–æ–∫—É
                enemy.lookAt(playerPosition.x, enemy.position.y, playerPosition.z);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ç–∞–∫–∏ –∏–≥—Ä–æ–∫–∞
                const distance = enemy.position.distanceTo(playerPosition);
                if (distance < 2.0) {
                    if (Date.now() - enemy.userData.lastAttack > 1000) {
                        takeDamage(enemy.userData.damage);
                        enemy.userData.lastAttack = Date.now();
                    }
                }
            });
        }

        function updateRegeneration() {
            if (playerStats.healthRegen > 0 && playerHealth < playerMaxHealth) {
                playerHealth = Math.min(playerMaxHealth, playerHealth + playerStats.healthRegen * 0.016);
                updateHealthBar();
            }
        }

        function manageWaves() {
            if (enemiesAlive === 0 && !isPaused) {
                currentWave++;
                enemiesInWave = 2 + currentWave * 1;
                
                for (let i = 0; i < enemiesInWave; i++) {
                    setTimeout(() => createEnemy(), i * 1500);
                }
                
                updateWaveDisplay();
            }
        }

        function shoot() {
            if (!isGameRunning || isPaused) return;
            
            // –ü—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å—Ç—Ä–µ–ª—å–±—ã - –Ω–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏
            score += 10;
            updateScore();
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
            createMuzzleFlash();
            
            // –í–∏–±—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function createMuzzleFlash() {
            const flashLight = new THREE.PointLight(weapons[currentWeapon].color, 2, 15);
            const direction = new THREE.Vector3(0, 0, -1);
            direction.applyQuaternion(camera.quaternion);
            flashLight.position.copy(playerPosition).add(direction.multiplyScalar(1));
            scene.add(flashLight);
            
            setTimeout(() => {
                scene.remove(flashLight);
            }, 100);
        }

        function useSkill() {
            if (!isGameRunning || isPaused) return;
            
            // –ü—Ä–æ—Å—Ç–æ–π –Ω–∞–≤—ã–∫ - –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
            enemies.forEach(enemy => {
                const originalSpeed = enemy.userData.speed;
                enemy.userData.speed *= 0.3;
                
                // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
                enemy.material.color.set(0x88ccff);
                
                setTimeout(() => {
                    if (enemy.userData) {
                        enemy.userData.speed = originalSpeed;
                        enemy.material.color.set(enemyTypes[enemy.userData.type].color);
                    }
                }, 5000);
            });
        }

        function takeDamage(amount) {
            playerHealth -= amount;
            updateHealthBar();
            
            // –≠—Ñ—Ñ–µ–∫—Ç —Ç—Ä—è—Å–∫–∏ –∫–∞–º–µ—Ä—ã
            camera.position.x += (Math.random() - 0.5) * 0.3;
            camera.position.y += (Math.random() - 0.5) * 0.3;
            
            setTimeout(() => {
                camera.position.copy(playerPosition);
            }, 100);
            
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            if (playerHealth <= 0) {
                endGame();
            }
        }

        function endGame() {
            isGameRunning = false;
            isPaused = true;
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            if (gameTimer) {
                clearInterval(gameTimer);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ Telegram WebApp
            if (window.Telegram && Telegram.WebApp) {
                const gameData = {
                    score: score,
                    waves: currentWave - 1,
                    time: gameTime,
                    enemies: totalEnemiesKilled,
                    level: playerLevel
                };
                Telegram.WebApp.sendData(JSON.stringify(gameData));
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalLevel').textContent = playerLevel;
            document.getElementById('enemiesKilled').textContent = totalEnemiesKilled;
            document.getElementById('wavesCompleted').textContent = currentWave - 1;
            
            document.getElementById('gameUI').style.display = 'none';
            document.getElementById('results').style.display = 'flex';
        }

        // === –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ===

        function showSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            document.getElementById('soundVolume').value = gameSettings.soundVolume;
            document.getElementById('musicVolume').value = gameSettings.musicVolume;
            document.getElementById('sensitivity').value = gameSettings.sensitivity;
            document.getElementById('graphicsQuality').value = gameSettings.graphicsQuality;
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function showMultiplayerModal() {
            document.getElementById('multiplayerModal').style.display = 'flex';
        }

        function closeMultiplayerModal() {
            document.getElementById('multiplayerModal').style.display = 'none';
        }

        function applySettings() {
            gameSettings.soundVolume = parseInt(document.getElementById('soundVolume').value);
            gameSettings.musicVolume = parseInt(document.getElementById('musicVolume').value);
            gameSettings.sensitivity = parseInt(document.getElementById('sensitivity').value);
            gameSettings.graphicsQuality = parseInt(document.getElementById('graphicsQuality').value);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            cameraSensitivity = 0.01 + (gameSettings.sensitivity * 0.005);
            
            closeSettingsModal();
            alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
        }

        function showInstructions() {
            alert(`üéÆ Z.E.R.O.: LAST BREACH - –£–ü–†–ê–í–õ–ï–ù–ò–ï

‚Ä¢ –î–∂–æ–π—Å—Ç–∏–∫ —Å–ª–µ–≤–∞ - –¥–≤–∏–∂–µ–Ω–∏–µ
‚Ä¢ –ö–Ω–æ–ø–∫–∞ üî´ - —Å—Ç—Ä–µ–ª—å–±–∞  
‚Ä¢ –ö–Ω–æ–ø–∫–∞ ‚ùÑÔ∏è - –∫—Ä–∏–æ–≥–µ–Ω–Ω–∞—è —Å—Ç–∞–∑–∏—Å
‚Ä¢ –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞ - –ø–æ–≤–æ—Ä–æ—Ç –∫–∞–º–µ—Ä—ã
‚Ä¢ –î–≤–æ–π–Ω–æ–π —Ç–∞–ø - —Å–º–µ–Ω–∞ –æ—Ä—É–∂–∏—è

‚ö° –¢–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –°–û–í–ï–¢–´:
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–∫—Ä—ã—Ç–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏
‚Ä¢ –°–æ–±–∏—Ä–∞–π—Ç–µ —ç–Ω–µ—Ä–≥–æ—è–¥—Ä–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π
‚Ä¢ –ú–µ–Ω—è–π—Ç–µ –æ—Ä—É–∂–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏
‚Ä¢ –£–º–µ–Ω–∏—è –∏–º–µ—é—Ç –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫—É - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö —Å —É–º–æ–º!`);
        }

        function showMenu() {
            cleanupGame();
            document.getElementById('results').style.display = 'none';
            document.getElementById('menu').style.display = 'flex';
        }

        function restartGame() {
            showMenu();
            setTimeout(startGame, 500);
        }

        function cleanupGame() {
            isGameRunning = false;
            isPaused = false;
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            
            enemies = [];
            crystals = [];
            particles = [];
            
            joystickActive = false;
            joystickDirection.set(0, 0);
            isDragging = false;
            cameraTouchId = null;
            
            playerVelocity.set(0, 0, 0);
            playerPosition.set(0, 1.6, 0);
            cameraRotation.x = 0;
            cameraRotation.y = 0;
            
            if (scene) {
                while(scene.children.length > 0) { 
                    scene.remove(scene.children[0]); 
                }
            }
            
            const gameContainer = document.getElementById('gameContainer');
            if (gameContainer) {
                gameContainer.innerHTML = '';
            }
        }

        function startGameTimer() {
            gameTime = 0;
            gameTimer = setInterval(() => {
                if (!isPaused) gameTime++;
            }, 1000);
        }

        // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ===

        function updateAllDisplays() {
            updateScore();
            updateLevelDisplay();
            updateWaveDisplay();
            updateEnemiesCount();
            updateHealthBar();
            updateExpBar();
        }

        function updateScore() {
            document.getElementById('scoreValue').textContent = score;
        }

        function updateLevelDisplay() {
            document.getElementById('levelValue').textContent = playerLevel;
        }

        function updateWaveDisplay() {
            document.getElementById('waveValue').textContent = currentWave;
        }

        function updateEnemiesCount() {
            document.getElementById('enemiesValue').textContent = enemiesAlive;
        }

        function updateHealthBar() {
            const healthPercent = Math.max(0, playerHealth) / playerMaxHealth;
            document.getElementById('healthFill').style.width = (healthPercent * 100) + '%';
        }

        function updateExpBar() {
            const expPercent = playerExp / expToNextLevel;
            document.getElementById('expFill').style.width = (expPercent * 100) + '%';
        }

        // === –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===

        function setupControls() {
            setupJoystick();
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π (–ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞)
            const gameContainer = document.getElementById('gameContainer');
            
            gameContainer.addEventListener('touchstart', (e) => {
                const joystickRect = document.getElementById('joystickContainer').getBoundingClientRect();
                for (let touch of e.changedTouches) {
                    const x = touch.clientX;
                    const y = touch.clientY;
                    
                    if (x > window.innerWidth / 2 && 
                       !(x >= joystickRect.left && x <= joystickRect.right && 
                         y >= joystickRect.top && y <= joystickRect.bottom)) {
                        isDragging = true;
                        cameraTouchId = touch.identifier;
                        previousMouseX = touch.clientX;
                        previousMouseY = touch.clientY;
                        e.preventDefault();
                        break;
                    }
                }
            });
            
            gameContainer.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    for (let touch of e.touches) {
                        if (touch.identifier === cameraTouchId) {
                            const deltaX = touch.clientX - previousMouseX;
                            const deltaY = touch.clientY - previousMouseY;
                            
                            cameraRotation.y -= deltaX * cameraSensitivity;
                            cameraRotation.x -= deltaY * cameraSensitivity;
                            
                            cameraRotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, cameraRotation.x));
                            
                            previousMouseX = touch.clientX;
                            previousMouseY = touch.clientY;
                            e.preventDefault();
                            break;
                        }
                    }
                }
            });
            
            gameContainer.addEventListener('touchend', (e) => {
                for (let touch of e.changedTouches) {
                    if (touch.identifier === cameraTouchId) {
                        isDragging = false;
                        cameraTouchId = null;
                        break;
                    }
                }
            });
            
            // –°—Ç—Ä–µ–ª—å–±–∞
            document.getElementById('shootBtn').addEventListener('touchstart', (e) => {
                shoot();
                e.preventDefault();
            });
            
            // –£–º–µ–Ω–∏–µ
            document.getElementById('skillBtn').addEventListener('touchstart', (e) => {
                useSkill();
                e.preventDefault();
            });
            
            // –°–º–µ–Ω–∞ –æ—Ä—É–∂–∏—è –ø–æ –¥–≤–æ–π–Ω–æ–º—É —Ç–∞–ø—É
            let lastTap = 0;
            gameContainer.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0) {
                    // –°–º–µ–Ω–∞ –æ—Ä—É–∂–∏—è
                    const weaponKeys = Object.keys(weapons);
                    const currentIndex = weaponKeys.indexOf(currentWeapon);
                    let nextIndex = (currentIndex + 1) % weaponKeys.length;
                    
                    while (!weaponUnlocks[weaponKeys[nextIndex]] && nextIndex !== currentIndex) {
                        nextIndex = (nextIndex + 1) % weaponKeys.length;
                    }
                    
                    if (weaponUnlocks[weaponKeys[nextIndex]]) {
                        currentWeapon = weaponKeys[nextIndex];
                        document.getElementById('weaponDisplay').textContent = weapons[currentWeapon].name;
                    }
                }
                lastTap = currentTime;
            });
        }

        function setupJoystick() {
            const joystickBase = document.getElementById('joystickBase');
            const joystickHandle = document.getElementById('joystickHandle');
            let joystickBaseRect;
            const joystickRadius = 50;
            let touchId = null;

            function updateJoystickPosition(clientX, clientY) {
                if (!joystickBaseRect) {
                    joystickBaseRect = joystickBase.getBoundingClientRect();
                }
                
                const baseCenterX = joystickBaseRect.left + joystickBaseRect.width / 2;
                const baseCenterY = joystickBaseRect.top + joystickBaseRect.height / 2;
                
                const deltaX = clientX - baseCenterX;
                const deltaY = clientY - baseCenterY;
                
                const distance = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY), joystickRadius);
                const angle = Math.atan2(deltaY, deltaX);
                
                const limitedX = Math.cos(angle) * distance;
                const limitedY = Math.sin(angle) * distance;
                
                joystickHandle.style.transform = `translate(calc(-50% + ${limitedX}px), calc(-50% + ${limitedY}px))`;
                
                joystickDirection.x = limitedX / joystickRadius;
                joystickDirection.y = limitedY / joystickRadius;
            }
            
            function resetJoystick() {
                joystickActive = false;
                joystickHandle.style.transform = 'translate(-50%, -50%)';
                joystickDirection.x = 0;
                joystickDirection.y = 0;
                touchId = null;
            }

            // Touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥–∂–æ–π—Å—Ç–∏–∫–∞
            joystickBase.addEventListener('touchstart', (e) => {
                if (!joystickActive) {
                    e.preventDefault();
                    joystickActive = true;
                    touchId = e.changedTouches[0].identifier;
                    joystickBaseRect = joystickBase.getBoundingClientRect();
                    updateJoystickPosition(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                }
            });

            joystickBase.addEventListener('touchmove', (e) => {
                if (joystickActive) {
                    e.preventDefault();
                    for (let touch of e.changedTouches) {
                        if (touch.identifier === touchId) {
                            updateJoystickPosition(touch.clientX, touch.clientY);
                            break;
                        }
                    }
                }
            });

            joystickBase.addEventListener('touchend', (e) => {
                for (let touch of e.changedTouches) {
                    if (touch.identifier === touchId) {
                        resetJoystick();
                        break;
                    }
                }
            });
            
            joystickBase.addEventListener('touchcancel', (e) => {
                for (let touch of e.changedTouches) {
                    if (touch.identifier === touchId) {
                        resetJoystick();
                        break;
                    }
                }
            });
        }

        // === –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù–ò–¶–´ ===

        window.addEventListener('load', function() {
            console.log("üöÄ Z.E.R.O.: Last Breach –∑–∞–≥—Ä—É–∂–µ–Ω!");
            
            if (typeof THREE === 'undefined') {
                alert('‚ùå –û—à–∏–±–∫–∞: Three.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');
                return;
            }
            
            if (!window.WebGLRenderingContext) {
                alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebGL');
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            cameraSensitivity = 0.01 + (gameSettings.sensitivity * 0.005);
            
            console.log("‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ");
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', function() {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
        window.addEventListener('click', function(event) {
            const settingsModal = document.getElementById('settingsModal');
            const multiplayerModal = document.getElementById('multiplayerModal');
            
            if (event.target === settingsModal) {
                closeSettingsModal();
            }
            if (event.target === multiplayerModal) {
                closeMultiplayerModal();
            }
        });
    </script>
</body>
</html>
