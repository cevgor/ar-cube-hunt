<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ETHOS: CORE ONLINE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;500;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --primary: #00ff9d; --secondary: #00d2ff; --danger: #ff2a6d; --gold: #ffd700; }
        body { background-color: var(--bg); color: #fff; font-family: 'JetBrains Mono', monospace; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        [v-cloak] { display: none; }
        .cyber-btn { background: var(--primary); color: #000; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); font-weight: 800; display: flex; align-items: center; justify-content: center; transition: all 0.1s; }
        .cyber-btn:active { transform: scale(0.96); filter: brightness(0.8); }
        .card-container { perspective: 1000px; }
        .game-card { width: 90%; max-width: 360px; height: 55vh; background: #111; border: 1px solid #333; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); overflow: hidden; position: relative; transition: transform 0.3s ease-out; will-change: transform; }
        .choice-btn { flex: 1; height: 60px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.1s; }
        .choice-btn:active { transform: scale(0.95); }
        .choice-btn.left { border-bottom: 4px solid var(--danger); } .choice-btn.right { border-bottom: 4px solid var(--primary); }
        .stat-bar { height: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .scanlines { background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%); background-size: 100% 2px; position: fixed; inset: 0; pointer-events: none; z-index: 50; opacity: 0.3; }
        /* Inputs */
        .cyber-input { background: #111; border: 1px solid #333; color: var(--primary); padding: 12px; width: 100%; font-family: inherit; text-transform: uppercase; text-align: center; outline: none; }
        .cyber-input:focus { border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div id="app" v-cloak class="h-screen flex flex-col relative z-10">
        
        <!-- 1. REGISTRATION SCREEN -->
        <div v-if="screen === 'reg'" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black p-6">
            <h1 class="text-2xl font-bold text-white mb-2">–ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø</h1>
            <p class="text-xs text-gray-500 mb-6 uppercase">–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞</p>
            <input v-model="cityName" maxlength="12" placeholder="–ù–ê–ó–í–ê–ù–ò–ï..." class="cyber-input mb-4 rounded" />
            <button @click="registerUser" :disabled="!cityName" class="cyber-btn w-full py-4 text-lg disabled:opacity-50">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
        </div>

        <!-- 2. MENU -->
        <div v-if="screen === 'menu'" class="absolute inset-0 z-40 flex flex-col items-center justify-center bg-black/95 p-6">
            <h1 class="text-5xl font-black text-white mb-1 tracking-tighter text-center">ETHOS</h1>
            <div class="text-[#00ff9d] text-xs tracking-[0.5em] mb-8 uppercase">–°–ò–ú–£–õ–Ø–¢–û–†</div>
            
            <div class="w-full max-w-xs space-y-3">
                <div class="flex justify-between items-center bg-[#111] p-3 rounded border border-[#333] mb-4">
                    <div class="text-xs text-gray-400">{{ cityName }}</div>
                    <div class="font-bold text-yellow-500 font-mono">{{ bits }} ‡∏ø</div>
                </div>
                
                <button @click="startGame" class="cyber-btn w-full py-4 text-lg">–ò–ì–†–ê–¢–¨</button>
                
                <div class="grid grid-cols-2 gap-3">
                    <button @click="screen='shop'" class="cyber-btn bg-[#00d2ff] py-3 text-sm">–ú–ê–ì–ê–ó–ò–ù</button>
                    <button @click="openLeaderboard" class="cyber-btn bg-purple-500 text-white py-3 text-sm">–†–ï–ô–¢–ò–ù–ì</button>
                </div>

                <!-- Sound Toggle -->
                <button @click="toggleSound" class="w-full py-3 border border-gray-700 text-gray-400 text-xs flex justify-center gap-2 items-center rounded hover:bg-gray-900">
                    <span>{{ soundEnabled ? 'üîä –ó–í–£–ö –í–ö–õ' : 'üîá –ó–í–£–ö –í–´–ö–õ' }}</span>
                </button>
            </div>
        </div>

        <!-- 3. GAME -->
        <div v-if="screen === 'game'" class="flex-1 flex flex-col relative overflow-hidden">
            <div class="px-4 py-3 bg-black border-b border-white/10 grid grid-cols-4 gap-3 z-30">
                <div v-for="(val, key) in stats" :key="key" class="flex flex-col items-center">
                    <span class="text-lg">{{ icons[key] }}</span>
                    <div class="h-1.5 bg-[#222] w-full mt-1 rounded overflow-hidden"><div class="stat-bar" :class="getBarColor(val)" :style="{width: val + '%'}"></div></div>
                </div>
            </div>
            
            <div class="flex-1 flex items-center justify-center px-4 relative">
                <div v-if="deathReason" class="absolute z-[60] bg-red-600 text-white p-4 text-center font-black text-lg border-4 border-white rotate-[-2deg] shadow-2xl uppercase">{{ deathReason }}</div>
                <div v-if="activeScenario" class="game-card" :style="cardStyle">
                    <div class="h-3/5 bg-[#1a1a1a] flex items-center justify-center text-[7rem] relative border-b border-[#333]">{{ activeScenario.emoji }}</div>
                    <div class="h-2/5 p-5 flex flex-col items-center text-center bg-[#111]">
                        <h3 class="text-lg font-bold text-[#00ff9d] mb-2 uppercase leading-tight">{{ activeScenario.title }}</h3>
                        <p class="text-xs text-gray-300 font-mono">{{ activeScenario.desc }}</p>
                    </div>
                </div>
            </div>

            <div v-if="activeScenario && !deathReason" class="absolute bottom-6 w-full px-6 flex gap-4 z-40">
                <button @click="makeChoice('left')" class="choice-btn left"><span class="text-red-500 text-xl">‚úï</span><span class="text-[10px] text-red-100 mt-1">{{ activeScenario.left.text }}</span></button>
                <button @click="makeChoice('right')" class="choice-btn right"><span class="text-green-500 text-xl">‚úì</span><span class="text-[10px] text-green-100 mt-1">{{ activeScenario.right.text }}</span></button>
            </div>
        </div>

        <!-- 4. LEADERBOARD -->
        <div v-if="screen === 'ladder'" class="absolute inset-0 z-50 bg-black flex flex-col">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#111]">
                <h2 class="text-lg font-bold text-purple-400">–¢–û–ü –ì–û–†–û–î–û–í</h2>
                <button @click="screen='menu'" class="text-xs border border-gray-600 px-3 py-1 rounded text-white">–ù–ê–ó–ê–î</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                <div v-if="loadingLadder" class="text-center text-gray-500 mt-10 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <div v-for="(player, idx) in leaderboard" :key="idx" class="flex justify-between items-center p-3 bg-[#111] border border-gray-800 rounded" :class="{'border-purple-500 bg-purple-900/20': player.is_me}">
                    <div class="flex items-center gap-3">
                        <div class="font-black text-gray-500 w-6">{{ idx + 1 }}</div>
                        <div class="text-sm font-bold text-white">{{ player.city }}</div>
                    </div>
                    <div class="font-mono text-yellow-400 text-sm">{{ player.score }} –î–ù</div>
                </div>
            </div>
        </div>

        <!-- 5. SHOP & DONATE -->
        <div v-if="screen === 'shop'" class="absolute inset-0 z-50 bg-black flex flex-col">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                <h2 class="text-lg font-bold text-yellow-500">–ú–ê–ì–ê–ó–ò–ù</h2>
                <button @click="screen='menu'" class="text-xs border border-gray-600 px-3 py-1 rounded text-white">–ù–ê–ó–ê–î</button>
            </div>
            <div class="p-4 space-y-3 overflow-y-auto">
                <div class="p-3 bg-yellow-900/20 border border-yellow-600 rounded mb-6">
                    <div class="text-sm font-bold text-yellow-400 mb-1">üåü –ü–û–î–î–ï–†–ñ–ê–¢–¨ –ê–í–¢–û–†–ê</div>
                    <div class="text-[10px] text-gray-400 mb-2">–î–æ–Ω–∞—Ç —á–µ—Ä–µ–∑ Telegram Stars (–°–∫–æ—Ä–æ)</div>
                    <button class="w-full bg-yellow-600 text-black font-bold text-xs py-2 rounded opacity-50 cursor-not-allowed">–ö–£–ü–ò–¢–¨ 500 ‚≠êÔ∏è</button>
                </div>
                
                <div class="text-xs text-gray-500 uppercase mb-2">–£–ª—É—á—à–µ–Ω–∏—è</div>
                <div v-for="item in shopItems" :key="item.id" class="border border-gray-700 bg-gray-900 p-3 rounded flex justify-between items-center">
                    <div><div class="font-bold text-xs">{{ item.icon }} {{ item.name }}</div><div class="text-[9px] text-gray-500">{{ item.desc }}</div></div>
                    <button v-if="!upgrades[item.id]" @click="buyItem(item)" :disabled="bits < item.price" class="bg-[#00ff9d] text-black px-3 py-1 text-[10px] font-bold rounded disabled:opacity-30">{{ item.price }} ‡∏ø</button>
                    <div v-else class="text-green-500 text-[10px] font-bold border border-green-500 px-2 py-1 rounded">–ï–°–¢–¨</div>
                </div>
            </div>
        </div>

        <!-- 6. GAME OVER -->
        <div v-if="screen === 'end'" class="absolute inset-0 z-[100] bg-red-950/95 flex flex-col items-center justify-center p-8 text-center backdrop-blur">
            <div class="text-5xl mb-2">‚ò†Ô∏è</div>
            <h2 class="text-2xl font-black uppercase mb-4">–ì–û–†–û–î –ü–ê–õ</h2>
            <div class="bg-black/50 p-4 rounded mb-6 w-full max-w-xs">
                <div class="text-xs text-gray-400 uppercase">–í—ã–∂–∏–≤–∞–Ω–∏–µ</div>
                <div class="text-3xl font-mono text-white">{{ moves }} –î–ù–ï–ô</div>
            </div>
            <button @click="screen='menu'" class="cyber-btn w-full py-4 text-lg">–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ</button>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const tg = window.Telegram?.WebApp;

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø API ---
        // –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Ç—ã –∑–∞–ø—É—Å–∫–∞–µ—à—å –ª–æ–∫–∞–ª—å–Ω–æ, –∑–∞–º–µ–Ω–∏ –Ω–∞ http://localhost:8080
        // –ï—Å–ª–∏ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ - –≤—Å—Ç–∞–≤—å URL —Å–≤–æ–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ (–∞–¥—Ä–µ—Å Python —Å–∫—Ä–∏–ø—Ç–∞)
        // –î–ª—è GitHub Pages + –õ–æ–∫–∞–ª—å–Ω—ã–π –±–æ—Ç —ç—Ç–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç –±–µ–∑ —Ç—É–Ω–Ω–µ–ª—è (ngrok).
        // –ú—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≤ –±—É–¥—É—â–µ–º —Ç—É—Ç –±—É–¥–µ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä.
        const API_URL = "https://YOUR-PYTHON-SERVER-URL.com"; 

        const SCENARIOS = [
            { emoji:'üó≥Ô∏è', title:'–í–´–ë–û–†–´', desc:'–ü–æ–¥—Ç–∞—Å–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?', left:{text:'–î–ê', s:{pop:-10, sec:10}}, right:{text:'–ù–ï–¢', s:{pop:10, sec:-10}} },
            { emoji:'üí∞', title:'–ù–ê–õ–û–ì–ò', desc:'–ü–æ–¥–Ω—è—Ç—å –Ω–∞–ª–æ–≥–∏?', left:{text:'–ù–ï–¢', s:{fin:-10, pop:5}}, right:{text:'–î–ê', s:{fin:15, pop:-15}} },
            { emoji:'ü¶†', title:'–≠–ü–ò–î–ï–ú–ò–Ø', desc:'–í–≤–µ—Å—Ç–∏ –∫–∞—Ä–∞–Ω—Ç–∏–Ω?', left:{text:'–ù–ï–¢', s:{pop:-20, fin:10}}, right:{text:'–î–ê', s:{pop:5, fin:-20}} },
            { emoji:'üî´', title:'–ë–£–ù–¢', desc:'–ü–æ–¥–∞–≤–∏—Ç—å —Å–∏–ª–æ–π?', left:{text:'–ú–ò–†–ù–û', s:{sec:-15, mor:10}}, right:{text:'–°–ò–õ–û–ô', s:{sec:15, pop:-20}} },
            { emoji:'üëΩ', title:'–ù–õ–û', desc:'–ü—Ä–∏—à–µ–ª—å—Ü—ã –ø—Ä–æ—Å—è—Ç —Ä–µ—Å—É—Ä—Å—ã.', left:{text:'–û–¢–ö–ê–ó', s:{sec:-20}}, right:{text:'–î–ê–¢–¨', s:{fin:-20, sec:10}} }
        ];

        createApp({
            setup() {
                const screen = ref('reg');
                const soundEnabled = ref(true);
                const cityName = ref(localStorage.getItem('ec_city') || '');
                const bits = ref(parseInt(localStorage.getItem('ec_bits') || 0));
                const upgrades = ref(JSON.parse(localStorage.getItem('ec_upgrades') || '{}'));
                
                const stats = ref({ pop: 50, fin: 50, sec: 50, mor: 50 });
                const icons = { pop:'üë•', fin:'üí∞', sec:'üõ°Ô∏è', mor:'‚öñÔ∏è' };
                const moves = ref(0);
                const activeScenario = ref(null);
                const deathReason = ref(null);
                const leaderboard = ref([]);
                const loadingLadder = ref(false);
                const flyDir = ref(null);

                onMounted(() => {
                    if(tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#000000'); }
                    // –ï—Å–ª–∏ –∏–º—è —É–∂–µ –µ—Å—Ç—å, –∏–¥–µ–º –≤ –º–µ–Ω—é
                    if(cityName.value) screen.value = 'menu';
                });

                const cardStyle = computed(() => {
                    if(!flyDir.value) return {};
                    const x = flyDir.value === 'right' ? 400 : -400;
                    return { transform: `translate(${x}px, 50px) rotate(${flyDir.value === 'right' ? 20 : -20}deg)`, opacity: 0 };
                });

                // --- –õ–û–ì–ò–ö–ê –ó–í–£–ö–ê ---
                let audioCtx;
                const playSound = (type) => {
                    if(!soundEnabled.value) return;
                    try {
                        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        if(audioCtx.state === 'suspended') audioCtx.resume();
                        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                        o.connect(g); g.connect(audioCtx.destination);
                        const t = audioCtx.currentTime;
                        if(type==='click'){ o.type='triangle'; o.frequency.setValueAtTime(600,t); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.1); o.start(t); o.stop(t+0.1); }
                        if(type==='death'){ o.type='sawtooth'; o.frequency.setValueAtTime(100,t); o.frequency.linearRampToValueAtTime(20,t+1); g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+1); o.start(t); o.stop(t+1); }
                    } catch(e){}
                };
                const toggleSound = () => { soundEnabled.value = !soundEnabled.value; };

                // --- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ò –†–ï–ô–¢–ò–ù–ì ---
                const registerUser = () => {
                    if(!cityName.value) return;
                    localStorage.setItem('ec_city', cityName.value);
                    // –¢—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–∑–∞–≥–ª—É—à–∫–∞)
                    // fetch(API_URL + '/register', { method: 'POST', body: JSON.stringify({city: cityName.value}) });
                    screen.value = 'menu';
                };

                const openLeaderboard = async () => {
                    screen.value = 'ladder';
                    loadingLadder.value = true;
                    leaderboard.value = []; // –û—á–∏—Å—Ç–∏—Ç—å
                    
                    try {
                        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
                        // const res = await fetch(API_URL + '/leaderboard');
                        // leaderboard.value = await res.json();
                        
                        // --- –í–†–ï–ú–ï–ù–ù–ê–Ø –ó–ê–ì–õ–£–®–ö–ê (–î–õ–Ø –î–ï–ú–û) ---
                        await new Promise(r => setTimeout(r, 500));
                        leaderboard.value = [
                            { city: "NEO-TOKYO", score: 142, is_me: false },
                            { city: "CYBER-MOSCOW", score: 98, is_me: false },
                            { city: cityName.value || "YOU", score: moves.value, is_me: true },
                            { city: "NIGHT CITY", score: 45, is_me: false },
                        ].sort((a,b) => b.score - a.score);
                        // -------------------------------------

                    } catch(e) {
                        console.error(e);
                    } finally {
                        loadingLadder.value = false;
                    }
                };

                const saveScoreToServer = () => {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∫–æ—Ä–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    // const userData = tg?.initDataUnsafe?.user;
                    // if(userData) {
                    //    fetch(API_URL + '/score', {
                    //        method: 'POST',
                    //        body: JSON.stringify({ tg_id: userData.id, score: moves.value, city: cityName.value })
                    //    });
                    // }
                };

                // --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
                const startGame = () => {
                    playSound('click');
                    stats.value = { pop: 50, fin: 50, sec: 50, mor: 50 };
                    moves.value = 0; deathReason.value = null;
                    pickCard();
                    screen.value = 'game';
                };

                const pickCard = () => {
                    flyDir.value = null;
                    activeScenario.value = SCENARIOS[Math.floor(Math.random()*SCENARIOS.length)];
                };

                const makeChoice = (dir) => {
                    if(flyDir.value) return;
                    playSound('click');
                    flyDir.value = dir;
                    
                    const impact = activeScenario.value[dir].s;
                    for(let k in impact) stats.value[k] = Math.min(100, Math.max(0, stats.value[k] + impact[k]));
                    moves.value++;

                    setTimeout(() => {
                        const d = checkDeath();
                        if(d) {
                            deathReason.value = d;
                            playSound('death');
                            bits.value += moves.value;
                            localStorage.setItem('ec_bits', bits.value);
                            saveScoreToServer(); // <--- –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ê –°–ï–†–í–ï–†
                            setTimeout(() => screen.value = 'end', 1500);
                        } else {
                            pickCard();
                        }
                    }, 200);
                };

                const checkDeath = () => {
                    const s = stats.value;
                    if(s.pop<=0 || s.pop>=100) return "–ë–£–ù–¢ –ù–ê–°–ï–õ–ï–ù–ò–Ø";
                    if(s.fin<=0 || s.fin>=100) return "–≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ò–ô –ö–†–ê–•";
                    if(s.sec<=0 || s.sec>=100) return "–í–û–ï–ù–ù–´–ô –ü–ï–†–ï–í–û–†–û–¢";
                    if(s.mor<=0 || s.mor>=100) return "–ú–û–†–ê–õ–¨–ù–û–ï –†–ê–ó–õ–û–ñ–ï–ù–ò–ï";
                    return null;
                };

                const shopItems = [{id:'lens',name:'–õ–ò–ù–ó–ê',icon:'üëÅÔ∏è',desc:'–í–∏–¥–µ—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è',price:100}];
                const buyItem = (item) => {
                    if(bits.value >= item.price) {
                        bits.value -= item.price;
                        upgrades.value[item.id] = true;
                        localStorage.setItem('ec_bits', bits.value);
                        localStorage.setItem('ec_upgrades', JSON.stringify(upgrades.value));
                    }
                };

                return { 
                    screen, cityName, soundEnabled, bits, stats, icons, upgrades, activeScenario, cardStyle, deathReason, moves, leaderboard, loadingLadder, shopItems,
                    registerUser, startGame, toggleSound, makeChoice, openLeaderboard, buyItem, getBarColor: v => (v<20||v>80)?'bg-red-500':'bg-[#00ff9d]'
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
