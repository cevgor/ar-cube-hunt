<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ì–û–†–û–î–ü–õ–ê–ù ‚Äî –°–æ–≤–°–∏—Ç–∏ 1986 (SimCity soviet)</title>
<style>
:root{
  --bg-paper:#efe9df;
  --accent:#b33a2f;
  --accent-dark:#7f2418;
  --panel:#f6f0e8;
  --muted:#8b7f73;
  --text:#2b2b2b;
  --shadow: rgba(0,0,0,0.12);
  --glass: rgba(255,255,255,0.6);
}

/* RESET */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family: "Helvetica Neue", Arial, sans-serif;
  background: linear-gradient(180deg,var(--bg-paper),#e6dfd6 60%);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  overflow:hidden;
  touch-action:none;
}

/* Start Screen */
.start-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--accent-dark), var(--accent));
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

.start-content {
  background: var(--panel);
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  text-align: center;
  max-width: 400px;
  width: 100%;
  border: 4px solid var(--accent);
}

.start-title {
  font-size: 32px;
  font-weight: 900;
  color: var(--accent-dark);
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.start-subtitle {
  font-size: 16px;
  color: var(--muted);
  margin-bottom: 30px;
}

.start-buttons {
  display: flex;
  flex-direction: column;
  gap: 15px;
  width: 100%;
}

.start-btn {
  background: linear-gradient(180deg, var(--accent), var(--accent-dark));
  color: white;
  border: none;
  padding: 15px 30px;
  font-size: 18px;
  font-weight: 800;
  border-radius: 50px;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(179,58,47,0.3);
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
  width: 100%;
}

.start-btn.secondary {
  background: linear-gradient(180deg, #4a7ba6, #2f5a8a);
  box-shadow: 0 8px 20px rgba(47,90,138,0.3);
}

.start-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 25px rgba(179,58,47,0.4);
}

.start-btn.secondary:hover {
  box-shadow: 0 12px 25px rgba(47,90,138,0.4);
}

.start-btn:active {
  transform: translateY(0);
}

/* Header - document style */
.header{
  position:fixed;left:10px;right:10px;top:10px;
  display:flex;align-items:center;justify-content:space-between;
  background:linear-gradient(180deg,#fff,#f3ebe0);
  border:3px solid var(--accent);
  padding:8px 12px;border-radius:8px;
  box-shadow: 0 8px 20px var(--shadow);
  z-index:1200;
}
.header .title .main{font-weight:900;color:var(--accent-dark);font-size:16px;letter-spacing:1px}
.header .title .sub{font-size:11px;color:var(--muted)}

/* Left control panel */
.control-panel{
  position:fixed;left:10px;top:70px;bottom:10px;width:300px;
  background:linear-gradient(180deg,var(--panel),#ebe3d8);
  border:3px solid #c9b59f;border-radius:10px;padding:12px;
  box-shadow:0 8px 20px var(--shadow);overflow:auto;z-index:1150;
  transform-origin:left center;
  transition:transform .3s cubic-bezier(.2,.9,.2,1);
}
.control-panel.hidden{transform:translateX(-100%);opacity:0.9}

.control-panel h2{font-size:14px;color:var(--accent-dark);margin-bottom:8px;border-bottom:1px dashed rgba(0,0,0,0.06);padding-bottom:6px}
.category{margin-bottom:12px}
.building-option{
  display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:6px;margin:4px 0;
  background:#fff;border:1px solid #d3c8b8;cursor:pointer;transition:transform .12s,box-shadow .12s;
  font-size:13px;
}
.building-option:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.06)}
.building-option.selected{outline:2px solid rgba(179,58,47,0.12);background:linear-gradient(180deg,#fff5ef,#fff2e8)}
.building-option .name{font-weight:700;color:var(--accent-dark)}
.building-option .desc{font-size:11px;color:var(--muted)}

.controls-row{display:flex;gap:6px;margin-top:6px}
.btn{
  flex:1;padding:6px;border-radius:5px;background:linear-gradient(180deg,#fff,#f4ede2);
  border:2px solid var(--accent);cursor:pointer;text-align:center;font-weight:800;color:var(--accent-dark);
  box-shadow:0 4px 8px rgba(0,0,0,0.06);user-select:none;font-size:12px;
}
.btn.secondary{border-color:#9d8b7b;color:#6b5b4e}
.btn.active {
  background: linear-gradient(180deg, var(--accent), var(--accent-dark));
  color: white;
}
.small{padding:4px 6px;font-size:11px}
.icon-btn{padding:4px 6px;border-radius:5px;background:#fff;border:1px solid #d3c8b8;cursor:pointer;font-size:12px;}

/* center small control group */
.rotate-controls{display:flex;gap:4px;align-items:center;margin-top:6px}
.rotate-controls .icon-btn{font-weight:700}

/* confirmation modal */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(20,20,20,0.45);display:flex;align-items:center;justify-content:center;z-index:1300;
  opacity:0;pointer-events:none;transition:opacity .18s;
}
.modal-backdrop.show{opacity:1;pointer-events:auto}
.modal{
  width:300px;background:linear-gradient(180deg,#fff,#f6efe2);border:3px solid var(--accent);padding:14px;border-radius:10px;
  box-shadow:0 12px 36px rgba(0,0,0,0.28);transform:translateY(12px);transition:transform .2s;
}
.modal.show{transform:translateY(0)}
.modal h3{color:var(--accent-dark);margin-bottom:6px;font-size:14px;}
.modal p{color:var(--muted);margin-bottom:10px;font-size:13px;}

/* Game area */
#game3d{
  position:fixed;left:320px;right:250px;top:70px;bottom:10px;border-radius:8px;overflow:hidden;border:3px solid #d8c9b4;
  box-shadow:0 8px 30px var(--shadow);background:linear-gradient(180deg,#9fd0ff,#cdeaff);
}
#canvas3d{width:100%;height:100%;display:block}

/* placement DOM indicator */
#placement-indicator{
  position:fixed;pointer-events:none;z-index:1180;width:50px;height:50px;border-radius:6px;border:2px solid rgba(0,200,0,0.45);
  transform:translate(-50%,-50%);display:none;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.2));
  box-shadow:0 6px 15px rgba(0,0,0,0.06);
}

/* info/right */
.info-card{
  position:fixed;right:10px;top:70px;width:230px;bottom:10px;padding:10px;border-radius:10px;
  background:linear-gradient(180deg,#fff,#f7f1e7);border:3px solid #c9b59f;box-shadow:0 8px 20px var(--shadow);z-index:1150;overflow:auto;
}
.info-card h3{font-size:12px;color:var(--accent-dark);margin-bottom:6px}

/* hint */
.hint{
  position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:linear-gradient(180deg,#fff6ef,#fff1e3);
  border:2px solid var(--accent);padding:6px 12px;border-radius:15px;font-weight:800;color:var(--accent-dark);z-index:1190;
  box-shadow:0 6px 15px rgba(0,0,0,0.06);font-size:12px;max-width:90%;text-align:center;
}

/* footer */
.footer{position:fixed;left:10px;right:10px;bottom:5px;text-align:center;font-size:10px;color:var(--muted);z-index:1210}

/* clouds */
.cloud {position:fixed;pointer-events:none;z-index:1000;opacity:0.18;}

/* 1986 secret mode */
.secret-filter{position:fixed;inset:0;pointer-events:none;background:linear-gradient(180deg, rgba(255,150,50,0.06), rgba(255,120,30,0.04));mix-blend-mode:overlay;z-index:1400;display:none}

/* Time of day indicator */
.time-indicator {
  position: fixed;
  top: 75px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(180deg, #fff6ef, #fff1e3);
  border: 2px solid var(--accent);
  padding: 4px 10px;
  border-radius: 15px;
  font-weight: 800;
  color: var(--accent-dark);
  z-index: 1190;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
}

/* Transport indicator */
.transport-indicator {
  position: fixed;
  top: 110px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(180deg, #e8f4ff, #d4eaff);
  border: 2px solid #2f6fb3;
  padding: 4px 10px;
  border-radius: 15px;
  font-weight: 800;
  color: #2f6fb3;
  z-index: 1190;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
}

/* Pedestrians indicator */
.pedestrians-indicator {
  position: fixed;
  top: 145px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(180deg, #f0ffe8, #e0ffd4);
  border: 2px solid #2fa05e;
  padding: 4px 10px;
  border-radius: 15px;
  font-weight: 800;
  color: #2fa05e;
  z-index: 1190;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
}

/* Road building preview */
.road-preview {
  position: fixed;
  pointer-events: none;
  z-index: 1170;
  background: rgba(0, 150, 0, 0.3);
  border: 2px dashed rgba(0, 200, 0, 0.6);
  display: none;
}

/* Mobile menu toggle */
.mobile-menu-toggle {
  position: fixed;
  bottom: 60px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 800;
  z-index: 1250;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  display: none;
}

/* Compact building grid for mobile */
.buildings-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-bottom: 10px;
}

.building-icon {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px;
  border-radius: 6px;
  background: #fff;
  border: 1px solid #d3c8b8;
  cursor: pointer;
  transition: all 0.12s;
  text-align: center;
  font-size: 10px;
}

.building-icon:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.06);
}

.building-icon.selected {
  outline: 2px solid rgba(179,58,47,0.12);
  background: linear-gradient(180deg,#fff5ef,#fff2e8);
}

.building-icon .icon {
  font-size: 16px;
  margin-bottom: 2px;
}

.building-icon .name {
  font-weight: 700;
  color: var(--accent-dark);
  font-size: 9px;
}

/* small responsive */
@media (max-width:1200px){
  .control-panel{width:280px}
  #game3d{left:300px;right:10px}
  .info-card{width:200px}
}

@media (max-width:1000px){
  .control-panel{width:260px;left:8px;top:70px}
  #game3d{left:280px;right:8px}
  .info-card{display:none}
}

@media (max-width:800px){
  .control-panel{width:240px}
  #game3d{left:260px;right:8px}
}

@media (max-width:700px){
  .control-panel{
    position:fixed;
    left:8px;
    top:70px;
    transform:translateX(-100%);
    transition:transform .3s;
    width:85%;
    max-width:300px;
    bottom:60px;
  }
  .control-panel.active{transform:translateX(0)}
  #game3d{left:8px;right:8px;top:120px;bottom:60px}
  .info-card{display:none}
  .mobile-menu-toggle{display:block}
  
  .header {
    top: 8px;
    left: 8px;
    right: 8px;
    padding: 6px 10px;
  }
  
  .header .title .main{font-size:14px;}
  .header .title .sub{font-size:10px;}
  
  .time-indicator {top: 100px; font-size:10px;}
  .transport-indicator {top: 130px; font-size:10px;}
  .pedestrians-indicator {top: 160px; font-size:10px;}
  
  .buildings-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .building-option {
    display: none;
  }
  
  .category h3 {
    font-size: 12px;
    margin-bottom: 8px;
  }
}

@media (max-width:500px){
  .buildings-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .header .title .main{font-size:12px;}
  .header .title .sub{display:none;}
  
  .btn.small {
    padding: 3px 5px;
    font-size: 10px;
  }
}

@media (max-width:400px){
  .buildings-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .header {
    flex-direction: column;
    gap: 5px;
    padding: 8px;
  }
  
  .header .title {
    text-align: center;
  }
}

/* small animation for buttons */
.btn:active, .icon-btn:active, .building-icon:active{transform:translateY(1px) scale(.995)}
</style>
</head>
<body>

<!-- Start Screen -->
<div class="start-screen" id="start-screen">
  <div class="start-content">
    <div class="start-title">–ì–û–†–û–î–ü–õ–ê–ù</div>
    <div class="start-subtitle">–°–æ–≤–°–∏—Ç–∏ 1986 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ä–µ–∂–∏–º</div>
    <div class="start-buttons">
      <button class="start-btn" id="start-btn">–ù–ê–ß–ê–¢–¨ –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–û</button>
      <button class="start-btn secondary" id="ready-city-btn">–ì–û–¢–û–í–´–ô –ì–û–†–û–î</button>
    </div>
    <div style="margin-top:20px;font-size:12px;color:var(--muted)">
      –ü–æ—Å—Ç—Ä–æ–π —Å–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π —Å–æ–≤–µ—Ç—Å–∫–∏–π –≥–æ—Ä–æ–¥
    </div>
  </div>
</div>

<!-- Header -->
<div class="header">
  <div class="title">
    <div class="main">–ì–û–†–û–î–ü–õ–ê–ù ‚Äî 1986</div>
    <div class="sub">–°–æ–≤–°–∏—Ç–∏ 3D ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ä–µ–∂–∏–º</div>
  </div>
  <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
    <div style="font-weight:900;color:var(--muted);font-size:11px">–ì–æ–¥: <span id="year-display">1985</span></div>
    <button class="btn small" id="toggle-pedestrians" title="–í–∫–ª—é—á–∏—Ç—å –ø–µ—à–µ—Ö–æ–¥–æ–≤">üë•</button>
    <button class="btn small" id="toggle-transport" title="–í–∫–ª—é—á–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç">üöå</button>
    <button class="btn small" id="toggle-time" title="–°–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è —Å—É—Ç–æ–∫">üåô</button>
    <button class="btn small" id="toggle-menu" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –º–µ–Ω—é">‚ò∞</button>
    <button class="btn small" id="secret-mode">86</button>
  </div>
</div>

<!-- Time indicator -->
<div class="time-indicator" id="time-indicator">
  <span id="time-icon">‚òÄÔ∏è</span>
  <span id="time-text">–î–µ–Ω—å</span>
</div>

<!-- Transport indicator -->
<div class="transport-indicator" id="transport-indicator" style="display:none">
  <span id="transport-icon">üöå</span>
  <span id="transport-text">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: 0</span>
</div>

<!-- Pedestrians indicator -->
<div class="pedestrians-indicator" id="pedestrians-indicator" style="display:none">
  <span id="pedestrians-icon">üë•</span>
  <span id="pedestrians-text">–ü–µ—à–µ—Ö–æ–¥—ã: 0</span>
</div>

<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobile-menu-toggle">üìã –ú–ï–ù–Æ</button>

<!-- Left panel -->
<div class="control-panel" id="control-panel">
  <h2>–¢–∏–ø—ã –∑–¥–∞–Ω–∏–π</h2>

  <!-- Compact building grid for mobile -->
  <div class="buildings-grid">
    <div class="building-icon selected" data-type="khrushchev">
      <div class="icon">üè¢</div>
      <div class="name">–•—Ä—É—â—ë–≤–∫–∞</div>
    </div>
    <div class="building-icon" data-type="brezhnev">
      <div class="icon">üè¨</div>
      <div class="name">–ë—Ä–µ–∂–Ω–µ–≤–∫–∞</div>
    </div>
    <div class="building-icon" data-type="dormitory">
      <div class="icon">üèòÔ∏è</div>
      <div class="name">–û–±—â–µ–∂–∏—Ç–∏–µ</div>
    </div>
    <div class="building-icon" data-type="school">
      <div class="icon">üè´</div>
      <div class="name">–®–∫–æ–ª–∞</div>
    </div>
    <div class="building-icon" data-type="hospital">
      <div class="icon">üè•</div>
      <div class="name">–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞</div>
    </div>
    <div class="building-icon" data-type="busstop">
      <div class="icon">üöè</div>
      <div class="name">–û—Å—Ç–∞–Ω–æ–≤–∫–∞</div>
    </div>
    <div class="building-icon" data-type="factory">
      <div class="icon">üè≠</div>
      <div class="name">–ó–∞–≤–æ–¥</div>
    </div>
    <div class="building-icon" data-type="park">
      <div class="icon">üå≥</div>
      <div class="name">–ü–∞—Ä–∫</div>
    </div>
    <div class="building-icon" data-type="road">
      <div class="icon">üõ£Ô∏è</div>
      <div class="name">–î–æ—Ä–æ–≥–∞</div>
    </div>
  </div>

  <!-- Original building list (hidden on mobile) -->
  <div class="category">
    <div class="building-option selected" data-type="khrushchev">
      <div><div class="name">–•—Ä—É—â—ë–≤–∫–∞</div><div class="desc">5 —ç—Ç–∞–∂–µ–π, –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è</div></div>
      <div style="font-size:11px;color:var(--muted)">r:3</div>
    </div>
    <div class="building-option" data-type="brezhnev">
      <div><div class="name">–ë—Ä–µ–∂–Ω–µ–≤–∫–∞</div><div class="desc">9 —ç—Ç–∞–∂–µ–π, –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω–∞—è</div></div>
      <div style="font-size:11px;color:var(--muted)">r:4</div>
    </div>
    <div class="building-option" data-type="dormitory">
      <div><div class="name">–û–±—â–µ–∂–∏—Ç–∏–µ</div><div class="desc">–î–ª–∏–Ω–Ω—ã–π –∫–æ—Ä–ø—É—Å</div></div>
      <div style="font-size:11px;color:var(--muted)">r:4</div>
    </div>
  </div>

  <div class="category">
    <div class="building-option" data-type="school"><div><div class="name">–®–∫–æ–ª–∞</div><div class="desc">–¢–∏–ø–æ–≤–æ–π –±–ª–æ–∫</div></div><div style="font-size:11px;color:var(--muted)">r:5</div></div>
    <div class="building-option" data-type="hospital"><div><div class="name">–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞</div><div class="desc">–ú–µ–¥–ø—É–Ω–∫—Ç</div></div><div style="font-size:11px;color:var(--muted)">r:4</div></div>
    <div class="building-option" data-type="busstop"><div><div class="name">–ê–≤—Ç–æ–±—É—Å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞</div><div class="desc">–¢–æ—á–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</div></div><div style="font-size:11px;color:var(--muted)">r:2</div></div>
  </div>

  <div class="category">
    <div class="building-option" data-type="factory"><div><div class="name">–ó–∞–≤–æ–¥</div><div class="desc">–ö–∏—Ä–ø–∏—á, —Ç—Ä—É–±–∞, –¥—ã–º</div></div><div style="font-size:11px;color:var(--muted)">r:5</div></div>
    <div class="building-option" data-type="park"><div><div class="name">–ü–∞—Ä–∫</div><div class="desc">–î–µ—Ä–µ–≤—å—è, –≥–∞–∑–æ–Ω</div></div><div style="font-size:11px;color:var(--muted)">r:3</div></div>
    <div class="building-option" data-type="road"><div><div class="name">–î–æ—Ä–æ–≥–∞</div><div class="desc">–í—ã–±–µ—Ä–∏ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü</div></div><div style="font-size:11px;color:var(--muted)">r:2</div></div>
  </div>

  <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
  <div style="display:flex;gap:6px;margin-bottom:8px">
    <button class="btn active" id="camera-mode">–ö–∞–º–µ—Ä–∞</button>
    <button class="btn" id="build-mode">–°—Ç—Ä–æ–∏—Ç—å</button>
    <button class="btn secondary" id="demolish-mode">–°–Ω–æ—Å</button>
  </div>

  <div style="margin-top:6px">
    <div style="font-size:12px;color:var(--muted);margin-bottom:4px">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
    <div style="background:#fff;padding:8px;border-radius:5px;border:1px solid #dfd1bd;font-size:11px">–í —Ä–µ–∂–∏–º–µ –∫–∞–º–µ—Ä—ã: –≤—Ä–∞—â–∞–π—Ç–µ –∏ –ø–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –∫–∞–º–µ—Ä—É. –í —Ä–µ–∂–∏–º–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞: –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞.</div>
  </div>

  <div style="height:10px"></div>

  <div style="display:flex;gap:6px;align-items:center">
    <div class="rotate-controls" style="flex:1">
      <button class="icon-btn" id="rot-left">‚Ü∫</button>
      <div style="font-weight:800;color:var(--muted);padding:4px 6px;border:1px dashed #e0d6c8;border-radius:5px;font-size:11px">–£–≥–æ–ª: <span id="rotate-angle">0¬∞</span></div>
      <button class="icon-btn" id="rot-right">‚Üª</button>
    </div>
  </div>

  <div style="height:10px"></div>
  <div style="display:flex;gap:6px">
    <button class="btn small" id="clear-all">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <button class="btn small" id="center-camera">–¶–µ–Ω—Ç—Ä</button>
  </div>
</div>

<!-- Game -->
<div id="game3d"><canvas id="canvas3d"></canvas></div>
<div id="placement-indicator"></div>

<!-- confirmation modal -->
<div id="modal-back" class="modal-backdrop">
  <div id="modal" class="modal">
    <h3 id="modal-title">–ü–æ—Å—Ç–∞–≤–∏—Ç—å –∑–¥–∞–Ω–∏–µ?</h3>
    <p id="modal-desc">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—Ç–µ?</p>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn small" id="modal-cancel">‚úñ –û—Ç–º–µ–Ω–∞</button>
      <button class="btn small" id="modal-confirm">‚úî –ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- info/right -->
<div class="info-card">
  <h3>–ü–ª–∞–Ω –∫–≤–∞—Ä—Ç–∞–ª–∞</h3>
  <div style="font-size:12px;color:var(--muted);margin-bottom:6px">–ñ–∏–ª–æ–π —Ñ–æ–Ω–¥, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
  <div style="font-size:12px">–ñ–∏–ª–æ–π —Ñ–æ–Ω–¥: <strong id="housing-value">40</strong></div>
  <div style="height:6px"></div>
  <div style="font-size:12px">–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: <strong id="infra-value">1</strong></div>
  <div style="height:6px"></div>
  <div style="font-size:12px">–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å: <strong id="satisfaction-value">75%</strong></div>
  <div style="height:6px"></div>
  <div style="font-size:12px">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: <strong id="transport-value">0%</strong></div>
  <div style="height:6px"></div>
  <div style="font-size:12px">–ù–∞—Å–µ–ª–µ–Ω–∏–µ: <strong id="population-value">0</strong></div>
  <div style="height:12px"></div>
  <div style="font-size:11px;color:var(--muted)">–ü–æ–¥—Å–≤–µ—Ç–∫–∞: –∑–µ–ª—ë–Ω–∞—è ‚Äî –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å; –∫—Ä–∞—Å–Ω–∞—è ‚Äî –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ</div>
</div>

<div class="hint" id="hint">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</div>
<div class="footer">¬© –ì–û–†–û–î–ü–õ–ê–ù ‚Äî —Ç–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞</div>
<div class="secret-filter" id="secret-filter"></div>

<!-- clouds (decorative DOM) -->
<img src="" id="cloud1" class="cloud" style="width:260px;top:40px;left:20px">
<img src="" id="cloud2" class="cloud" style="width:200px;top:80px;right:60px">

<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

<script>
// ======================
// Embedded base64 sounds
// ======================
const SOUND_CLICK = "data:audio/wav;base64,UklGRlQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YUcAAAAA/////wAAAP//AAD//wAA//8AAP//AAD//wAA";
const SOUND_CONFIRM = "data:audio/wav;base64,UklGRlQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YVQAAAAAAP///wD///8A////AP///wD///8A";
const SOUND_ERROR = "data:audio/wav;base64,UklGRhIAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YRAAAAAA/////wAAAP//AAD//wAA";
const SOUND_BUILD = "data:audio/wav;base64,UklGRhMAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAAA/////wAAAP//AAD//wAA";
const SOUND_DEMOLISH = "data:audio/wav;base64,UklGRkAAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAAA/////wAAAP//AAD//wAA";
const SOUND_TIME_CHANGE = "data:audio/wav;base64,UklGRhIAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YRAAAAAA/////wAAAP//AAD//wAA";
const SOUND_BUS_HORN = "data:audio/wav;base64,UklGRhIAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YRAAAAAA/////wAAAP//AAD//wAA";

function playSound(src, vol=0.35){
  try{
    const a = new Audio(src);
    a.volume = vol;
    a.play();
  }catch(e){}
}

// ===============
// Game class
// ===============
class SovietCityGame {
  constructor(){
    this.selectedType = 'khrushchev';
    this.mode = 'camera'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–µ–∂–∏–º –∫–∞–º–µ—Ä—ã
    this.rotationAngle = 0;
    this.buildings = [];
    this.roads = [];
    this.growing = [];
    this.smoke = [];
    this.roadBuildingStart = null;
    this.roadPreview = null;
    this.stats = { housing:40, infra:1, satisfaction:75, year:1985, transport:0, population:0 };
    
    this.transportEnabled = false;
    this.busStops = [];
    this.buses = [];
    this.busRoutes = [];
    
    this.pedestriansEnabled = false;
    this.pedestrians = [];
    this.pedestrianSpawnTimer = 0;
    
    this.isDay = true;
    this.timeTransition = 0;
    this.timeTransitionSpeed = 0.005;
    this.windowLights = [];

    this.raycaster = new THREE.Raycaster();
    this.mouse = new THREE.Vector2();

    this.wind = new THREE.Vector3((Math.random()-0.5)*0.06, 0.02, (Math.random()-0.5)*0.06);

    this.initThree();
    this.createScene();
    this.setupUI();
    this.animate();
    this.updateUI();
    this.setupClouds();
    this.updateTimeDisplay();
  }

  initThree(){
    const container = document.getElementById('game3d');
    this.scene = new THREE.Scene();
    this.scene.background = new THREE.Color(0xbfe9ff);
    this.scene.fog = new THREE.Fog(0xbfe9ff, 40, 250);

    const aspect = container.clientWidth / container.clientHeight;
    this.camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 1000);
    this.camera.position.set(50,40,60);
    this.camera.lookAt(0,0,0);

    this.renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas3d'), antialias:true });
    this.renderer.setSize(container.clientWidth, container.clientHeight);
    this.renderer.shadowMap.enabled = true;
    this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
    this.controls.enableDamping = true;
    this.controls.dampingFactor = 0.08;

    window.addEventListener('resize', ()=>this.onResize());
  }

  createScene(){
    const amb = new THREE.AmbientLight(0xffffff, 0.55);
    this.scene.add(amb);
    this.sun = new THREE.DirectionalLight(0xffffff, 0.9);
    this.sun.position.set(50,80,20);
    this.sun.castShadow = true;
    this.sun.shadow.camera.left=-100; this.sun.shadow.camera.right=100;
    this.sun.shadow.camera.top=100; this.sun.shadow.camera.bottom=-100;
    this.sun.shadow.mapSize.width=2048; this.sun.shadow.mapSize.height=2048;
    this.scene.add(this.sun);

    this.moon = new THREE.DirectionalLight(0xaaaacc, 0);
    this.moon.position.set(-50,80,-20);
    this.scene.add(this.moon);

    const groundMat = new THREE.MeshLambertMaterial({ color:0x2e6a3e });
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(400,400), groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    ground.userData.isGround = true;
    this.ground = ground;
    this.scene.add(ground);

    // Grid helper - –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ê –°–ï–¢–ö–ê!
    const grid = new THREE.GridHelper(400, 40, 0x000000, 0x000000);
    grid.material.opacity = 0.06; grid.material.transparent = true;
    this.scene.add(grid);

    const helperGeo = new THREE.PlaneGeometry(4,4);
    const helperMat = new THREE.MeshBasicMaterial({ color:0x00ff00, transparent:true, opacity:0.16, side:THREE.DoubleSide });
    this.placementHelper = new THREE.Mesh(helperGeo, helperMat);
    this.placementHelper.rotation.x = -Math.PI/2;
    this.placementHelper.visible = false;
    this.scene.add(this.placementHelper);

    this.smokeTex = this.makeSmokeTex();

    this.createBuilding('khrushchev', -18, -12);
    this.createBuilding('brezhnev', -4, -12);
    this.createBuilding('school', 10, -12);
  }

  makeSmokeTex(){
    const size = 128;
    const c = document.createElement('canvas'); c.width = c.height = size;
    const ctx = c.getContext('2d');
    const g = ctx.createRadialGradient(size/2,size/2,3,size/2,size/2,size/1.1);
    g.addColorStop(0,'rgba(255,255,255,0.95)');
    g.addColorStop(0.2,'rgba(220,220,220,0.6)');
    g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle = g; ctx.fillRect(0,0,size,size);
    return new THREE.CanvasTexture(c);
  }

  footprint(type){
    switch(type){
      case 'khrushchev': return 3.0;
      case 'brezhnev': return 4.0;
      case 'dormitory': return 4.0;
      case 'school': return 5.0;
      case 'factory': return 5.0;
      case 'park': return 3.0;
      case 'hospital': return 4.0;
      case 'busstop': return 2.0;
      case 'road': return 1.8;
      default: return 3.0;
    }
  }

  checkCollision(x,z,radius){
    for (const b of this.buildings){
      const dx = b.userData.cx - x, dz = b.userData.cz - z;
      const dist2 = dx*dx + dz*dz;
      const minDist = (b.userData.radius + radius) * 0.9;
      if (dist2 < minDist*minDist) return true;
    }
    for (const r of this.roads){
      const dx = r.x - x, dz = r.z - z;
      if (dx*dx + dz*dz < (radius+0.8)*(radius+0.8)) return true;
    }
    for (const s of this.busStops){
      const dx = s.x - x, dz = s.z - z;
      if (dx*dx + dz*dz < (radius+1.5)*(radius+1.5)) return true;
    }
    return false;
  }

  createBuilding(type, x, z){
    const radius = this.footprint(type);
    if (this.checkCollision(x,z,radius)){
      playSound(SOUND_ERROR, 0.48);
      return null;
    }

    const g = new THREE.Group();
    g.position.set(x,0,z);
    g.userData = { type, cx:x, cz:z, radius };

    const addBlock = (w,h,d,color)=>{
      const geom = new THREE.BoxGeometry(w,h,d);
      const mat = new THREE.MeshLambertMaterial({ color });
      const mesh = new THREE.Mesh(geom, mat);
      mesh.castShadow = true; mesh.receiveShadow = true;
      mesh.position.y = h/2;
      g.add(mesh);

      const winMat = new THREE.MeshBasicMaterial({ 
        color: this.isDay ? 0xfff2c0 : 0xffdd00,
        transparent: true,
        opacity: this.isDay ? 0.3 : 0.9
      });
      
      const cols = Math.max(1, Math.floor(w/2.5));
      const rows = Math.max(1, Math.floor(h/3));
      for (let i=0;i<cols;i++){
        for (let j=0;j<rows;j++){
          if (Math.random() > 0.6) continue;
          const winW = w/(cols*1.5), winH = h/(rows*1.6);
          const plane = new THREE.Mesh(new THREE.PlaneGeometry(winW*0.9, winH*0.8), winMat);
          const px = -w/2 + (i+0.6)*(w/cols);
          const py = -h/2 + (j+0.8)*(h/rows) + h/2;
          plane.position.set(px, py, d/2 + 0.02);
          g.add(plane);
          
          this.windowLights.push(winMat);
        }
      }
      return mesh;
    };

    if (type === 'khrushchev'){
      addBlock(8,12,6, 0xcfcfc8);
      const roof = new THREE.Mesh(new THREE.BoxGeometry(8.5,0.5,6.5), new THREE.MeshLambertMaterial({color:0x8c7a68}));
      roof.position.y = 12 + 0.25; g.add(roof);
    } else if (type === 'brezhnev'){
      addBlock(10,26,8, 0xbdb6ae);
      const side = addBlock(4,20,8, 0xa6a09a); side.position.x = 7;
    } else if (type === 'dormitory'){
      addBlock(18,14,6, 0xb7a0c3);
    } else if (type === 'school'){
      addBlock(20,9,15, 0x6fb0d8);
      const porch = new THREE.Mesh(new THREE.BoxGeometry(6,3,6), new THREE.MeshLambertMaterial({color:0x3f7085}));
      porch.position.set(0,1.5,9); g.add(porch);
    } else if (type === 'hospital'){
      addBlock(15,10,10, 0xffffff);
      const cross = new THREE.Mesh(new THREE.BoxGeometry(4,4,1), new THREE.MeshLambertMaterial({color:0xff3333}));
      cross.position.set(0,8,5.6); g.add(cross);
    } else if (type === 'factory'){
      addBlock(16,10,12, 0x8a8a8a);
      const chimney = new THREE.Mesh(new THREE.CylinderGeometry(0.9,0.9,18,12), new THREE.MeshLambertMaterial({color:0x525252}));
      chimney.position.set(5, 10+9, 0); chimney.castShadow = true; g.add(chimney);
      const chimneyTop = new THREE.Object3D(); chimneyTop.name='chimneyTop'; chimneyTop.position.set(5, 10+18, 0); g.add(chimneyTop);
    } else if (type === 'park'){
      const lawn = new THREE.Mesh(new THREE.BoxGeometry(12,0.2,12), new THREE.MeshLambertMaterial({color:0x2fa05e}));
      lawn.position.y = 0.1; g.add(lawn);
      for (let i=0;i<5;i++){
        const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.25,5,8), new THREE.MeshLambertMaterial({color:0x6f3f21}));
        trunk.position.set((Math.random()-0.5)*6, 2.5, (Math.random()-0.5)*6);
        const leaves = new THREE.Mesh(new THREE.SphereGeometry(2.2,8,6), new THREE.MeshLambertMaterial({color:0x2fbf62}));
        leaves.position.y = 4.2; trunk.add(leaves); g.add(trunk);
      }
    } else if (type === 'busstop'){
      const pole1 = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,3,8), new THREE.MeshLambertMaterial({color:0x8B4513}));
      pole1.position.set(-1,1.5,0); g.add(pole1);
      const pole2 = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,3,8), new THREE.MeshLambertMaterial({color:0x8B4513}));
      pole2.position.set(1,1.5,0); g.add(pole2);
      const roof = new THREE.Mesh(new THREE.BoxGeometry(2.5,0.1,1.5), new THREE.MeshLambertMaterial({color:0x666666}));
      roof.position.set(0,3,0); g.add(roof);
      const sign = new THREE.Mesh(new THREE.BoxGeometry(1.5,1,0.1), new THREE.MeshLambertMaterial({color:0xFFD700}));
      sign.position.set(0,2,0.8); g.add(sign);
      
      this.busStops.push({x, z, group: g});
    } else if (type === 'road'){
      return null;
    } else {
      addBlock(8,10,8, 0xbdbdb6);
    }

    g.rotation.y = THREE.MathUtils.degToRad(this.rotationAngle);

    g.scale.set(1, 0.02, 1);
    g.userData.growthStart = performance.now();
    g.userData.growthDuration = 700 + Math.random()*700;

    this.scene.add(g);
    this.buildings.push(g);
    this.growing.push(g);

    this.updateStats(type);

    if (navigator.vibrate) navigator.vibrate(40);
    playSound(SOUND_BUILD, 0.5);

    return g;
  }

  buildRoadLine(x1,z1,x2,z2){
    const dx = x2 - x1;
    const dz = z2 - z1;
    const length = Math.sqrt(dx*dx + dz*dz);
    const angle = Math.atan2(dz, dx);
    
    const roadGeometry = new THREE.PlaneGeometry(length, 4);
    const roadMaterial = new THREE.MeshLambertMaterial({color: 0x333333});
    const roadMesh = new THREE.Mesh(roadGeometry, roadMaterial);
    
    roadMesh.position.set((x1+x2)/2, 0.01, (z1+z2)/2);
    roadMesh.rotation.x = -Math.PI/2;
    roadMesh.rotation.z = angle;
    
    roadMesh.receiveShadow = true;
    this.scene.add(roadMesh);
    
    const lineGeometry = new THREE.PlaneGeometry(length, 0.2);
    const lineMaterial = new THREE.MeshBasicMaterial({color: 0xffff00});
    const lineMesh = new THREE.Mesh(lineGeometry, lineMaterial);
    lineMesh.position.set(0, 0.02, 0);
    lineMesh.rotation.x = -Math.PI/2;
    roadMesh.add(lineMesh);
    
    this.roads.push({
      mesh: roadMesh,
      x: (x1+x2)/2, 
      z: (z1+z2)/2,
      start: {x: x1, z: z1},
      end: {x: x2, z: z2}
    });
    
    this.stats.infra += 1;
    
    playSound(SOUND_CONFIRM, 0.6);
    if (navigator.vibrate) navigator.vibrate([20,10,20]);
    
    return roadMesh;
  }

  updateRoadPreview(x1, z1, x2, z2) {
    if (this.roadPreview) {
      this.scene.remove(this.roadPreview);
    }
    
    const dx = x2 - x1;
    const dz = z2 - z1;
    const length = Math.sqrt(dx*dx + dz*dz);
    const angle = Math.atan2(dz, dx);
    
    const previewGeometry = new THREE.PlaneGeometry(length, 4);
    const previewMaterial = new THREE.MeshBasicMaterial({
      color: 0x00ff00,
      transparent: true,
      opacity: 0.6,
      side: THREE.DoubleSide
    });
    
    this.roadPreview = new THREE.Mesh(previewGeometry, previewMaterial);
    this.roadPreview.position.set((x1+x2)/2, 0.02, (z1+z2)/2);
    this.roadPreview.rotation.x = -Math.PI/2;
    this.roadPreview.rotation.z = angle;
    
    this.scene.add(this.roadPreview);
  }

  removeRoadPreview() {
    if (this.roadPreview) {
      this.scene.remove(this.roadPreview);
      this.roadPreview = null;
    }
  }

  spawnSmokeAt(vec3){
    const mat = new THREE.SpriteMaterial({ map: this.smokeTex, transparent:true, depthWrite:false });
    const spr = new THREE.Sprite(mat);
    spr.position.copy(vec3);
    spr.scale.set(2.2,2.2,1);
    spr.material.opacity = 0.95;
    this.scene.add(spr);
    this.smoke.push({mesh:spr, born:performance.now(), life:1200+Math.random()*900, vel: new THREE.Vector3((Math.random()-0.5)*0.06, 0.02+Math.random()*0.05, (Math.random()-0.5)*0.06)});
  }

  toggleTimeOfDay() {
    this.isDay = !this.isDay;
    playSound(SOUND_TIME_CHANGE, 0.4);
    this.updateTimeDisplay();
  }

  toggleTransport() {
    this.transportEnabled = !this.transportEnabled;
    const indicator = document.getElementById('transport-indicator');
    const button = document.getElementById('toggle-transport');
    
    if (this.transportEnabled) {
      indicator.style.display = 'flex';
      button.textContent = 'üöå –í—ã–∫–ª.';
      this.generateBusRoutes();
      document.getElementById('hint').textContent = '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞';
    } else {
      indicator.style.display = 'none';
      button.textContent = 'üöå';
      this.buses.forEach(bus => this.scene.remove(bus.group));
      this.buses = [];
      document.getElementById('hint').textContent = '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞';
    }
    this.updateTransportDisplay();
  }

  togglePedestrians() {
    this.pedestriansEnabled = !this.pedestriansEnabled;
    const indicator = document.getElementById('pedestrians-indicator');
    const button = document.getElementById('toggle-pedestrians');
    
    if (this.pedestriansEnabled) {
      indicator.style.display = 'flex';
      button.textContent = 'üë• –í—ã–∫–ª.';
      this.spawnInitialPedestrians();
      document.getElementById('hint').textContent = '–ü–µ—à–µ—Ö–æ–¥—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã';
    } else {
      indicator.style.display = 'none';
      button.textContent = 'üë•';
      this.pedestrians.forEach(ped => this.scene.remove(ped.group));
      this.pedestrians = [];
      document.getElementById('hint').textContent = '–ü–µ—à–µ—Ö–æ–¥—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã';
    }
    this.updatePedestriansDisplay();
  }

  generateBusRoutes() {
    this.busRoutes = [];
    
    if (this.busStops.length < 2) {
      document.getElementById('hint').textContent = '–ù—É–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∏–Ω–∏–º—É–º 2 –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞';
      return;
    }

    for (let i = 0; i < this.busStops.length - 1; i++) {
      const start = this.busStops[i];
      const end = this.busStops[i + 1];
      
      this.busRoutes.push({
        start: { x: start.x, z: start.z },
        end: { x: end.x, z: end.z },
        stops: [start, end]
      });
    }

    if (this.busStops.length >= 3) {
      const start = this.busStops[this.busStops.length - 1];
      const end = this.busStops[0];
      this.busRoutes.push({
        start: { x: start.x, z: start.z },
        end: { x: end.x, z: end.z },
        stops: [start, end]
      });
    }

    this.spawnBuses();
  }

  spawnBuses() {
    this.buses.forEach(bus => this.scene.remove(bus.group));
    this.buses = [];

    this.busRoutes.forEach(route => {
      const bus = this.createBus(route.start.x, route.start.z);
      if (bus) {
        bus.route = route;
        bus.progress = 0;
        bus.speed = 0.002 + Math.random() * 0.003;
        bus.waiting = 0;
        this.buses.push(bus);
      }
    });

    this.updateTransportDisplay();
  }

  createBus(x, z) {
    const group = new THREE.Group();
    group.position.set(x, 0.5, z);

    const body = new THREE.Mesh(
      new THREE.BoxGeometry(3, 1.2, 1.5),
      new THREE.MeshLambertMaterial({ color: 0xff0000 })
    );
    body.position.y = 0.6;
    group.add(body);

    const windowMat = new THREE.MeshBasicMaterial({ color: 0x87CEEB });
    const frontWindow = new THREE.Mesh(new THREE.PlaneGeometry(2.8, 0.8), windowMat);
    frontWindow.position.set(0, 1.1, 0.76);
    frontWindow.rotation.x = Math.PI / 2;
    group.add(frontWindow);

    const sideWindows = new THREE.Mesh(new THREE.BoxGeometry(2.8, 0.6, 0.1), windowMat);
    sideWindows.position.set(0, 1.1, 0);
    group.add(sideWindows);

    const wheelMat = new THREE.MeshLambertMaterial({ color: 0x222222 });
    const wheelGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 8);
    wheelGeometry.rotateZ(Math.PI / 2);

    const wheel1 = new THREE.Mesh(wheelGeometry, wheelMat);
    wheel1.position.set(-1, 0.3, 0.8);
    group.add(wheel1);

    const wheel2 = new THREE.Mesh(wheelGeometry, wheelMat);
    wheel2.position.set(1, 0.3, 0.8);
    group.add(wheel2);

    const wheel3 = new THREE.Mesh(wheelGeometry, wheelMat);
    wheel3.position.set(-1, 0.3, -0.8);
    group.add(wheel3);

    const wheel4 = new THREE.Mesh(wheelGeometry, wheelMat);
    wheel4.position.set(1, 0.3, -0.8);
    group.add(wheel4);

    this.scene.add(group);

    return {
      group: group,
      route: null,
      progress: 0,
      speed: 0.003,
      waiting: 0
    };
  }

  createPedestrian(x, z) {
    const group = new THREE.Group();
    group.position.set(x, 0, z);

    const body = new THREE.Mesh(
      new THREE.CylinderGeometry(0.2, 0.2, 1, 8),
      new THREE.MeshLambertMaterial({ color: Math.random() > 0.5 ? 0x2f6fb3 : 0xb32f6f })
    );
    body.position.y = 0.5;
    group.add(body);

    const head = new THREE.Mesh(
      new THREE.SphereGeometry(0.15, 8, 6),
      new THREE.MeshLambertMaterial({ color: 0xffdbac })
    );
    head.position.y = 1.1;
    group.add(head);

    this.scene.add(group);

    let targetX, targetZ;
    if (this.buildings.length > 0 && Math.random() > 0.3) {
      const randomBuilding = this.buildings[Math.floor(Math.random() * this.buildings.length)];
      targetX = randomBuilding.position.x + (Math.random() - 0.5) * 10;
      targetZ = randomBuilding.position.z + (Math.random() - 0.5) * 10;
    } else {
      targetX = x + (Math.random() - 0.5) * 30;
      targetZ = z + (Math.random() - 0.5) * 30;
    }

    return {
      group: group,
      target: { x: targetX, z: targetZ },
      speed: 0.03 + Math.random() * 0.02,
      idleTime: 0
    };
  }

  spawnInitialPedestrians() {
    const residentialBuildings = this.buildings.filter(b => 
      ['khrushchev', 'brezhnev', 'dormitory'].includes(b.userData.type)
    );
    
    residentialBuildings.forEach(building => {
      for (let i = 0; i < 2; i++) {
        const offsetX = (Math.random() - 0.5) * 8;
        const offsetZ = (Math.random() - 0.5) * 8;
        const ped = this.createPedestrian(
          building.position.x + offsetX,
          building.position.z + offsetZ
        );
        if (ped) {
          this.pedestrians.push(ped);
        }
      }
    });
    
    this.updatePedestriansDisplay();
  }

  updateBuses() {
    if (!this.transportEnabled) return;

    this.buses.forEach(bus => {
      if (bus.waiting > 0) {
        bus.waiting--;
        return;
      }

      bus.progress += bus.speed;
      
      if (bus.progress >= 1) {
        bus.progress = 0;
        bus.waiting = 60;
        
        if (Math.random() < 0.3) {
          playSound(SOUND_BUS_HORN, 0.2);
        }
      }

      const route = bus.route;
      const currentX = route.start.x + (route.end.x - route.start.x) * bus.progress;
      const currentZ = route.start.z + (route.end.z - route.start.z) * bus.progress;

      bus.group.position.set(currentX, 0.5, currentZ);
      
      const angle = Math.atan2(route.end.z - route.start.z, route.end.x - route.start.x);
      bus.group.rotation.y = angle;
    });
  }

  updatePedestrians() {
    if (!this.pedestriansEnabled) return;

    this.pedestrians.forEach(pedestrian => {
      if (pedestrian.idleTime > 0) {
        pedestrian.idleTime--;
        return;
      }

      const dx = pedestrian.target.x - pedestrian.group.position.x;
      const dz = pedestrian.target.z - pedestrian.group.position.z;
      const distance = Math.sqrt(dx*dx + dz*dz);

      if (distance < 1) {
        if (this.buildings.length > 0 && Math.random() > 0.3) {
          const randomBuilding = this.buildings[Math.floor(Math.random() * this.buildings.length)];
          pedestrian.target.x = randomBuilding.position.x + (Math.random() - 0.5) * 10;
          pedestrian.target.z = randomBuilding.position.z + (Math.random() - 0.5) * 10;
        } else {
          pedestrian.target.x = pedestrian.group.position.x + (Math.random() - 0.5) * 30;
          pedestrian.target.z = pedestrian.group.position.z + (Math.random() - 0.5) * 30;
        }
        pedestrian.idleTime = 60 + Math.random() * 60;
      } else {
        const moveX = (dx / distance) * pedestrian.speed;
        const moveZ = (dz / distance) * pedestrian.speed;
        
        pedestrian.group.position.x += moveX;
        pedestrian.group.position.z += moveZ;
        
        const angle = Math.atan2(moveZ, moveX);
        pedestrian.group.rotation.y = angle;
      }
    });

    this.pedestrianSpawnTimer++;
    if (this.pedestrianSpawnTimer > 180 && this.pedestrians.length < 50) {
      this.pedestrianSpawnTimer = 0;
      
      const residentialBuildings = this.buildings.filter(b => 
        ['khrushchev', 'brezhnev', 'dormitory'].includes(b.userData.type)
      );
      
      if (residentialBuildings.length > 0 && Math.random() < 0.7) {
        const randomBuilding = residentialBuildings[Math.floor(Math.random() * residentialBuildings.length)];
        const offsetX = (Math.random() - 0.5) * 8;
        const offsetZ = (Math.random() - 0.5) * 8;
        const ped = this.createPedestrian(
          randomBuilding.position.x + offsetX,
          randomBuilding.position.z + offsetZ
        );
        if (ped) {
          this.pedestrians.push(ped);
          this.updatePedestriansDisplay();
        }
      }
    }
  }

  updateTransportDisplay() {
    const transportValue = document.getElementById('transport-value');
    const transportText = document.getElementById('transport-text');
    
    const coverage = this.calculateTransportCoverage();
    transportValue.textContent = coverage + '%';
    transportText.textContent = `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ${this.buses.length}`;
    
    this.stats.transport = coverage;
    this.updateSatisfactionFromTransport();
  }

  updatePedestriansDisplay() {
    const populationValue = document.getElementById('population-value');
    const pedestriansText = document.getElementById('pedestrians-text');
    
    populationValue.textContent = this.pedestrians.length;
    pedestriansText.textContent = `–ü–µ—à–µ—Ö–æ–¥—ã: ${this.pedestrians.length}`;
    
    this.stats.population = this.pedestrians.length;
  }

  calculateTransportCoverage() {
    if (this.busStops.length === 0) return 0;
    
    let coveredBuildings = 0;
    const coverageRadius = 15;
    
    this.buildings.forEach(building => {
      if (building.userData.type === 'khrushchev' || 
          building.userData.type === 'brezhnev' ||
          building.userData.type === 'dormitory') {
        
        for (const stop of this.busStops) {
          const dx = building.userData.cx - stop.x;
          const dz = building.userData.cz - stop.z;
          const distance = Math.sqrt(dx * dx + dz * dz);
          
          if (distance <= coverageRadius) {
            coveredBuildings++;
            break;
          }
        }
      }
    });
    
    const totalResidential = this.buildings.filter(b => 
      ['khrushchev', 'brezhnev', 'dormitory'].includes(b.userData.type)
    ).length;
    
    return totalResidential > 0 ? Math.round((coveredBuildings / totalResidential) * 100) : 0;
  }

  updateSatisfactionFromTransport() {
    const transportBonus = Math.floor(this.stats.transport / 10);
    this.stats.satisfaction = Math.min(100, 75 + transportBonus);
  }

  updateTimeDisplay() {
    const timeIcon = document.getElementById('time-icon');
    const timeText = document.getElementById('time-text');
    const timeButton = document.getElementById('toggle-time');
    
    if (this.isDay) {
      timeIcon.textContent = '‚òÄÔ∏è';
      timeText.textContent = '–î–µ–Ω—å';
      timeButton.textContent = 'üåô';
    } else {
      timeIcon.textContent = 'üåô';
      timeText.textContent = '–ù–æ—á—å';
      timeButton.textContent = '‚òÄÔ∏è';
    }
  }

  updateLighting() {
    if (this.isDay && this.timeTransition > 0) {
      this.timeTransition -= this.timeTransitionSpeed;
    } else if (!this.isDay && this.timeTransition < 1) {
      this.timeTransition += this.timeTransitionSpeed;
    }
    
    this.timeTransition = Math.max(0, Math.min(1, this.timeTransition));
    
    const daySkyColor = new THREE.Color(0xbfe9ff);
    const nightSkyColor = new THREE.Color(0x0a1a2a);
    this.scene.background = daySkyColor.clone().lerp(nightSkyColor, this.timeTransition);
    this.scene.fog.color = daySkyColor.clone().lerp(nightSkyColor, this.timeTransition);
    
    this.sun.intensity = 0.9 * (1 - this.timeTransition);
    this.moon.intensity = 0.3 * this.timeTransition;
    
    this.windowLights.forEach(winMat => {
      winMat.color = new THREE.Color(0xfff2c0).lerp(new THREE.Color(0xffdd00), this.timeTransition);
      winMat.opacity = 0.3 + 0.7 * this.timeTransition;
    });
  }

  setupUI(){
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º–æ–≤
    document.getElementById('camera-mode').addEventListener('click', ()=>{ 
      this.setMode('camera'); 
    });
    
    document.getElementById('build-mode').addEventListener('click', ()=>{ 
      this.setMode('build'); 
    });
    
    document.getElementById('demolish-mode').addEventListener('click', ()=>{ 
      this.setMode('demolish'); 
    });

    document.querySelectorAll('.building-option').forEach(el=>{
      el.addEventListener('click', (e)=>{
        document.querySelectorAll('.building-option').forEach(x=>x.classList.remove('selected'));
        document.querySelectorAll('.building-icon').forEach(x=>x.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        this.selectedType = e.currentTarget.dataset.type;
        
        const correspondingIcon = document.querySelector(`.building-icon[data-type="${this.selectedType}"]`);
        if (correspondingIcon) {
          correspondingIcon.classList.add('selected');
        }
        
        if (this.selectedType === 'road') {
          document.getElementById('hint').textContent = '–î–æ—Ä–æ–≥–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü';
        } else {
          document.getElementById('hint').textContent = '–í—ã–±—Ä–∞–Ω–æ: ' + this.selectedType;
        }
        
        this.removeRoadPreview();
        this.roadBuildingStart = null;
      });
    });

    document.getElementById('rot-left').addEventListener('click', ()=>{ this.rotationAngle = (this.rotationAngle - 15) % 360; document.getElementById('rotate-angle').textContent = this.rotationAngle + '¬∞'; playSound(SOUND_CLICK,0.45) });
    document.getElementById('rot-right').addEventListener('click', ()=>{ this.rotationAngle = (this.rotationAngle + 15) % 360; document.getElementById('rotate-angle').textContent = this.rotationAngle + '¬∞'; playSound(SOUND_CLICK,0.45) });

    document.getElementById('clear-all').addEventListener('click', ()=>{
      this.clearCity();
      playSound(SOUND_CLICK,0.4);
      this.updateUI();
      this.updateTransportDisplay();
      this.updatePedestriansDisplay();
    });

    document.getElementById('center-camera').addEventListener('click', ()=>{
      this.controls.reset();
      this.camera.position.set(50,40,60);
      this.controls.update();
      playSound(SOUND_CLICK,0.4);
    });

    document.getElementById('toggle-menu').addEventListener('click', ()=>{
      document.getElementById('control-panel').classList.toggle('active');
      document.getElementById('control-panel').classList.toggle('hidden');
      playSound(SOUND_CLICK,0.4);
    });

    document.getElementById('secret-mode').addEventListener('click', ()=>{
      const sf = document.getElementById('secret-filter');
      sf.style.display = (sf.style.display === 'block') ? 'none' : 'block';
      playSound(SOUND_CLICK,0.4);
    });

    document.getElementById('toggle-time').addEventListener('click', ()=>{
      this.toggleTimeOfDay();
    });

    document.getElementById('toggle-transport').addEventListener('click', ()=>{
      this.toggleTransport();
    });

    document.getElementById('toggle-pedestrians').addEventListener('click', ()=>{
      this.togglePedestrians();
    });

    this.modalBack = document.getElementById('modal-back');
    this.modal = document.getElementById('modal');
    this.modalConfirm = document.getElementById('modal-confirm');
    this.modalCancel = document.getElementById('modal-cancel');
    this.pendingPlace = null;

    this.modalCancel.addEventListener('click', ()=>{ this.closeModal(false); playSound(SOUND_ERROR,0.5) });
    this.modalConfirm.addEventListener('click', ()=>{ this.closeModal(true); playSound(SOUND_CONFIRM,0.6) });

    const canvas = this.renderer.domElement;
    canvas.addEventListener('mousemove', (e)=>this.onPointerMove(e));
    canvas.addEventListener('click', (e)=>this.onPointerClick(e));
    canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); const t = e.touches[0]; this.onPointerClick({clientX:t.clientX, clientY:t.clientY}); }, {passive:false});
    canvas.addEventListener('touchmove', (e)=>{ e.preventDefault(); const t = e.touches[0]; this.onPointerMove({clientX:t.clientX, clientY:t.clientY}); }, {passive:false});
  }

  setMode(mode) {
    this.mode = mode;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    document.getElementById('camera-mode').classList.remove('active');
    document.getElementById('build-mode').classList.remove('active');
    document.getElementById('demolish-mode').classList.remove('active');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
    document.getElementById(mode + '-mode').classList.add('active');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    switch(mode) {
      case 'camera':
        document.getElementById('hint').textContent = '–†–µ–∂–∏–º –∫–∞–º–µ—Ä—ã: –≤—Ä–∞—â–∞–π—Ç–µ –∏ –ø–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –∫–∞–º–µ—Ä—É';
        this.placementHelper.visible = false;
        document.getElementById('placement-indicator').style.display = 'none';
        this.removeRoadPreview();
        this.roadBuildingStart = null;
        break;
      case 'build':
        document.getElementById('hint').textContent = '–†–µ–∂–∏–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–π–∫–∏';
        break;
      case 'demolish':
        document.getElementById('hint').textContent = '–†–µ–∂–∏–º —Å–Ω–æ—Å–∞: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –æ–±—ä–µ–∫—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è';
        this.placementHelper.visible = false;
        document.getElementById('placement-indicator').style.display = 'none';
        this.removeRoadPreview();
        this.roadBuildingStart = null;
        break;
    }
    
    playSound(SOUND_CLICK, 0.4);
  }

  clearCity() {
    for (const b of this.buildings) this.scene.remove(b);
    for (const r of this.roads) this.scene.remove(r.mesh);
    for (const bus of this.buses) this.scene.remove(bus.group);
    for (const stop of this.busStops) this.scene.remove(stop.group);
    for (const ped of this.pedestrians) this.scene.remove(ped.group);
    this.buildings = []; this.roads = []; this.growing = []; this.smoke = [];
    this.buses = []; this.busStops = []; this.busRoutes = [];
    this.pedestrians = [];
    this.windowLights = [];
    this.stats = { housing:0, infra:0, satisfaction:75, year:1985, transport:0, population:0 };
  }

  generateRandomCity() {
    this.clearCity();
    
    // –°–µ—Ç–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ - –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –≥–ª–∞–≤–Ω—ã–º–∏ –∏ –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–º–∏ –¥–æ—Ä–æ–≥–∞–º–∏
    const mainRoads = [
      {x1: -80, z1: 0, x2: 80, z2: 0},  // –ì–ª–∞–≤–Ω–∞—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –¥–æ—Ä–æ–≥–∞
      {x1: 0, z1: -80, x2: 0, z2: 80},  // –ì–ª–∞–≤–Ω–∞—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –¥–æ—Ä–æ–≥–∞
      
      // –í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –¥–æ—Ä–æ–≥–∏
      {x1: -60, z1: -60, x2: -60, z2: 60},
      {x1: 60, z1: -60, x2: 60, z2: 60},
      {x1: -60, z1: -60, x2: 60, z2: -60},
      {x1: -60, z1: 60, x2: 60, z2: 60},
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ—Ä–æ–≥–∏ –¥–ª—è –ª—É—á—à–µ–π —Å–≤—è–∑–Ω–æ—Å—Ç–∏
      {x1: -30, z1: -60, x2: -30, z2: 60},
      {x1: 30, z1: -60, x2: 30, z2: 60},
      {x1: -60, z1: -30, x2: 60, z2: -30},
      {x1: -60, z1: 30, x2: 60, z2: 30}
    ];
    
    // –°—Ç—Ä–æ–∏–º –≤—Å–µ –¥–æ—Ä–æ–≥–∏
    mainRoads.forEach(road => {
      this.buildRoadLine(road.x1, road.z1, road.x2, road.z2);
    });
    
    // –ó–¥–∞–Ω–∏—è - —Ä–∞–∑–º–µ—â–∞–µ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≥–æ—Ä–æ–¥—Å–∫–æ–π —Å–µ—Ç–∫–æ–π
    const buildingTypes = ['khrushchev', 'brezhnev', 'dormitory', 'school', 'hospital', 'factory', 'park', 'busstop'];
    const buildingPositions = [
      // –ö–≤–∞—Ä—Ç–∞–ª 1 (—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥)
      {x: -45, z: 45, type: 'khrushchev'},
      {x: -45, z: 35, type: 'khrushchev'},
      {x: -35, z: 45, type: 'brezhnev'},
      {x: -35, z: 35, type: 'school'},
      {x: -25, z: 45, type: 'park'},
      
      // –ö–≤–∞—Ä—Ç–∞–ª 2 (—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫)
      {x: 25, z: 45, type: 'brezhnev'},
      {x: 35, z: 45, type: 'khrushchev'},
      {x: 45, z: 45, type: 'hospital'},
      {x: 35, z: 35, type: 'dormitory'},
      {x: 45, z: 35, type: 'park'},
      
      // –ö–≤–∞—Ä—Ç–∞–ª 3 (—é–≥–æ-–∑–∞–ø–∞–¥)
      {x: -45, z: -25, type: 'factory'},
      {x: -35, z: -25, type: 'khrushchev'},
      {x: -25, z: -25, type: 'brezhnev'},
      {x: -45, z: -35, type: 'dormitory'},
      {x: -35, z: -35, type: 'school'},
      
      // –ö–≤–∞—Ä—Ç–∞–ª 4 (—é–≥–æ-–≤–æ—Å—Ç–æ–∫)
      {x: 25, z: -25, type: 'brezhnev'},
      {x: 35, z: -25, type: 'khrushchev'},
      {x: 45, z: -25, type: 'hospital'},
      {x: 35, z: -35, type: 'dormitory'},
      {x: 45, z: -35, type: 'park'},
      
      // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ —Ä–∞–π–æ–Ω—ã
      {x: -15, z: 15, type: 'park'},
      {x: 15, z: 15, type: 'school'},
      {x: -15, z: -15, type: 'hospital'},
      {x: 15, z: -15, type: 'park'},
      
      // –ê–≤—Ç–æ–±—É—Å–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Å—Ç–∞—Ö
      {x: -50, z: 0, type: 'busstop'},
      {x: 50, z: 0, type: 'busstop'},
      {x: 0, z: -50, type: 'busstop'},
      {x: 0, z: 50, type: 'busstop'},
      {x: -30, z: 30, type: 'busstop'},
      {x: 30, z: 30, type: 'busstop'},
      {x: -30, z: -30, type: 'busstop'},
      {x: 30, z: -30, type: 'busstop'}
    ];
    
    // –°–æ–∑–¥–∞–µ–º –∑–¥–∞–Ω–∏—è
    buildingPositions.forEach(pos => {
      const building = this.createBuilding(pos.type, pos.x, pos.z);
      if (building) {
        // –°–ª—É—á–∞–π–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
        building.rotation.y = THREE.MathUtils.degToRad(Math.floor(Math.random() * 4) * 90);
      }
    });
    
    // –í–∫–ª—é—á–∞–µ–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ø–µ—à–µ—Ö–æ–¥–æ–≤
    this.transportEnabled = true;
    this.pedestriansEnabled = true;
    
    const transportIndicator = document.getElementById('transport-indicator');
    const transportButton = document.getElementById('toggle-transport');
    const pedestriansIndicator = document.getElementById('pedestrians-indicator');
    const pedestriansButton = document.getElementById('toggle-pedestrians');
    
    transportIndicator.style.display = 'flex';
    transportButton.textContent = 'üöå –í—ã–∫–ª.';
    pedestriansIndicator.style.display = 'flex';
    pedestriansButton.textContent = 'üë• –í—ã–∫–ª.';
    
    this.generateBusRoutes();
    this.spawnInitialPedestrians();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞
    this.setMode('camera');
    
    document.getElementById('hint').textContent = '–ì–æ—Ç–æ–≤—ã–π –≥–æ—Ä–æ–¥ –ø–æ—Å—Ç—Ä–æ–µ–Ω! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∂–∏–º –∫–∞–º–µ—Ä—ã –¥–ª—è –æ—Å–º–æ—Ç—Ä–∞.';
    
    playSound(SOUND_CONFIRM, 0.7);
  }

  showModalForPlace(obj){
    this.pendingPlace = obj;
    const title = `–ü–æ—Å—Ç–∞–≤–∏—Ç—å: ${obj.type}`;
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-desc').textContent = `–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ${obj.type} –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Å—Ç–µ?`;
    this.modalBack.classList.add('show');
    this.modal.classList.add('show');
    playSound(SOUND_CLICK,0.35);
  }
  
  closeModal(confirm){
    this.modalBack.classList.remove('show');
    this.modal.classList.remove('show');
    
    if (confirm && this.pendingPlace){
      const p = this.pendingPlace;
      if (p.type === 'road'){
        this.buildRoadLine(p.x1,p.z1,p.x2,p.z2);
      } else {
        const building = this.createBuilding(p.type, p.x, p.z);
        if (building) {
          building.rotation.y = THREE.MathUtils.degToRad(this.rotationAngle);
        }
      }
    }
    this.pendingPlace = null;
  }

  onPointerMove(event){
    // –í —Ä–µ–∂–∏–º–µ –∫–∞–º–µ—Ä—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
    if (this.mode === 'camera') {
      this.placementHelper.visible = false;
      document.getElementById('placement-indicator').style.display = 'none';
      this.removeRoadPreview();
      return;
    }

    const rect = this.renderer.domElement.getBoundingClientRect();
    const clientX = event.clientX, clientY = event.clientY;
    this.pointerX = clientX; this.pointerY = clientY;
    this.mouse = new THREE.Vector2(((clientX - rect.left) / rect.width) * 2 - 1, -((clientY - rect.top) / rect.height) * 2 + 1);
    this.raycaster.setFromCamera(this.mouse, this.camera);

    if (this.mode === 'build'){
      const hits = this.raycaster.intersectObject(this.ground);
      if (hits.length > 0){
        const p = hits[0].point;
        
        if (this.selectedType === 'road' && this.roadBuildingStart) {
          this.updateRoadPreview(this.roadBuildingStart.x, this.roadBuildingStart.z, p.x, p.z);
        } else {
          this.removeRoadPreview();
        }
        
        this.placementHelper.position.set(p.x, 0.01, p.z);
        this.placementHelper.visible = true;
        const radius = this.footprint(this.selectedType);
        const blocked = this.checkCollision(p.x, p.z, radius);
        const ind = document.getElementById('placement-indicator');
        ind.style.display = 'block';
        ind.style.left = clientX + 'px';
        ind.style.top = clientY + 'px';
        ind.style.borderColor = blocked ? 'rgba(200,20,20,0.75)' : 'rgba(0,150,0,0.6)';
        ind.style.boxShadow = blocked ? '0 6px 18px rgba(200,20,20,0.15)' : '0 6px 18px rgba(0,150,0,0.12)';
      } else {
        this.placementHelper.visible = false;
        document.getElementById('placement-indicator').style.display = 'none';
      }
    } else {
      this.placementHelper.visible = false;
      document.getElementById('placement-indicator').style.display = 'none';
      this.removeRoadPreview();
    }
  }

  onPointerClick(event){
    // –í —Ä–µ–∂–∏–º–µ –∫–∞–º–µ—Ä—ã –∫–ª–∏–∫–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞/—Å–Ω–æ—Å–∞
    if (this.mode === 'camera') {
      return;
    }

    const rect = this.renderer.domElement.getBoundingClientRect();
    const clientX = event.clientX, clientY = event.clientY;
    this.mouse = new THREE.Vector2(((clientX - rect.left) / rect.width) * 2 - 1, -((clientY - rect.top) / rect.height) * 2 + 1);
    this.raycaster.setFromCamera(this.mouse, this.camera);

    if (this.mode === 'demolish'){
      const intersects = this.raycaster.intersectObjects(this.buildings, true);
      if (intersects.length > 0){
        let obj = intersects[0].object;
        while (obj && obj.type !== 'Group' && obj.parent) obj = obj.parent;
        if (obj && obj.type === 'Group'){
          this.removeBuilding(obj);
          playSound(SOUND_DEMOLISH, 0.6);
          document.getElementById('hint').textContent = '–ó–¥–∞–Ω–∏–µ —Å–Ω–µ—Å–µ–Ω–æ';
        }
      } else {
        const roadHits = [];
        for (const r of this.roads){
          const screenPos = this.worldToScreen(new THREE.Vector3(r.x,0,r.z));
          const dx = screenPos.x - clientX, dy = screenPos.y - clientY;
          if (Math.hypot(dx,dy) < 20) roadHits.push(r);
        }
        if (roadHits.length>0){
          const r = roadHits[0];
          this.scene.remove(r.mesh);
          this.roads.splice(this.roads.indexOf(r),1);
          playSound(SOUND_DEMOLISH,0.5);
          document.getElementById('hint').textContent = '–î–æ—Ä–æ–∂–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç —É–¥–∞–ª—ë–Ω';
        } else {
          document.getElementById('hint').textContent = '–¢–∞–ø–Ω–∏ –ø–æ –æ–±—ä–µ–∫—Ç—É –¥–ª—è —Å–Ω–æ—Å–∞';
        }
      }
      return;
    }

    const hits = this.raycaster.intersectObject(this.ground);
    if (hits.length === 0) return;
    const p = hits[0].point;

    if (this.selectedType === 'road'){
      if (!this.roadBuildingStart){
        this.roadBuildingStart = {x:p.x, z:p.z};
        document.getElementById('hint').textContent = '–î–æ—Ä–æ–≥–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–µ—Ü (—Ç–∞–ø–Ω–∏—Ç–µ —Å–Ω–æ–≤–∞)';
        playSound(SOUND_CLICK,0.35);
      } else {
        this.buildRoadLine(this.roadBuildingStart.x, this.roadBuildingStart.z, p.x, p.z);
        this.roadBuildingStart = null;
        this.removeRoadPreview();
        document.getElementById('hint').textContent = '–î–æ—Ä–æ–≥–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞';
      }
      return;
    }

    const radius = this.footprint(this.selectedType);
    if (this.checkCollision(p.x, p.z, radius)){
      document.getElementById('hint').textContent = '–ù–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –∑–¥–µ—Å—å ‚Äî –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ';
      playSound(SOUND_ERROR, 0.6);
      return;
    }

    this.showModalForPlace({type:this.selectedType, x:p.x, z:p.z, rot:this.rotationAngle});
  }

  worldToScreen(v){
    const width = this.renderer.domElement.clientWidth, height = this.renderer.domElement.clientHeight;
    const proj = v.clone().project(this.camera);
    return { x: (proj.x+1) * 0.5 * width + this.renderer.domElement.getBoundingClientRect().left, y: (-proj.y+1) * 0.5 * height + this.renderer.domElement.getBoundingClientRect().top };
  }

  removeBuilding(group){
    const busStopIndex = this.busStops.findIndex(stop => stop.group === group);
    if (busStopIndex !== -1) {
      this.busStops.splice(busStopIndex, 1);
      if (this.transportEnabled) {
        this.generateBusRoutes();
      }
    }

    this.scene.remove(group);
    const idx = this.buildings.indexOf(group);
    if (idx>=0) this.buildings.splice(idx,1);
    const gi = this.growing.indexOf(group);
    if (gi>=0) this.growing.splice(gi,1);
    this.updateStatsOnDemolition(group.userData.type);
    playSound(SOUND_DEMOLISH, 0.6);
    this.updateUI();
    this.updateTransportDisplay();
  }

  updateStats(type){
    switch(type){
      case 'khrushchev': case 'brezhnev': case 'dormitory':
        this.stats.housing += 10; this.stats.satisfaction = Math.min(100,this.stats.satisfaction+1); break;
      case 'school': case 'hospital':
        this.stats.infra += 1; this.stats.satisfaction = Math.min(100,this.stats.satisfaction+2); break;
      case 'busstop':
        this.stats.infra += 1; break;
      case 'park': this.stats.satisfaction = Math.min(100,this.stats.satisfaction+3); break;
      case 'factory': this.stats.satisfaction = Math.max(0,this.stats.satisfaction-2); break;
    }
  }
  updateStatsOnDemolition(type){
    switch(type){
      case 'khrushchev': case 'brezhnev': case 'dormitory':
        this.stats.housing = Math.max(0,this.stats.housing-10); this.stats.satisfaction = Math.max(0,this.stats.satisfaction-1); break;
      case 'school': case 'hospital':
        this.stats.infra = Math.max(0,this.stats.infra-1); this.stats.satisfaction = Math.max(0,this.stats.satisfaction-2); break;
      case 'busstop':
        this.stats.infra = Math.max(0,this.stats.infra-1); break;
      case 'factory': this.stats.satisfaction = Math.min(100,this.stats.satisfaction+3); break;
    }
  }

  updateUI(){
    document.getElementById('housing-value').textContent = Math.max(0, this.stats.housing);
    document.getElementById('infra-value').textContent = Math.max(0, this.stats.infra);
    document.getElementById('satisfaction-value').textContent = this.stats.satisfaction + '%';
    document.getElementById('year-display').textContent = Math.floor(this.stats.year);
  }

  onResize(){
    const container = document.getElementById('game3d');
    this.camera.aspect = container.clientWidth / container.clientHeight;
    this.camera.updateProjectionMatrix();
    this.renderer.setSize(container.clientWidth, container.clientHeight);
  }

  animate(){
    requestAnimationFrame(()=>this.animate());
    const now = performance.now();

    this.stats.year += 0.001;

    this.updateLighting();

    this.updateBuses();

    this.updatePedestrians();

    for (let i=this.growing.length-1;i>=0;i--){
      const g = this.growing[i];
      const elapsed = now - g.userData.growthStart;
      const t = Math.min(1, elapsed / g.userData.growthDuration);
      const ease = 1 - Math.pow(1 - t, 3);
      g.scale.y = Math.max(0.02, ease);
      if (t>=1){
        g.scale.y = 1; this.growing.splice(i,1);
        if (g.userData.type === 'factory'){
          const chimney = g.getObjectByName('chimneyTop');
          if (chimney){
            const wp = new THREE.Vector3(); chimney.getWorldPosition(wp);
            this.spawnSmokeAt(wp);
          }
        }
      }
    }

    for (let i=this.smoke.length-1;i>=0;i--){
      const p = this.smoke[i];
      const age = now - p.born; const ratio = age / p.life;
      if (ratio >= 1){ this.scene.remove(p.mesh); this.smoke.splice(i,1); continue; }
      const wind = this.wind;
      p.mesh.position.addScaledVector(new THREE.Vector3(p.vel.x + wind.x, p.vel.y + wind.y, p.vel.z + wind.z), 1.0 * (1 + ratio*0.5));
      const s = 2.2 * (1 + ratio*0.5);
      p.mesh.scale.set(s,s,1); p.mesh.material.opacity = 0.9 * (1 - ratio);
    }

    if (!this._lastSmoke || now - this._lastSmoke > 900){
      this._lastSmoke = now;
      for (const b of this.buildings){
        if (b.userData.type === 'factory' && Math.random() > 0.35){
          const chimney = b.getObjectByName('chimneyTop');
          if (chimney){
            const wp = new THREE.Vector3(); chimney.getWorldPosition(wp);
            this.spawnSmokeAt(wp);
          }
        }
      }
    }

    this.controls.update();
    this.renderer.render(this.scene, this.camera);

    this.updateUI();
  }

  setupClouds(){
    const cloud1 = document.getElementById('cloud1'), cloud2 = document.getElementById('cloud2');
    function makeCloudSVG(w,h,fill='rgba(255,255,255,0.9)'){
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><g fill='${fill}'><ellipse cx='40' cy='30' rx='40' ry='20'/><ellipse cx='80' cy='30' rx='30' ry='18'/><ellipse cx='120' cy='30' rx='28' ry='16'/></g></svg>`;
      return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
    }
    cloud1.src = makeCloudSVG(260,80);
    cloud2.src = makeCloudSVG(200,70);
    let t = 0;
    const move = ()=>{ t+=0.2; cloud1.style.left = (20 + Math.sin(t/40)*40) + 'px'; cloud2.style.right = (60 + Math.cos(t/30)*30) + 'px'; requestAnimationFrame(move); };
    move();
  }
}

// ======================
// Start Screen Logic
// ======================
let gameInstance = null;

document.addEventListener('DOMContentLoaded', function() {
  const startScreen = document.getElementById('start-screen');
  const startBtn = document.getElementById('start-btn');
  const readyCityBtn = document.getElementById('ready-city-btn');
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const controlPanel = document.getElementById('control-panel');
  
  startBtn.addEventListener('click', function() {
    startScreen.style.opacity = '0';
    startScreen.style.transition = 'opacity 0.5s ease';
    
    setTimeout(function() {
      startScreen.style.display = 'none';
      initializeGame();
    }, 500);
  });

  readyCityBtn.addEventListener('click', function() {
    startScreen.style.opacity = '0';
    startScreen.style.transition = 'opacity 0.5s ease';
    
    setTimeout(function() {
      startScreen.style.display = 'none';
      initializeGame();
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–π –≥–æ—Ä–æ–¥ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–≥—Ä—ã
      setTimeout(function() {
        if (gameInstance) {
          gameInstance.generateRandomCity();
        }
      }, 100);
    }, 500);
  });

  function initializeGame() {
    gameInstance = new SovietCityGame();
    
    mobileMenuToggle.addEventListener('click', function() {
      controlPanel.classList.toggle('active');
    });
    
    document.addEventListener('click', function(event) {
      if (window.innerWidth <= 700) {
        const isClickInsidePanel = controlPanel.contains(event.target);
        const isClickOnToggle = mobileMenuToggle.contains(event.target);
        
        if (!isClickInsidePanel && !isClickOnToggle && controlPanel.classList.contains('active')) {
          controlPanel.classList.remove('active');
        }
      }
    });
    
    document.querySelectorAll('.building-icon').forEach(icon => {
      icon.addEventListener('click', function() {
        document.querySelectorAll('.building-icon').forEach(i => i.classList.remove('selected'));
        document.querySelectorAll('.building-option').forEach(i => i.classList.remove('selected'));
        
        this.classList.add('selected');
        
        const type = this.dataset.type;
        const correspondingOption = document.querySelector(`.building-option[data-type="${type}"]`);
        if (correspondingOption) {
          correspondingOption.classList.add('selected');
        }
        
        if (gameInstance) {
          gameInstance.selectedType = type;
          if (type === 'road') {
            document.getElementById('hint').textContent = '–î–æ—Ä–æ–≥–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü';
          } else {
            document.getElementById('hint').textContent = '–í—ã–±—Ä–∞–Ω–æ: ' + type;
          }
          
          gameInstance.removeRoadPreview();
          gameInstance.roadBuildingStart = null;
        }
        
        if (window.innerWidth <= 700) {
          controlPanel.classList.remove('active');
        }
      });
    });
  }
});
</script>
</body>
</html>