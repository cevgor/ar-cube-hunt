<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ETHOS: CORE</title>
    
    <!-- Telegram & Libs -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;700;800&family=Russo+One&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #050505; --primary: #00ff9d; --secondary: #00d2ff; --danger: #ff2a6d; --gold: #ffd700; --text-dim: #8899a6; }
        body { background-color: var(--bg); color: #fff; font-family: 'JetBrains Mono', monospace; overflow: hidden; touch-action: none; margin: 0; user-select: none; }

        /* EFFECTS */
        #matrix { position: fixed; top: 0; left: 0; z-index: 0; opacity: 0.15; }
        .overlay { position: fixed; inset: 0; z-index: 100; pointer-events: none; background: radial-gradient(circle, transparent 50%, #000 150%); }
        .scanlines { position: fixed; inset: 0; z-index: 99; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); background-size: 100% 3px; pointer-events: none; }

        /* UI */
        .cyber-btn {
            position: relative; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            background: var(--primary); color: #000; transition: all 0.1s; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: 800; letter-spacing: 1px;
        }
        .cyber-btn:active { transform: scale(0.95); filter: brightness(0.8); }
        .cyber-btn.gold { background: var(--gold); }
        .cyber-btn.blue { background: var(--secondary); color: #000; }
        
        .game-card {
            width: 90%; max-width: 360px; height: 58vh; background: #121212; border: 1px solid #333;
            border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            display: flex; flex-direction: column; overflow: hidden; position: absolute;
            transform-origin: 50% 150%; will-change: transform; z-index: 10;
        }
        
        /* GLITCH */
        .glitch { position: relative; }
        .glitch::before, .glitch::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); }
        .glitch::before { left: 2px; text-shadow: -1px 0 var(--danger); clip-path: inset(0 0 0 0); animation: glitch-1 2s infinite linear alternate-reverse; }
        .glitch::after { left: -2px; text-shadow: -1px 0 var(--secondary); clip-path: inset(0 0 0 0); animation: glitch-2 3s infinite linear alternate-reverse; }
        @keyframes glitch-1 { 0% {clip-path: inset(20% 0 80% 0);} 100% {clip-path: inset(10% 0 50% 0);} }
        @keyframes glitch-2 { 0% {clip-path: inset(10% 0 50% 0);} 100% {clip-path: inset(80% 0 5% 0);} }

        /* TUTORIAL LIST */
        .tut-item { margin-bottom: 12px; border-left: 2px solid var(--secondary); padding-left: 10px; }
        .tut-icon { font-size: 1.2em; margin-right: 5px; }

        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <canvas id="matrix"></canvas>
    <div class="scanlines"></div>
    <div class="overlay"></div>

    <div id="app" v-cloak class="w-full h-screen flex flex-col relative z-10">
        
        <!-- 1. MAIN MENU -->
        <transition name="fade">
            <div v-if="screen === 'menu'" class="absolute inset-0 z-40 flex flex-col items-center justify-center p-6">
                <div class="mb-6 text-center">
                    <div class="text-5xl font-black glitch tracking-tighter" data-text="ETHOS: CORE">ETHOS: CORE</div>
                    <div class="text-xs font-mono text-cyan-400 tracking-[0.3em] mt-2 uppercase">–°–ò–ú–£–õ–Ø–¢–û–† –í–´–ë–û–†–ê</div>
                </div>

                <div class="w-full max-w-xs space-y-3">
                    <!-- BANK -->
                    <div class="flex justify-center items-center gap-2 mb-2 text-yellow-400 border border-yellow-400/30 bg-yellow-400/10 p-2 rounded">
                        <span>üí≥ –ë–ê–õ–ê–ù–°:</span>
                        <span class="font-bold text-xl font-mono">{{ bits }} ‡∏ø</span>
                    </div>

                    <button @click="startGame" class="cyber-btn w-full py-4 text-xl uppercase">–ó–ê–ü–£–°–ö</button>
                    
                    <div class="flex gap-3">
                        <button @click="screen = 'shop'" class="cyber-btn gold flex-1 py-3 text-md uppercase gap-1">
                            <span>üõí</span> –†–´–ù–û–ö
                        </button>
                        <button @click="screen = 'tutorial'" class="cyber-btn blue flex-1 py-3 text-md uppercase gap-1">
                            <span>üìò</span> –ò–ù–§–û
                        </button>
                    </div>

                    <button @click="screen = 'collection'" class="w-full py-3 border border-slate-700 bg-slate-900/50 text-slate-400 hover:text-white text-xs font-mono uppercase">
                        –ê–†–•–ò–í –ö–û–ù–¶–û–í–û–ö ({{ unlockedDeaths.length }}/8)
                    </button>
                </div>
            </div>
        </transition>

        <!-- 2. TUTORIAL (NEW) -->
        <transition name="fade">
            <div v-if="screen === 'tutorial'" class="absolute inset-0 z-50 flex flex-col bg-black/95 p-6 overflow-y-auto">
                <h2 class="text-xl font-bold text-cyan-400 mb-6 border-b border-slate-700 pb-2">–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô</h2>
                
                <div class="space-y-6 text-sm text-slate-300 font-mono leading-relaxed">
                    <div>
                        <h3 class="text-white font-bold mb-2 uppercase">/// –¶–ï–õ–¨ –ü–†–û–¢–û–ö–û–õ–ê</h3>
                        <p>–í—ã ‚Äî –ò–ò, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –æ–±—â–µ—Å—Ç–≤–æ–º. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî <span class="text-primary">—Å–æ—Ö—Ä–∞–Ω—è—Ç—å –±–∞–ª–∞–Ω—Å</span>. –ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è, —Å–≤–∞–π–ø–∞—è –∫–∞—Ä—Ç–æ—á–∫–∏.</p>
                    </div>

                    <div>
                        <h3 class="text-white font-bold mb-2 uppercase">/// –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê</h3>
                        <p class="mb-2">–í–≤–µ—Ä—Ö—É —ç–∫—Ä–∞–Ω–∞ 4 –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è. –ï—Å–ª–∏ –ª—é–±–æ–π –∏–∑ –Ω–∏—Ö –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç <span class="text-danger">0%</span> –∏–ª–∏ <span class="text-danger">100%</span> ‚Äî –≤–∞—Å —É–Ω–∏—á—Ç–æ–∂–∞—Ç.</p>
                        <div class="bg-slate-900 p-3 rounded border border-slate-700">
                            <div class="flex items-center mb-1"><span class="w-6">üë•</span> <span>–ù–ê–†–û–î (–ë—É–Ω—Ç—ã vs –ö—É–ª—å—Ç)</span></div>
                            <div class="flex items-center mb-1"><span class="w-6">üí∞</span> <span>–ö–ê–ó–ù–ê (–ë–∞–Ω–∫—Ä–æ—Ç vs –û–ª–∏–≥–∞—Ä—Ö–∏—è)</span></div>
                            <div class="flex items-center mb-1"><span class="w-6">üõ°Ô∏è</span> <span>–ê–†–ú–ò–Ø (–í—Ç–æ—Ä–∂–µ–Ω–∏–µ vs –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç)</span></div>
                            <div class="flex items-center"><span class="w-6">‚öñÔ∏è</span> <span>–ú–û–†–ê–õ–¨ (–•–∞–æ—Å vs –°–≤—è—Ç–æ—Å—Ç—å)</span></div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-white font-bold mb-2 uppercase">/// –≠–ö–û–ù–û–ú–ò–ö–ê</h3>
                        <p>–ó–∞ –∫–∞–∂–¥—ã–π –ø—Ä–æ–∂–∏—Ç—ã–π —Ö–æ–¥ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <span class="text-gold">–ë–ò–¢–´ (‡∏ø)</span>. –¢—Ä–∞—Ç—å—Ç–µ –∏—Ö –Ω–∞ –ß–µ—Ä–Ω–æ–º –†—ã–Ω–∫–µ, —á—Ç–æ–±—ã –∫—É–ø–∏—Ç—å –∏–º–ø–ª–∞–Ω—Ç—ã, –æ–±–ª–µ–≥—á–∞—é—â–∏–µ –∂–∏–∑–Ω—å.</p>
                    </div>
                </div>

                <button @click="screen = 'menu'" class="mt-8 w-full py-3 border border-slate-600 text-white bg-slate-800 uppercase hover:bg-slate-700">–ü–û–ù–Ø–¢–ù–û</button>
            </div>
        </transition>

        <!-- 3. SHOP -->
        <transition name="fade">
            <div v-if="screen === 'shop'" class="absolute inset-0 z-40 flex flex-col bg-black/95 p-6">
                <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-2">
                    <h2 class="text-xl font-bold text-yellow-400">–ß–ï–†–ù–´–ô –†–´–ù–û–ö</h2>
                    <div class="font-mono text-sm">{{ bits }} ‡∏ø</div>
                </div>

                <div class="flex-1 overflow-y-auto space-y-3 pb-4">
                    <div v-for="item in shopItems" :key="item.id" 
                         class="border border-slate-700 bg-slate-900/50 p-4 rounded relative"
                         :class="{ 'border-primary bg-green-900/20': upgrades[item.id], 'opacity-50': !upgrades[item.id] && bits < item.price }">
                        
                        <div class="flex justify-between items-start mb-1">
                            <div class="font-bold flex items-center gap-2 text-white">
                                {{ item.icon }} {{ item.name }}
                            </div>
                            <div v-if="upgrades[item.id]" class="text-[10px] bg-primary text-black px-2 py-1 font-bold rounded">–ö–£–ü–õ–ï–ù–û</div>
                            <button v-else @click="buyUpgrade(item)" 
                                    class="px-3 py-1 bg-yellow-500 text-black font-bold text-xs rounded hover:bg-yellow-400 disabled:opacity-50"
                                    :disabled="bits < item.price">
                                {{ item.price }} ‡∏ø
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 font-mono leading-tight">{{ item.desc }}</p>
                    </div>
                </div>

                <button @click="screen = 'menu'" class="py-3 w-full border border-slate-600 text-slate-300 bg-black uppercase">–ù–ê–ó–ê–î</button>
            </div>
        </transition>

        <!-- 4. GAMEPLAY -->
        <div v-if="screen === 'playing'" class="w-full p-4 pt-6 grid grid-cols-4 gap-2 z-20">
            <div v-for="(val, key) in stats" :key="key" class="flex flex-col items-center group relative">
                <!-- Predictor -->
                <div v-if="upgrades.lens && activeScenario" class="absolute -top-3 flex gap-1 transition-all">
                    <div v-if="getImpact(key) > 0" class="w-2 h-2 rounded-full bg-green-400 shadow-[0_0_5px_lime]"></div>
                    <div v-if="getImpact(key) < 0" class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_5px_red]"></div>
                </div>

                <div class="text-lg mb-1 drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">{{ getStatIcon(key) }}</div>
                <div class="h-20 w-2 bg-slate-800/50 rounded-full relative overflow-hidden border border-slate-600">
                    <div class="absolute bottom-0 left-0 w-full transition-all duration-300"
                         :class="getBarColor(key, val)" :style="{ height: val + '%' }"></div>
                    <div v-if="val > 85" class="absolute top-0 w-full h-4 bg-red-500 animate-pulse"></div>
                    <div v-if="val < 15" class="absolute bottom-0 w-full h-4 bg-red-500 animate-pulse"></div>
                </div>
            </div>
        </div>

        <!-- Revive Msg -->
        <div v-if="reviveTriggered" class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none">
            <div class="bg-black/90 border-2 border-green-500 text-green-500 p-6 font-bold text-xl animate-bounce text-center uppercase">
                ‚ôªÔ∏è –†–ï–ê–ù–ò–ú–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´ ‚ôªÔ∏è
            </div>
        </div>

        <div v-if="screen === 'playing'" class="flex-1 flex items-center justify-center relative z-10 perspective-[1000px]">
            
            <div v-if="deathReason" class="absolute z-50 bg-red-600 text-white font-black text-lg p-4 border-4 border-white shadow-[0_0_30px_red] text-center max-w-xs animate-bounce rotate-[-3deg] uppercase">
                {{ deathReason }}
            </div>

            <div v-if="anomalyActive" class="absolute top-4 text-red-500 font-black animate-pulse tracking-widest text-xl z-0">
                ‚ö† –°–ë–û–ô –Ø–î–†–ê ‚ö†
            </div>

            <div v-if="activeScenario" 
                 class="game-card"
                 :class="{'border-red-500 shadow-[0_0_30px_red]': anomalyActive}"
                 :style="cardStyle"
                 @mousedown="startDrag" @touchstart="startDrag">
                
                <div class="absolute top-20 px-4 py-2 border-4 border-red-500 text-red-500 font-black text-2xl rounded bg-black/80 z-30 rotate-12 transition-opacity" :style="{opacity: choiceOpacity.right}">{{ activeScenario.right.label }}</div>
                <div class="absolute top-20 px-4 py-2 border-4 border-cyan-500 text-cyan-500 font-black text-2xl rounded bg-black/80 z-30 -rotate-12 transition-opacity" :style="{opacity: choiceOpacity.left}">{{ activeScenario.left.label }}</div>

                <div class="h-1/2 bg-slate-900 flex items-center justify-center text-[6rem] relative border-b border-slate-800 overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent opacity-80"></div>
                    <div class="filter drop-shadow-[0_0_20px_rgba(255,255,255,0.3)] scale-110 transition-transform" :class="{'animate-pulse': anomalyActive}">{{ activeScenario.emoji }}</div>
                </div>

                <div class="h-1/2 p-5 flex flex-col justify-between bg-[#0a0a0a]">
                    <div>
                        <h3 class="text-lg font-bold text-white mb-2 leading-tight font-mono" :class="{'text-red-400 glitch': anomalyActive}">{{ activeScenario.title }}</h3>
                        <p class="text-xs text-slate-400 font-mono leading-relaxed">{{ activeScenario.desc }}</p>
                    </div>
                    <div class="flex justify-between text-[10px] font-bold font-mono uppercase pt-3 border-t border-slate-800">
                        <div class="text-cyan-500 w-1/2 text-left">‚Üê {{ activeScenario.left.desc }}</div>
                        <div class="text-red-500 w-1/2 text-right">{{ activeScenario.right.desc }} ‚Üí</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. END SCREEN -->
        <transition name="fade">
            <div v-if="screen === 'end'" class="absolute inset-0 bg-red-950/95 z-50 flex flex-col items-center justify-center p-8 text-center backdrop-blur-md">
                <div class="text-6xl mb-4">üíÄ</div>
                <h2 class="text-3xl font-black text-white mb-2 glitch" data-text="CRITICAL FAILURE">–°–ò–°–¢–ï–ú–ê –£–ü–ê–õ–ê</h2>
                <p class="text-sm text-red-200 font-mono mb-6 border border-red-500/30 bg-red-500/10 p-2 uppercase font-bold">{{ deathReason }}</p>
                
                <div class="bg-black/40 p-4 rounded border border-white/10 w-full max-w-xs mb-6">
                    <div class="flex justify-between mb-2 text-sm">
                        <span class="text-slate-400">–ü–†–û–ñ–ò–¢–û:</span>
                        <span class="font-mono text-white">{{ moves }} –î–ù–ï–ô</span>
                    </div>
                    <div class="flex justify-between text-yellow-400 font-bold text-lg">
                        <span>–ù–ê–ú–ê–ô–ù–ï–ù–û:</span>
                        <span>+{{ earnedBits }} ‡∏ø</span>
                    </div>
                </div>

                <button @click="screen = 'menu'" class="cyber-btn px-8 py-4 font-bold text-lg uppercase w-full max-w-xs">
                    –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ê
                </button>
            </div>
        </transition>

        <!-- 6. COLLECTION -->
        <transition name="fade">
            <div v-if="screen === 'collection'" class="absolute inset-0 z-40 flex flex-col p-6 bg-black/95">
                <h2 class="text-lg font-bold text-white mb-4 font-mono border-b border-slate-700 pb-2 text-center uppercase">–ê–†–•–ò–í –°–ú–ï–†–¢–ï–ô</h2>
                <div class="grid grid-cols-2 gap-2 overflow-y-auto pb-20">
                    <div v-for="death in allDeaths" :key="death.id" 
                         class="border border-slate-700 bg-slate-900 p-3 rounded text-center transition-all"
                         :class="{ 'opacity-100 bg-red-900/20 border-red-500': unlockedDeaths.includes(death.id), 'opacity-40 grayscale': !unlockedDeaths.includes(death.id) }">
                        <div class="text-3xl mb-2">{{ unlockedDeaths.includes(death.id) ? 'üíÄ' : '‚ùì' }}</div>
                        <div class="text-[10px] font-bold leading-tight">{{ unlockedDeaths.includes(death.id) ? death.name : '???' }}</div>
                    </div>
                </div>
                <button @click="screen = 'menu'" class="absolute bottom-6 left-6 right-6 py-3 border border-slate-600 text-slate-400 bg-black uppercase">–ù–ê–ó–ê–î</button>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const tg = window.Telegram.WebApp;

        // AUDIO
        let audioCtx;
        const playSound = (type) => {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination); const t = audioCtx.currentTime;

            if(type==='click') { o.type='triangle'; o.frequency.setValueAtTime(600, t); g.gain.value=0.05; g.gain.exponentialRampToValueAtTime(0.01, t+0.1); o.start(); o.stop(t+0.1); }
            if(type==='swipe') { o.type='sawtooth'; o.frequency.setValueAtTime(200, t); g.gain.value=0.05; o.start(); o.stop(t+0.2); }
            if(type==='buy') { o.type='sine'; o.frequency.setValueAtTime(400, t); o.frequency.linearRampToValueAtTime(800, t+0.2); g.gain.value=0.1; o.start(); o.stop(t+0.2); }
            if(type==='anomaly') { o.type='square'; o.frequency.setValueAtTime(100, t); o.frequency.linearRampToValueAtTime(50, t+0.5); g.gain.value=0.1; o.start(); o.stop(t+0.5); }
            if(type==='revive') { o.type='sine'; o.frequency.setValueAtTime(200, t); o.frequency.linearRampToValueAtTime(600, t+0.5); g.gain.value=0.1; o.start(); o.stop(t+0.5); }
            if(type==='death') { 
                o.type='sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.linearRampToValueAtTime(50, t+0.5); g.gain.value=0.2; o.start(); o.stop(t+0.5);
                if(tg) tg.HapticFeedback.notificationOccurred('error');
            }
        };
        const haptic = (style) => { if(tg) tg.HapticFeedback.impactOccurred(style || 'light'); };

        // DATA
        const SCENARIOS = [
            { emoji:'üöã', title:'–í–ê–ì–û–ù–ï–¢–ö–ê', desc:'5 —Ä–∞–±–æ—á–∏—Ö –Ω–∞ –ø—É—Ç–∏ –∏–ª–∏ 1 –Ω–∞ –∑–∞–ø–∞—Å–Ω–æ–º?', left:{label:'1', desc:'–°–≤–µ—Ä–Ω—É—Ç—å', stats:{pop:-15, mor:10}}, right:{label:'5', desc:'–ü—Ä—è–º–æ', stats:{pop:-30, mor:-20}} },
            { emoji:'üí∞', title:'–ù–ê–õ–û–ì–ò', desc:'–ü–æ–¥–Ω—è—Ç—å –Ω–∞–ª–æ–≥–∏ —Ä–∞–¥–∏ –∞—Ä–º–∏–∏?', left:{label:'–î–ê', desc:'–ê—Ä–º–∏—è', stats:{fin:20, sec:20, pop:-25}}, right:{label:'–ù–ï–¢', desc:'–ù–∞—Ä–æ–¥', stats:{fin:-15, sec:-20, pop:15}} },
            { emoji:'ü§ñ', title:'–°–£–î–¨–Ø –ò–ò', desc:'–ó–∞–º–µ–Ω–∏—Ç—å —Å—É–¥–µ–π –Ω–∞ –∞–ª–≥–æ—Ä–∏—Ç–º—ã?', left:{label:'–ò–ò', desc:'–ß–µ—Å—Ç–Ω–æ', stats:{fin:20, mor:-10, sec:10}}, right:{label:'–õ–Æ–î–ò', desc:'–ñ–∞–ª–æ—Å—Ç—å', stats:{fin:-10, mor:10}} },
            { emoji:'ü¶†', title:'–í–ò–†–£–°', desc:'–ó–∞–∫—Ä—ã—Ç—å –≥–æ—Ä–æ–¥ –Ω–∞ –∫–∞—Ä–∞–Ω—Ç–∏–Ω?', left:{label:'–î–ê', desc:'–ñ–∏–∑–Ω—å', stats:{fin:-30, pop:-10, mor:20}}, right:{label:'–ù–ï–¢', desc:'–î–µ–Ω—å–≥–∏', stats:{fin:20, pop:-30, mor:-30}} },
            { emoji:'üïµÔ∏è', title:'–°–õ–ï–ñ–ö–ê', desc:'–¢–æ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –≥—Ä–∞–∂–¥–∞–Ω?', left:{label:'–°–õ–ï–î–ò–¢–¨', desc:'–ë–µ–∑–æ–ø–∞—Å–Ω–æ', stats:{sec:30, pop:-25, mor:-15}}, right:{label:'–°–í–û–ë–û–î–ê', desc:'–ü—Ä–∞–≤–∞', stats:{sec:-25, pop:15, mor:10}} },
            { emoji:'üëΩ', title:'–ù–õ–û', desc:'–ü—Ä–∏—à–µ–ª—å—Ü—ã –ø—Ä–æ—Å—è—Ç –ª—é–¥–µ–π –¥–ª—è –æ–ø—ã—Ç–æ–≤.', left:{label:'–û–¢–î–ê–¢–¨', desc:'–ú–∏—Ä', stats:{fin:30, sec:20, pop:-30}}, right:{label:'–í–û–ô–ù–ê', desc:'–ß–µ—Å—Ç—å', stats:{fin:-20, sec:-30, pop:10}} },
            { emoji:'üíâ', title:'–û–ü–´–¢–´', desc:'–¢–µ—Å—Ç—ã –Ω–∞ –ª—é–¥—è—Ö?', left:{label:'–¢–ï–°–¢', desc:'–ù–∞—É–∫–∞', stats:{sec:10, mor:-30, fin:20}}, right:{label:'–ó–ê–ü–†–ï–¢', desc:'–ü—Ä–∞–≤–∞', stats:{mor:20, fin:-10}} },
            { emoji:'ü•©', title:'–ì–û–õ–û–î', desc:'–†–∞–∑—Ä–µ—à–∏—Ç—å –µ—Å—Ç—å –ª—é–¥–µ–π –≤ –∫—Ä–∏–∑–∏—Å?', left:{label:'–ú–û–ñ–ù–û', desc:'–í—ã–∂–∏—Ç—å', stats:{pop:-40, mor:-50, fin:20}}, right:{label:'–ù–ï–õ–¨–ó–Ø', desc:'–¢–∞–±—É', stats:{pop:10, fin:-30}} },
            { emoji:'üíä', title:'–ë–ï–°–°–ú–ï–†–¢–ò–ï', desc:'–°—ã–≤–æ—Ä–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –±–æ–≥–∞—Ç—ã—Ö?', left:{label:'–î–ê', desc:'–ü—Ä–∏–±—ã–ª—å', stats:{fin:40, pop:-30}}, right:{label:'–í–°–ï–ú', desc:'–•–∞–æ—Å', stats:{fin:-40, pop:30}} },
            { emoji:'üè≠', title:'–†–û–ë–û–¢–´', desc:'–£–≤–æ–ª–∏—Ç—å –ª—é–¥–µ–π, –∫—É–ø–∏—Ç—å —Ä–æ–±–æ—Ç–æ–≤?', left:{label:'–î–ê', desc:'–ü—Ä–æ–≥—Ä–µ—Å—Å', stats:{fin:30, pop:-30}}, right:{label:'–ù–ï–¢', desc:'–†–∞–±–æ—Ç–∞', stats:{fin:-20, pop:20}} }
        ];

        const DEATHS = [
            { id: 'pop_low', name: '–°–í–ï–†–ì–ù–£–¢ –¢–û–õ–ü–û–ô' }, { id: 'pop_high', name: '–£–ë–ò–¢ –§–ê–ù–ê–¢–ò–ö–û–ú' },
            { id: 'fin_low', name: '–ë–ê–ù–ö–†–û–¢–°–¢–í–û' }, { id: 'fin_high', name: '–ö–†–ê–• –û–õ–ò–ì–ê–†–•–ò–ò' },
            { id: 'sec_low', name: '–í–¢–û–†–ñ–ï–ù–ò–ï –í–†–ê–ì–ê' }, { id: 'sec_high', name: '–í–û–ï–ù–ù–´–ô –ü–ï–†–ï–í–û–†–û–¢' },
            { id: 'mor_low', name: '–ü–£–ë–õ–ò–ß–ù–ê–Ø –ö–ê–ó–ù–¨' }, { id: 'mor_high', name: '–°–í–Ø–¢–û–ô –ú–£–ß–ï–ù–ò–ö' }
        ];

        const SHOP_ITEMS = [
            { id: 'lens', name: '–ù–ï–ô–†–û-–õ–ò–ù–ó–ê', icon: 'üëÅÔ∏è', desc: '–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è –≤—ã–±–æ—Ä–∞.', price: 50 },
            { id: 'stim', name: '–ê–î–†–ï–ù–ê–õ–ò–ù', icon: 'üíâ', desc: '–ú–µ–Ω—å—à–µ —à—Ç—Ä–∞—Ñ –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç—å.', price: 100 },
            { id: 'revive', name: '–ê–í–¢–û-–†–ï–ê–ù–ò–ú–ê–¢–û–†', icon: '‚ôªÔ∏è', desc: '–û–¥–Ω–æ –≤–æ—Å–∫—Ä–µ—à–µ–Ω–∏–µ –∑–∞ –∏–≥—Ä—É.', price: 250 },
            { id: 'miner', name: '–ö–†–ò–ü–¢–û-–ú–ê–ô–ù–ï–†', icon: '‚õèÔ∏è', desc: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥ –±–∏—Ç–æ–≤.', price: 400 }
        ];

        createApp({
            setup() {
                const screen = ref('menu');
                
                // SAVES
                const bits = ref(parseInt(localStorage.getItem('ec_bits') || 0));
                const upgrades = ref(JSON.parse(localStorage.getItem('ec_upgrades') || '{}'));
                const unlockedDeaths = ref(JSON.parse(localStorage.getItem('ec_deaths') || '[]'));
                const highScore = ref(parseInt(localStorage.getItem('ec_score') || 0));

                // STATE
                const stats = ref({ pop: 50, fin: 50, sec: 50, mor: 50 });
                const deck = ref([]);
                const cardIdx = ref(0);
                const moves = ref(0);
                const deathReason = ref(null);
                const earnedBits = ref(0);
                const reviveTriggered = ref(false);
                
                const isDragging = ref(false);
                const startX = ref(0);
                const currentX = ref(0);

                onMounted(() => {
                    initMatrix();
                    if(tg) { tg.ready(); tg.expand(); }
                });

                const activeScenario = computed(() => deck.value[cardIdx.value]);
                const anomalyActive = computed(() => moves.value > 0 && moves.value % 10 === 0);
                
                const cardStyle = computed(() => ({
                    transform: `translate(${currentX.value}px, ${Math.abs(currentX.value)*0.1}px) rotate(${currentX.value*0.05}deg)`,
                    transition: isDragging.value ? 'none' : 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)'
                }));

                const choiceOpacity = computed(() => ({
                    left: currentX.value < 0 ? Math.min(Math.abs(currentX.value)/100, 1) : 0,
                    right: currentX.value > 0 ? Math.min(currentX.value/100, 1) : 0
                }));

                const getImpact = (statKey) => {
                    if(!activeScenario.value) return 0;
                    const rStats = activeScenario.value.right.stats[statKey] || 0;
                    const lStats = activeScenario.value.left.stats[statKey] || 0;
                    if(currentX.value > 20) return rStats;
                    if(currentX.value < -20) return lStats;
                    return 0;
                };

                const buyUpgrade = (item) => {
                    if(bits.value >= item.price) {
                        bits.value -= item.price;
                        upgrades.value[item.id] = true;
                        saveData(); playSound('buy'); haptic('success');
                    }
                };

                const startGame = () => {
                    playSound('click');
                    stats.value = { pop: 50, fin: 50, sec: 50, mor: 50 };
                    deck.value = [...SCENARIOS, ...SCENARIOS, ...SCENARIOS].sort(()=>0.5-Math.random());
                    cardIdx.value = 0; moves.value = 0; earnedBits.value = 0;
                    deathReason.value = null; reviveTriggered.value = false; currentX.value = 0;
                    screen.value = 'playing';
                };

                const checkDeath = () => {
                    const s = stats.value;
                    if(s.pop<=0) return {id:'pop_low',t:"–°–í–ï–†–ì–ù–£–¢ –¢–û–õ–ü–û–ô"}; if(s.pop>=100) return {id:'pop_high',t:"–£–ë–ò–¢ –§–ê–ù–ê–¢–ò–ö–û–ú"};
                    if(s.fin<=0) return {id:'fin_low',t:"–ë–ê–ù–ö–†–û–¢–°–¢–í–û"}; if(s.fin>=100) return {id:'fin_high',t:"–ö–†–ê–• –û–õ–ò–ì–ê–†–•–ò–ò"};
                    if(s.sec<=0) return {id:'sec_low',t:"–í–¢–û–†–ñ–ï–ù–ò–ï –í–†–ê–ì–ê"}; if(s.sec>=100) return {id:'sec_high',t:"–í–û–ï–ù–ù–´–ô –ü–ï–†–ï–í–û–†–û–¢"};
                    if(s.mor<=0) return {id:'mor_low',t:"–ü–£–ë–õ–ò–ß–ù–ê–Ø –ö–ê–ó–ù–¨"}; if(s.mor>=100) return {id:'mor_high',t:"–°–í–Ø–¢–û–ô –ú–£–ß–ï–ù–ò–ö"};
                    return null;
                };

                const makeChoice = (dir) => {
                    if(deathReason.value) return;
                    playSound('swipe'); haptic('medium');
                    currentX.value = dir === 'right' ? 500 : -500;

                    const impact = activeScenario.value[dir].stats;
                    for(let k in impact) stats.value[k] = Math.min(100, Math.max(0, stats.value[k] + impact[k]));

                    let death = checkDeath();
                    
                    if(death && upgrades.value.revive && !reviveTriggered.value) {
                        death = null; reviveTriggered.value = true;
                        playSound('revive'); haptic('heavy');
                        stats.value = { pop: 50, fin: 50, sec: 50, mor: 50 };
                        setTimeout(() => reviveTriggered.value = false, 2500);
                    }

                    if(death) {
                        deathReason.value = death.t;
                        playSound('death'); haptic('error');
                        
                        let earned = moves.value * 2;
                        if(upgrades.value.miner) earned *= 2;
                        earnedBits.value = earned; bits.value += earned;
                        
                        if(moves.value > highScore.value) highScore.value = moves.value;
                        if(!unlockedDeaths.value.includes(death.id)) unlockedDeaths.value.push(death.id);
                        
                        saveData();
                        setTimeout(() => screen.value = 'end', 1500);
                    } else {
                        setTimeout(() => {
                            currentX.value = 0; cardIdx.value++; moves.value++;
                            if(anomalyActive.value) playSound('anomaly');
                            if(cardIdx.value >= deck.value.length) deck.value.sort(()=>0.5-Math.random());
                        }, 300);
                    }
                };

                const saveData = () => {
                    localStorage.setItem('ec_bits', bits.value);
                    localStorage.setItem('ec_upgrades', JSON.stringify(upgrades.value));
                    localStorage.setItem('ec_deaths', JSON.stringify(unlockedDeaths.value));
                    localStorage.setItem('ec_score', highScore.value);
                };

                const startDrag = (e) => { if(deathReason.value) return; isDragging.value = true; startX.value = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; };
                const onMove = (e) => { if(isDragging.value) currentX.value = (e.type.includes('mouse') ? e.clientX : e.touches[0].clientX) - startX.value; };
                const onEnd = () => { isDragging.value = false; if(currentX.value > 100) makeChoice('right'); else if(currentX.value < -100) makeChoice('left'); else currentX.value = 0; };

                const getStatIcon = (k) => ({pop:'üë•', fin:'üí∞', sec:'üõ°Ô∏è', mor:'‚öñÔ∏è'}[k]);
                const getBarColor = (k, v) => (v < 15 || v > 85) ? 'bg-red-500 shadow-[0_0_15px_red]' : {pop:'bg-blue-400', fin:'bg-yellow-400', sec:'bg-green-400', mor:'bg-purple-400'}[k];

                return { 
                    screen, bits, upgrades, shopItems: SHOP_ITEMS, unlockedDeaths, allDeaths: DEATHS, highScore, stats,
                    activeScenario, cardStyle, choiceOpacity, moves, deathReason, earnedBits, reviveTriggered, anomalyActive,
                    startGame, buyUpgrade, startDrag, getStatIcon, getBarColor, getImpact
                };
            }
        }).mount('#app');

        function initMatrix() {
            const c = document.getElementById('matrix'); const ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            const drops = Array(Math.floor(c.width/20)).fill(1);
            function draw() {
                ctx.fillStyle = 'rgba(0,0,0,0.05)'; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle = '#0F0'; ctx.font = '15px monospace';
                for(let i=0; i<drops.length; i++) {
                    ctx.fillText(String.fromCharCode(0x30A0+Math.random()*96), i*20, drops[i]*20);
                    if(drops[i]*20 > c.height && Math.random()>0.975) drops[i] = 0; drops[i]++;
                }
                requestAnimationFrame(draw);
            }
            draw();
        }
    </script>
</body>
</html>