<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Z.E.R.O.: Last Breach ‚Äî Planet Update</title>

<!-- Three.js r128 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<!-- optional postprocessing (fallback handled) -->
<script src="https://threejs.org/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://threejs.org/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://threejs.org/examples/js/postprocessing/UnrealBloomPass.js"></script>
<script src="https://threejs.org/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://threejs.org/examples/js/shaders/GammaCorrectionShader.js"></script>

<style>
  :root{--neon:#00ffff;--bg:#07121a;--glass:rgba(0,0,0,0.5)}
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:var(--bg);font-family:Courier,monospace;color:var(--neon);-webkit-user-select:none;user-select:none;overflow:hidden}
  #canvasWrap{position:fixed;inset:0;z-index:1}
  #ui{position:fixed;inset:0;pointer-events:none;z-index:10}
  .screen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .menuCard{pointer-events:auto;background:linear-gradient(180deg, rgba(0,12,22,0.9), rgba(0,6,12,0.65));padding:18px;border-radius:12px;border:1px solid rgba(0,255,255,0.06);backdrop-filter:blur(4px);box-shadow:0 8px 40px rgba(0,255,255,0.03)}
  h1{font-size:2.2rem;text-align:center;margin-bottom:8px;text-shadow:0 0 18px rgba(0,255,255,0.12)}
  .btn{pointer-events:auto;background:transparent;border:1px solid rgba(0,255,255,0.12);color:var(--neon);padding:10px 16px;border-radius:10px;margin:6px;font-size:16px}
  .hud{position:fixed;left:10px;top:10px;pointer-events:none;background:var(--glass);padding:10px;border-radius:8px;border:1px solid rgba(0,255,255,0.05)}
  .res{position:fixed;right:10px;top:10px;pointer-events:none;background:var(--glass);padding:10px;border-radius:8px;border:1px solid rgba(0,255,255,0.05);text-align:right}
  .controls{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:12px;pointer-events:auto;z-index:12}
  .ctlBtn{width:68px;height:68px;border-radius:14px;background:rgba(0,255,255,0.04);display:flex;align-items:center;justify-content:center;color:var(--neon);border:1px solid rgba(0,255,255,0.08);font-size:26px}
  #rightControls{position:fixed;right:8px;bottom:18px;display:flex;flex-direction:column;gap:10px;pointer-events:auto;z-index:12}
  #damageFlash{position:fixed;inset:0;background:#ff2b2b;opacity:0;pointer-events:none;mix-blend-mode:screen;transition:opacity 120ms}
  .scanlines{position:fixed;inset:0;pointer-events:none;background:repeating-linear-gradient(to bottom, rgba(255,255,255,0) 0px, rgba(255,255,255,0.02) 2px, rgba(255,255,255,0) 3px);opacity:0.18;mix-blend-mode:overlay}
  /* planet UI */
  #planetUI{position:fixed;inset:12% 8%;display:none;flex-direction:column;gap:12px;pointer-events:auto;z-index:20}
  .planetCard{background:linear-gradient(180deg, rgba(0,8,16,0.95), rgba(0,0,8,0.85));padding:16px;border-radius:12px;border:1px solid rgba(0,255,255,0.06)}
  .shopGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .shopItem{background:rgba(0,0,0,0.45);padding:10px;border-radius:8px;border:1px solid rgba(0,255,255,0.06);text-align:center}
  /* joystick for planet walk */
  #joy{position:fixed;left:12px;bottom:12px;width:120px;height:120px;border-radius:60px;background:rgba(0,0,0,0.25);pointer-events:auto;z-index:15;touch-action:none}
  #joyKnob{position:absolute;width:44px;height:44px;border-radius:22px;background:rgba(0,255,255,0.12);left:38px;top:38px;border:1px solid rgba(0,255,255,0.08)}
  .small{font-size:13px;color:#9ff;opacity:0.9}
  @media (max-width:420px){ .ctlBtn{width:60px;height:60px;font-size:22px} h1{font-size:1.8rem} }
</style>
</head>
<body>
  <div id="canvasWrap"></div>
  <div id="ui">
    <div class="scanlines"></div>

    <div id="menu" class="screen">
      <div class="menuCard">
        <h1>Z.E.R.O.: Last Breach</h1>
        <div style="text-align:center;color:#9ff;margin-bottom:8px">–ù–µ–æ–Ω–æ–≤—ã–π –∫–æ—Å–º–æ—Å ‚Ä¢ –ü–æ—Å–∞–¥–∫–∏ –Ω–∞ –ø–ª–∞–Ω–µ—Ç—ã ‚Ä¢ –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</div>
        <div style="display:flex;justify-content:center;gap:10px">
          <button id="startBtn" class="btn">–°–¢–ê–†–¢</button>
          <button id="tutorialBtn" class="btn">–¢–£–†</button>
        </div>
        <div style="margin-top:10px;text-align:center;color:#9ff;font-size:13px">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π... <span id="dots">‚óè ‚óè ‚óè</span></div>
      </div>
    </div>

    <div id="hud" class="hud small">‚ù§ <span id="hp">100</span> &nbsp; ‚ö° <span id="shield">100</span></div>
    <div id="res" class="res small">‚≠ê <span id="stars">0</span> &nbsp; üíé <span id="frags">0</span> &nbsp; ‚Ç° <span id="credits">0</span></div>

    <div class="controls" id="controls">
      <div id="leftBtn" class="ctlBtn">‚óÄ</div>
      <div id="shieldBtn" class="ctlBtn">üõ°</div>
      <div id="shootBtn" class="ctlBtn">üí•</div>
      <div id="rightBtn" class="ctlBtn">‚ñ∂</div>
    </div>

    <div id="rightControls">
      <div id="landBtn" class="ctlBtn">üõ¨</div>
      <div id="takeoffBtn" class="ctlBtn" style="display:none">üöÄ</div>
    </div>

    <div id="planetUI">
      <div class="planetCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong id="planetName">–ü–ª–∞–Ω–µ—Ç–∞</strong><div class="small" id="planetLore">...</div></div>
          <div><button id="leavePlanet" class="btn">–£–õ–ï–¢–ï–¢–¨</button></div>
        </div>
        <div style="margin-top:10px">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="shopGrid" id="shopGrid">
          <!-- items appended -->
        </div>
      </div>
    </div>

    <div id="joy" style="display:none"><div id="joyKnob"></div></div>
    <div id="damageFlash"></div>
  </div>

<script>
/* ===============================================================
  Z.E.R.O.: Full single-file build
  - Space scene with auto-aim
  - Planets + landing, third-person walk on surface
  - NPC dialog (fake/lore), shop, upgrades, currency
  - Mobile-friendly touch UI and joystick
  - WebAudio SFX (synth) and small bloom (fallback)
================================================================= */

/* -------------------- Globals -------------------- */
let renderer, scene, camera, composer;
let spaceScene = true, landed = false, surfacePlayer = null;
let ship, enemies = [], bullets = [], starsPoints, planets = [];
let credits = 0, stars = 0, frags = 0;
let hp = 100, shield = 100;
let lastShot = 0, fireInterval = 300;
let targetAuto = true;
let clock = new THREE.Clock();
let perfTime = 0;

/* Touch state */
const touchState = { left:false, right:false, shoot:false };

/* Simple audio using WebAudio */
const AudioSys = (function(){
  let ctx = null;
  function ensure(){ if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)(); return ctx; }
  function beep(freq, time=0.12, type='sawtooth', vol=0.12){
    const c = ensure(); if (!c) return;
    const o = c.createOscillator(), g = c.createGain();
    o.type = type; o.frequency.setValueAtTime(freq, c.currentTime);
    g.gain.setValueAtTime(vol, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + time);
    o.connect(g); g.connect(c.destination);
    o.start(); o.stop(c.currentTime + time);
  }
  return { beep };
})();

/* -------------------- Init renderer & scenes -------------------- */
function initThree(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 8000);
  camera.position.set(0,6,26);

  renderer = new THREE.WebGLRenderer({ antialias:true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.setClearColor(0x07121a, 1);
  document.getElementById('canvasWrap').appendChild(renderer.domElement);

  // try composer (bloom) - fallback ok
  try {
    composer = new THREE.EffectComposer(renderer);
    const rp = new THREE.RenderPass(scene, camera);
    composer.addPass(rp);
    const bloom = new THREE.UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.7, 0.3, 0.6);
    bloom.threshold = 0.12; bloom.strength = 0.9; bloom.radius = 0.35;
    composer.addPass(bloom);
    const gamma = new THREE.ShaderPass(THREE.GammaCorrectionShader);
    composer.addPass(gamma);
  } catch(e) {
    console.warn('Composer failed, render without postprocess', e);
    composer = null;
  }
}

/* -------------------- Lights -------------------- */
function addLights(){
  scene.add(new THREE.AmbientLight(0x8899aa, 0.95));
  const dir = new THREE.DirectionalLight(0xffffff, 1.1); dir.position.set(30,40,10); dir.castShadow=true; scene.add(dir);
  const rim = new THREE.DirectionalLight(0x66bbff, 0.5); rim.position.set(-10,-8,-20); scene.add(rim);
  scene.add(new THREE.PointLight(0x88ccff, 0.18, 400));
}

/* -------------------- Starfield -------------------- */
function makeStarfield(){
  const count = 2500;
  const pos = new Float32Array(count*3);
  const col = new Float32Array(count*3);
  for (let i=0;i<count;i++){
    const i3 = i*3;
    pos[i3] = (Math.random()-0.5)*4000;
    pos[i3+1] = (Math.random()-0.5)*2000;
    pos[i3+2] = (Math.random()-0.5)*6000 - 800;
    const c = Math.random();
    if (c < 0.7){ col[i3]=1; col[i3+1]=1; col[i3+2]=1; }
    else if (c<0.9){ col[i3]=0.8; col[i3+1]=0.9; col[i3+2]=1; }
    else { col[i3]=1; col[i3+1]=0.9; col[i3+2]=0.6; }
  }
  const g = new THREE.BufferGeometry();
  g.setAttribute('position', new THREE.BufferAttribute(pos,3));
  g.setAttribute('color', new THREE.BufferAttribute(col,3));
  const m = new THREE.PointsMaterial({ size:2.0, vertexColors:true, transparent:true, blending:THREE.AdditiveBlending, opacity:0.9 });
  starsPoints = new THREE.Points(g, m);
  scene.add(starsPoints);
}

/* -------------------- Ship (player) -------------------- */
function createShip(){
  const group = new THREE.Group();
  const hull = new THREE.ConeGeometry(3.0, 9.0, 6);
  const mat = new THREE.MeshStandardMaterial({ color:0x00ffff, metalness:0.3, roughness:0.25, emissive:0x001122, emissiveIntensity:0.8 });
  const mesh = new THREE.Mesh(hull, mat); mesh.rotation.x = -Math.PI/2; group.add(mesh);
  const wing = new THREE.BoxGeometry(7,0.6,3);
  const left = new THREE.Mesh(wing, mat); left.position.set(-4,0,0); group.add(left);
  const right = left.clone(); right.position.x = 4; group.add(right);

  group.position.set(0,0,15);
  group.castShadow = true;
  scene.add(group);
  ship = group;
}

/* -------------------- Planets (space) -------------------- */
function spawnPlanets(){
  const data = [
    { name:'–ö–†–ò–û–ù–ò–°', color:0x88ccff, size:24, lore:'–õ–µ–¥—è–Ω—ã–µ –∑–∞–ª—ã, –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –≤ –≥–ª—É–±–∏–Ω–µ.' },
    { name:'–ü–ò–†–û–°', color:0xff6633, size:30, lore:'–ü—ã–ª–∞—é—â–∏–µ –º–æ—Ä—è –∏ —á—ë—Ä–Ω—ã–µ —à—Ç–æ—Ä–º—ã.' },
    { name:'–í–ï–†–î–ê–ù–¢', color:0x44ff88, size:22, lore:'–ë–∏–æ–ª—é–º–∏–Ω–µ—Å—Ü–µ–Ω—Ç–Ω—ã–µ –ª–µ—Å–∞ –∏ –º—Ö–∏.' }
  ];
  for (let i=0;i<3;i++){
    const p = data[i];
    const geom = new THREE.SphereGeometry(p.size, 32, 24);
    const mat = new THREE.MeshStandardMaterial({ color:p.color, emissive:new THREE.Color(p.color).multiplyScalar(0.2), roughness:0.6 });
    const m = new THREE.Mesh(geom, mat);
    m.position.set((i-1)*140 + (Math.random()-0.5)*30, (Math.random()-0.5)*30, -500 - i*400);
    m.userData = { name:p.name, lore:p.lore };
    scene.add(m);
    planets.push(m);
  }
}

/* -------------------- Enemies & spawn -------------------- */
function spawnEnemyWave(){
  const count = 6 + Math.floor(Math.random()*6);
  for (let i=0;i<count;i++){
    if (Math.random() < 0.35) continue;
    const geom = new THREE.DodecahedronGeometry(3 + Math.random()*2, 0);
    const mat = new THREE.MeshStandardMaterial({ color:0xff6644, emissive:0x441100, metalness:0.25, roughness:0.4 });
    const e = new THREE.Mesh(geom, mat);
    e.position.set((Math.random()-0.5)*300, (Math.random()-0.5)*60, -800 - Math.random()*1200);
    e.userData = { hp: 20 + Math.floor(Math.random()*40), speed: 0.2 + Math.random()*0.6 };
    e.castShadow = true;
    scene.add(e); enemies.push(e);
  }
}

/* spawn periodically */
setInterval(()=>{ if (spaceScene && !landed) spawnEnemyWave(); }, 6000);

/* -------------------- Pooled bullets -------------------- */
const BULLET_POOL = [];
function initBullets(){
  const geom = new THREE.SphereGeometry(0.6, 6, 6);
  const mat = new THREE.MeshBasicMaterial({ color:0xffff66, emissive:0xffff66 });
  for (let i=0;i<60;i++){
    const m = new THREE.Mesh(geom, mat);
    m.visible = false; m.userData = { vel: new THREE.Vector3(), life:0 };
    scene.add(m); BULLET_POOL.push(m);
  }
}
function getBullet(){
  for (let i=0;i<BULLET_POOL.length;i++) if (!BULLET_POOL[i].visible) return BULLET_POOL[i];
  return null;
}

/* -------------------- Auto-aim and shoot -------------------- */
function findNearestEnemy(range=400){
  let min = Infinity, target = null;
  for (let e of enemies){
    const d = ship.position.distanceTo(e.position);
    if (d < min && d < range){ min = d; target = e; }
  }
  return target;
}
function shootAt(target=null){
  const now = performance.now();
  if (now - lastShot < fireInterval) return;
  lastShot = now;
  const b = getBullet(); if (!b) return;
  b.visible = true; b.position.copy(ship.position).add(new THREE.Vector3(0,0,-6));
  if (target){
    const dir = target.position.clone().sub(ship.position).normalize();
    b.userData.vel.copy(dir.multiplyScalar(28));
  } else {
    // forward
    const dir = new THREE.Vector3(0,0,-1).applyQuaternion(ship.quaternion);
    b.userData.vel.copy(dir.multiplyScalar(28));
  }
  b.userData.life = 90;
  bullets.push(b);
  AudioSys.beep(750, 0.12, 'square', 0.12);
}

/* -------------------- Effects -------------------- */
function createExplosion(pos, intensity=1){
  // small point-cloud explosion
  const count = 18;
  const geom = new THREE.BufferGeometry();
  const posArr = new Float32Array(count*3);
  for (let i=0;i<count;i++){
    posArr[i*3] = pos.x + (Math.random()-0.5)*6*intensity;
    posArr[i*3+1] = pos.y + (Math.random()-0.5)*6*intensity;
    posArr[i*3+2] = pos.z + (Math.random()-0.5)*6*intensity;
  }
  geom.setAttribute('position', new THREE.BufferAttribute(posArr,3));
  const mat = new THREE.PointsMaterial({ size:2.6*intensity, color:0xffcc66, transparent:true, opacity:1, blending:THREE.AdditiveBlending });
  const pts = new THREE.Points(geom, mat);
  pts.userData = { life:1.0 };
  scene.add(pts);
  (function tick(){
    const id = requestAnimationFrame(()=>tick());
    pts.userData.life -= 0.02;
    pts.material.opacity = Math.max(0, pts.userData.life);
    if (pts.userData.life <= 0){ cancelAnimationFrame(id); try{ scene.remove(pts) }catch(e){} }
  })();
  AudioSys.beep(220 + Math.random()*120, 0.18, 'sawtooth', 0.12);
}

/* -------------------- UI & Controls Setup -------------------- */
document.addEventListener('DOMContentLoaded', ()=>{ // ensure DOM
  // buttons
  document.getElementById('startBtn').addEventListener('click', ()=>{ AudioSys.beep(420,0.16); startGame(); });
  document.getElementById('tutorialBtn').addEventListener('click', ()=>{ showFakeDialog("–¢—É—Ä: –£–ø—Ä–∞–≤–ª—è–π –∫–æ—Ä–∞–±–ª—ë–º, —Å–∞–∂–∞–π –ø–ª–∞–Ω–µ—Ç—ã, —É–ª—É—á—à–∞–π –∫–æ—Ä–∞–±–ª—å. –£–¥–∞—á–∏.") });
  // touch controls
  const leftBtn = document.getElementById('leftBtn'), rightBtn = document.getElementById('rightBtn'), shootBtn = document.getElementById('shootBtn'), shieldBtn = document.getElementById('shieldBtn');
  leftBtn.addEventListener('touchstart', e=>{ e.preventDefault(); touchState.left=true; }); leftBtn.addEventListener('touchend', e=>{ touchState.left=false; });
  rightBtn.addEventListener('touchstart', e=>{ e.preventDefault(); touchState.right=true; }); rightBtn.addEventListener('touchend', e=>{ touchState.right=false; });
  shootBtn.addEventListener('touchstart', e=>{ e.preventDefault(); touchState.shoot=true; }); shootBtn.addEventListener('touchend', e=>{ touchState.shoot=false; });
  shieldBtn.addEventListener('touchstart', e=>{ e.preventDefault(); activateShield(); });

  // desktop fallback
  leftBtn.addEventListener('mousedown', ()=>touchState.left=true); leftBtn.addEventListener('mouseup', ()=>touchState.left=false);
  rightBtn.addEventListener('mousedown', ()=>touchState.right=true); rightBtn.addEventListener('mouseup', ()=>touchState.right=false);
  shootBtn.addEventListener('mousedown', ()=>touchState.shoot=true); shootBtn.addEventListener('mouseup', ()=>touchState.shoot=false);

  // land/takeoff controls
  document.getElementById('landBtn').addEventListener('click', ()=>{ tryLand(); });
  document.getElementById('takeoffBtn').addEventListener('click', ()=>{ takeOff(); });

  // planet UI
  document.getElementById('leavePlanet').addEventListener('click', ()=>{ takeOff(); });

  // joystick init (planet walking)
  initJoystick();
});

/* -------------------- Start & Loop -------------------- */
function startGame(){
  initThree(); addLights(); makeStarfield(); createShip(); spawnPlanets(); initBullets();
  // initial enemies
  spawnEnemyWave();
  // fade menu out
  document.getElementById('menu').style.display = 'none';
  spaceScene = true; landed = false;
  animate();
}

/* -------------------- Loop -------------------- */
let last = performance.now();
function animate(){
  requestAnimationFrame(animate);
  const now = performance.now();
  const delta = Math.min((now - last)/1000, 0.05);
  last = now;
  perfTime += delta;

  if (starsPoints) starsPoints.position.z += 0.06 * delta * 60; if (starsPoints && starsPoints.position.z > 2000) starsPoints.position.z = -2000;
  // ship bob
  if (ship) ship.rotation.z = Math.sin(perfTime*1.2)*0.02;

  if (!landed) updateSpace(delta);
  else updateSurface(delta);

  // render
  try{ if (composer) composer.render(delta); else renderer.render(scene, camera); } catch(e){ renderer.render(scene, camera); }
  updateHUD();
}

/* -------------------- Space update -------------------- */
function updateSpace(delta){
  // simple left-right rotation control
  if (touchState.left) ship.position.x -= 0.8 * delta * 60;
  if (touchState.right) ship.position.x += 0.8 * delta * 60;

  // auto-target and shooting
  if (touchState.shoot){
    const tgt = findNearestEnemy(500);
    if (tgt) shootAt(tgt);
    else shootAt(null);
  }

  // move bullets
  for (let i = bullets.length -1; i >=0; i--){
    const b = bullets[i];
    b.position.add(b.userData.vel.clone().multiplyScalar(delta*60));
    b.userData.life--;
    if (b.userData.life <= 0 || b.position.distanceTo(ship.position) > 2000){ b.visible=false; bullets.splice(i,1); continue; }
    // collision with enemies
    for (let j=enemies.length-1;j>=0;j--){
      const e = enemies[j];
      if (b.position.distanceTo(e.position) < 6){
        e.userData.hp -= 16;
        b.visible=false; bullets.splice(i,1);
        if (e.userData.hp <= 0){
          createExplosion(e.position, 1.2);
          scene.remove(e); enemies.splice(j,1);
          frags += 1; credits += 6; stars += 1;
        }
        break;
      }
    }
  }

  // enemy logic
  for (let i=enemies.length-1;i>=0;i--){
    const e = enemies[i];
    // move towards ship loosely
    const dir = ship.position.clone().sub(e.position).normalize();
    e.position.add(dir.multiplyScalar(e.userData.speed * delta * 60));
    // if collision with ship
    if (e.position.distanceTo(ship.position) < 8){
      // damage
      if (shield > 0) shield = Math.max(0, shield - 18);
      else { hp = Math.max(0, hp - 20); flashDamage(); }
      createExplosion(e.position, 0.9);
      scene.remove(e); enemies.splice(i,1);
    }
  }

  // planets rotate slowly
  for (let p of planets) p.rotation.y += 0.0006 * delta * 60;

  // camera follow behind ship
  const camOffset = new THREE.Vector3(0,8,28).applyQuaternion(ship.quaternion);
  camera.position.copy(ship.position).add(camOffset);
  const lookAt = ship.position.clone().add(new THREE.Vector3(0,0,-1).applyQuaternion(ship.quaternion).multiplyScalar(80));
  camera.lookAt(lookAt);
}

/* -------------------- Surface (third-person) -------------------- */
let surfaceSceneRoot = null;
let joystick = {active:false, dx:0, dy:0};
function initSurface(playerModel){
  // create small ground plane and simple skybox by adjusting camera
  surfaceSceneRoot = new THREE.Group();
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(300,300,4,4), new THREE.MeshStandardMaterial({ color:0x051014, roughness:0.9 }));
  ground.rotation.x = -Math.PI/2; ground.position.y = -1;
  surfaceSceneRoot.add(ground);

  // place some rocks / NPCs
  for (let i=0;i<8;i++){
    const rock = new THREE.Mesh(new THREE.DodecahedronGeometry(1 + Math.random()*1.8), new THREE.MeshStandardMaterial({ color:0x223344, roughness:0.9 }));
    rock.position.set((Math.random()-0.5)*60, 0, (Math.random()-0.5)*60);
    surfaceSceneRoot.add(rock);
  }

  // NPCs
  const npcGeo = new THREE.CylinderGeometry(0.6,0.8,2.2,8);
  const npcMat = new THREE.MeshStandardMaterial({ color:0xffaa88, emissive:0x331100 });
  for (let i=0;i<3;i++){
    const npc = new THREE.Mesh(npcGeo, npcMat);
    npc.position.set((Math.random()-0.5)*40, 1, (Math.random()-0.5)*40);
    npc.userData = { dialog: generateLoreDialog() };
    surfaceSceneRoot.add(npc);
  }

  // add the surface root to scene and position player model
  scene.add(surfaceSceneRoot);
  surfacePlayer = playerModel;
  surfacePlayer.position.set(0,0.6,0);
  surfacePlayer.rotation.set(0,Math.PI,0);
  surfaceSceneRoot.add(surfacePlayer);

  // position camera behind surface player
  camera.position.copy(surfacePlayer.position).add(new THREE.Vector3(0,6,10));
  camera.lookAt(surfacePlayer.position);
}

/* the model for player walking */
function createSurfacePlayer(){
  const g = new THREE.CapsuleGeometry(0.6, 1.2, 4, 8);
  const m = new THREE.Mesh(g, new THREE.MeshStandardMaterial({ color:0x66ddff, emissive:0x002233 }));
  m.castShadow = true;
  return m;
}

/* update surface movement */
function updateSurface(delta){
  if (!surfacePlayer) return;
  // joystick controls
  const speedWalk = 6 * delta;
  let moved = false;
  if (joystick.active){
    const v = new THREE.Vector3(joystick.dx,0,joystick.dy).normalize();
    surfacePlayer.position.x += v.x * speedWalk;
    surfacePlayer.position.z += v.z * speedWalk;
    surfacePlayer.lookAt(surfacePlayer.position.clone().add(v));
    moved = true;
  }
  // NPC proximity -> show dialog prompt
  // simple detection
  surfaceSceneRoot.children.forEach(ch=>{
    if (ch.userData && ch.userData.dialog){
      const d = ch.position.distanceTo(surfacePlayer.position);
      if (d < 2.2){
        // show dialog UI briefly
        showFakeDialog(ch.userData.dialog);
      }
    }
  });
  // camera follows slightly
  const camTarget = surfacePlayer.position.clone().add(new THREE.Vector3(0,6,10).applyAxisAngle(new THREE.Vector3(0,1,0), 0));
  camera.position.lerp(camTarget, 0.12);
  camera.lookAt(surfacePlayer.position.clone().add(new THREE.Vector3(0,1.2,0)));
}

/* -------------------- Landing & Takeoff -------------------- */
function tryLand(){
  // find nearest planet within range
  let nearest = null; let min = Infinity;
  for (let p of planets){
    const d = ship.position.distanceTo(p.position);
    if (d < min){ min = d; nearest = p; }
  }
  if (nearest && min < 120){
    // landing sequence
    performLanding(nearest);
  } else {
    showFakeDialog("–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–π –ø–ª–∞–Ω–µ—Ç—ã —Ä—è–¥–æ–º. –ü–æ–¥–ª–µ—Ç–∏—Ç–µ –ø–æ–±–ª–∏–∂–µ.");
  }
}

function performLanding(planet){
  spaceScene = false;
  landed = true;
  // smooth camera + fade
  fadeOut(300, ()=>{
    // move ship to planet atmosphere point and hide space elements
    // prepare surface: remove planets & enemies from view, but keep scene
    // create a small surface scene root with player model
    const surfPlayer = createSurfacePlayer();
    initSurface(surfPlayer);
    // show planet UI
    document.getElementById('planetUI').style.display = 'flex';
    document.getElementById('planetName').innerText = planet.userData.name;
    document.getElementById('planetLore').innerText = planet.userData.lore;
    populateShop();
    // show joystick & UI
    document.getElementById('joy').style.display = 'block';
    document.getElementById('controls').style.display = 'none';
    document.getElementById('rightControls').style.display = 'none';
    document.getElementById('takeoffBtn').style.display = 'block';
    // fade in
    fadeIn(500);
    showFakeDialog(generateLoreDialog());
  });
}

function takeOff(){
  // remove surface root and player model
  fadeOut(220, ()=>{
    if (surfaceSceneRoot){ try{ scene.remove(surfaceSceneRoot) }catch(e){} surfaceSceneRoot = null; }
    surfacePlayer = null;
    // restore controls for space
    document.getElementById('joy').style.display = 'none';
    document.getElementById('controls').style.display = 'flex';
    document.getElementById('rightControls').style.display = 'block';
    document.getElementById('planetUI').style.display = 'none';
    landed = false; spaceScene = true;
    // move ship slightly forward
    ship.position.z -= 60;
    fadeIn(300);
    showFakeDialog("–í–∑–ª—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω. –£–¥–∞—á–Ω–æ–≥–æ –ø–æ–ª—ë—Ç–∞, —Ä–µ–π–¥–µ—Ä.");
  });
}

/* -------------------- UI helpers -------------------- */
function fadeOut(ms=300, cb=()=>{}){
  document.getElementById('damageFlash').style.transition = `opacity ${ms}ms`;
  document.getElementById('damageFlash').style.opacity = '0';
  // overlay fade by dimming canvas
  renderer.domElement.style.transition = `filter ${ms}ms`;
  renderer.domElement.style.filter = 'blur(6px) saturate(0.9) brightness(0.6)';
  setTimeout(cb, ms);
}
function fadeIn(ms=300, cb=()=>{}){
  renderer.domElement.style.transition = `filter ${ms}ms`;
  renderer.domElement.style.filter = 'none';
  setTimeout(cb, ms);
}

/* -------------------- Shop and upgrades -------------------- */
function populateShop(){
  const grid = document.getElementById('shopGrid'); grid.innerHTML = '';
  const items = [
    { id:'weapon', name:'–£—Å–∏–ª–∏—Ç–µ–ª—å –æ—Ä—É–∂–∏—è', price:45, desc:'+20% —É—Ä–æ–Ω' },
    { id:'engine', name:'–£—Å–∏–ª–∏—Ç–µ–ª—å –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π', price:40, desc:'+15% —Å–∫–æ—Ä–æ—Å—Ç—å' },
    { id:'shield', name:'–†–µ–º–∫–æ–º–ø–ª–µ–∫—Ç —â–∏—Ç–∞', price:60, desc:'–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —â–∏—Ç –¥–æ 100' }
  ];
  for (let it of items){
    const div = document.createElement('div'); div.className='shopItem';
    div.innerHTML = `<div><strong>${it.name}</strong></div><div class="small">${it.desc}</div><div style="margin-top:8px"><button class="btn" data-id="${it.id}" data-price="${it.price}">–ö—É–ø–∏—Ç—å ${it.price}‚Ç°</button></div>`;
    grid.appendChild(div);
  }
  // add handlers
  grid.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.dataset.id, price = parseInt(b.dataset.price);
      if (credits >= price){
        credits -= price; document.getElementById('credits').innerText = credits;
        applyPurchase(id);
        showFakeDialog('–ü–æ–∫—É–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ' + id);
      } else showFakeDialog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤.');
    });
  });
}
function applyPurchase(id){
  if (id === 'weapon'){ fireInterval = Math.max(160, Math.round(fireInterval * 0.85)); }
  if (id === 'engine'){ ship.userData = ship.userData || {}; ship.userData.speedBoost = (ship.userData.speedBoost || 0) + 0.12; }
  if (id === 'shield'){ shield = 100; }
}

/* -------------------- Flash & HUD -------------------- */
function flashDamage(){
  const el = document.getElementById('damageFlash');
  el.style.opacity = '0.5';
  setTimeout(()=>el.style.opacity='0',150);
}
function updateHUD(){
  document.getElementById('hp').innerText = Math.max(0, Math.round(hp));
  document.getElementById('shield').innerText = Math.round(shield);
  document.getElementById('credits').innerText = credits;
  document.getElementById('stars').innerText = stars;
  document.getElementById('frags').innerText = frags;
}

/* -------------------- Fake dialogues (lore) -------------------- */
function generateLoreDialog(){
  const lines = [
    "–ì–æ–≤–æ—Ä—è—Ç: –≤ —Å–µ–∫—Ç–æ—Ä–µ N-9 –æ—Å—Ç–∞–ª–∞—Å—å –±–∞–∑–∞ —Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏.",
    "–û–¥–Ω–∞–∂–¥—ã –∫—Ä–∏—Å—Ç–∞–ª–ª –∑–∞–ø–µ–ª ‚Äî –∏ —Å–ø—É—Ç–Ω–∏–∫ –∏—Å—á–µ–∑.",
    "–¢–æ—Ä–≥–æ–≤—Ü—ã –Ω–∞ –ù–µ–∫—Å—É—Å–µ –ª—é–±—è—Ç –∑–æ–ª–æ—Ç–æ, –ø—Ä–µ–∑–∏—Ä–∞—é—Ç —Å–ª–∞–±—ã—Ö.",
    "–ú–Ω–æ–≥–∏–µ –±–æ—è—Ç—Å—è –Ω–æ—á–∏ –Ω–∞ –ö—Ä–∏–æ–Ω–∏—Å–µ ‚Äî –Ω–µ —Ç–æ–ª—å–∫–æ —Ö–æ–ª–æ–¥ —É–±–∏–≤–∞–µ—Ç.",
    "–ß–∞—Å—Ç–æ —Å–ª—ã—à–∏—à—å ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å –ü–∏—Ä–æ—Å–∞ —Ü–µ–ª—ã–º."
  ];
  return lines[Math.floor(Math.random()*lines.length)];
}
function showFakeDialog(text){
  // temporary floating message
  const el = document.createElement('div');
  el.style.cssText = 'position:fixed;left:50%;top:14%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:var(--neon);padding:8px 12px;border-radius:8px;border:1px solid rgba(0,255,255,0.07);z-index:9999';
  el.innerText = text;
  document.body.appendChild(el);
  setTimeout(()=>{ try{ document.body.removeChild(el) }catch(e){} }, 2600);
}

/* -------------------- Shield -------------------- */
function activateShield(){
  if (shield >= 25){
    shield -= 25;
    // small visual: add sphere around ship
    const s = new THREE.Mesh(new THREE.SphereGeometry(8, 18, 16), new THREE.MeshBasicMaterial({ color:0x00ffff, transparent:true, opacity:0.18, side:THREE.DoubleSide }));
    ship.add(s);
    setTimeout(()=>{ try{ ship.remove(s) }catch(e){} }, 2800);
    AudioSys.beep(520,0.18,'sine',0.12);
  } else showFakeDialog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏ —â–∏—Ç–∞.');
}

/* -------------------- Joystick for surface movement -------------------- */
function initJoystick(){
  const joy = document.getElementById('joy'), knob = document.getElementById('joyKnob');
  let startX=0, startY=0, active=false;
  const radius=40;
  function down(e){
    active=true; joy.style.opacity=1;
    const touch = (e.touches && e.touches[0]) || e;
    startX = touch.clientX; startY = touch.clientY;
    knob.style.left = '38px'; knob.style.top = '38px';
    joystick.active = true;
  }
  function move(e){
    if (!active) return;
    e.preventDefault();
    const touch = (e.touches && e.touches[0]) || e;
    let dx = touch.clientX - startX, dy = touch.clientY - startY;
    // clamp
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (dist > radius){ dx *= radius/dist; dy *= radius/dist; }
    knob.style.left = (38 + dx) + 'px';
    knob.style.top = (38 + dy) + 'px';
    joystick.active = true;
    joystick.dx = dx / radius; joystick.dy = -dy / radius; // invert y so up moves forward
  }
  function up(){
    active=false; knob.style.left='38px'; knob.style.top='38px';
    joystick.active=false; joystick.dx=0; joystick.dy=0;
  }
  joy.addEventListener('touchstart', down); joy.addEventListener('mousedown', down);
  joy.addEventListener('touchmove', move); joy.addEventListener('mousemove', move);
  joy.addEventListener('touchend', up); joy.addEventListener('mouseup', up); joy.addEventListener('mouseleave', up);
}

/* -------------------- Helper: spawn initial objects -------------------- */
function initBullets(){ initBullets = initBullets; } // placeholder to satisfy linter
function initBullets(){
  // already defined above; empty intentionally if used earlier
}

/* -------------------- Window resize -------------------- */
window.addEventListener('resize', ()=>{ if (camera && renderer){ camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); if (composer && composer.setSize) composer.setSize(innerWidth, innerHeight); } });

/* -------------------- Helper: simple collision & movement updates for bullets pool -------------------- */
function initBullets(){
  // reinitialize pool if not there
  if (BULLET_POOL.length === 0){
    const geom = new THREE.SphereGeometry(0.7,8,8);
    const mat = new THREE.MeshBasicMaterial({ color:0xffff66, emissive:0xffff66 });
    for (let i=0;i<80;i++){ const m = new THREE.Mesh(geom, mat); m.visible=false; m.userData={vel:new THREE.Vector3(),life:0}; scene.add(m); BULLET_POOL.push(m); }
  }
}

/* Because initBullets defined twice guard earlier, ensure pool exists on start */
function ensurePools(){ if (BULLET_POOL.length===0) initBullets(); }

/* -------------------- start of game flow helpers -------------------- */
function startGameInit(){
  initThree(); addLights(); makeStarfield(); createShip(); spawnPlanets(); ensurePools();
  // ship base properties
  ship.userData = { speedBoost: 0 };
  // more initial enemies
  spawnEnemyWave();
}

/* call when pressing start */
function startGame(){ startGameInit(); document.getElementById('menu').style.display='none'; animate(); showFakeDialog("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, —Ä–µ–π–¥–µ—Ä. –ù–∞–∂–º–∏ üõ¨ —á—Ç–æ–±—ã –ø—Ä–∏–∑–µ–º–ª–∏—Ç—å—Å—è."); }

/* -------------------- Tiny safety for message dots animation -------------------- */
setInterval(()=>{ const el = document.getElementById('dots'); if (el) el.style.opacity = (Math.random()*0.5 + 0.5); }, 900);

/* Initialize bullet pool now to avoid race */
document.addEventListener('DOMContentLoaded', ()=>{ ensurePools(); });

</script>
</body>
</html>
